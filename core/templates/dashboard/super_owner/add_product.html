{% extends 'base.html' %}
{% load static %}
{% load color_filters %}

{% block title %}إضافة منتج جديد{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-gradient-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-plus-circle me-2"></i>
                            إضافة منتج جديد
                        </h4>
                        <a href="{% url 'super_owner_products' %}" class="btn btn-light btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>
                            العودة للمنتجات
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <ul class="nav nav-pills mb-3 wizard-steps">
                        <li class="nav-item"><a class="nav-link {% if step == 'info' %}active{% endif %}" href="{% url 'super_owner_add_product' %}?step=info">1. معلومات أساسية</a></li>
                        <li class="nav-item"><a class="nav-link {% if step == 'attributes' %}active{% endif %}{% if not product %} disabled{% endif %}" href="{% if product %}{% url 'super_owner_add_product' %}?pid={{ product.id }}&step=attributes{% else %}#{% endif %}">2. الألوان والمقاسات</a></li>
                        <li class="nav-item"><a class="nav-link {% if step == 'variants' %}active{% endif %}{% if not product %} disabled{% endif %}" href="{% if product %}{% url 'super_owner_add_product' %}?pid={{ product.id }}&step=variants{% else %}#{% endif %}">3. المتغيرات</a></li>
                        <li class="nav-item"><a class="nav-link {% if step == 'images' %}active{% endif %}{% if not product %} disabled{% endif %}" href="{% if product %}{% url 'super_owner_add_product' %}?pid={{ product.id }}&step=images{% else %}#{% endif %}">4. الصور</a></li>
                    </ul>

                    {% if step == 'info' %}
                    <form method="post" enctype="multipart/form-data" id="productInfoForm">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="create_product">
                        <div class="row">
                            <div class="col-md-6">
                                {{ product_form.non_field_errors }}
                                <input type="hidden" name="description" value="—">
                                <div class="mb-3">{{ product_form.name.label_tag }}{{ product_form.name }}</div>
                                <div class="mb-3">{{ product_form.category.label_tag }}{{ product_form.category }}</div>
                                <div class="mb-3">{{ product_form.base_price.label_tag }}{{ product_form.base_price }}</div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-end h-100">
                                    <button type="submit" class="btn btn-success"><i class="fas fa-arrow-left me-2"></i>التالي: الألوان والمقاسات</button>
                                    <a href="{% url 'super_owner_products' %}" class="btn btn-secondary"><i class="fas fa-times me-2"></i>إلغاء</a>
                                </div>
                            </div>
                        </div>
                    </form>
                    {% endif %}

                    {% if product and step == 'attributes' %}
                    <form method="post" enctype="multipart/form-data" class="mb-4" id="attributesForm">
                        {% csrf_token %}
                        {{ product_form.non_field_errors }}
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="mb-3">{{ product_form.name.label_tag }}{{ product_form.name }}</div>
                                <div class="mb-3">{{ product_form.description.label_tag }}{{ product_form.description }}</div>
                                <div class="mb-3">{{ product_form.alert_note.label_tag }}{{ product_form.alert_note }}</div>
                                <div class="mb-3 form-check">{{ product_form.show_store_rating }} <label class="form-check-label" for="{{ product_form.show_store_rating.id_for_label }}">إظهار تقييم المتجر في صفحة المنتج</label></div>
                                <div class="mb-3">{{ product_form.size_type.label_tag }}{{ product_form.size_type }}</div>
                                <div class="mb-3">{{ product_form.fit_type.label_tag }}{{ product_form.fit_type }}</div>
                                <div class="mb-3">{{ product_form.discount_price.label_tag }}{{ product_form.discount_price }}</div>
                                <div class="mb-3 form-check">{{ product_form.is_active }} {{ product_form.is_active.label_tag }}</div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info">
                                    بعد اختيار الألوان والمقاسات، سيتم إنشاء جدول متغيرات نظيف في الخطوة التالية فقط لهذه الاختيارات.
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="section-block">
                        <div class="section-title">ألوان المنتج</div>
                        <div class="mb-3 d-flex align-items-center gap-2 color-add-row">
                            <form method="post" class="d-flex align-items-center gap-2" data-ajax="true">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="add_global_color">
                                <input type="hidden" name="pid" value="{{ product.id }}">
                                <input type="text" name="color_name" class="form-control" placeholder="اسم اللون" style="max-width:220px;">
                                <input type="color" name="color_code" class="form-control form-control-color" value="#000000" title="اختر الكود اللوني">
                                <button class="btn btn-primary">إضافة لون</button>
                            </form>
                        </div>

                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="save_attributes">
                            <input type="hidden" name="pid" value="{{ product.id }}">
                            <div class="color-chips">
                                {% for c in colors %}
                                <label class="color-chip">
                                    <input class="form-check-input chip-select" type="checkbox" name="color_ids" value="{{ c.id }}" {% if c.id in existing_color_ids %}checked{% endif %}>
                                    <span class="color-preview" style="background-color: {{ c|color_code }};"></span>
                                    <span class="chip-name">{{ c.name }}</span>
                                    <span class="chip-actions">
                                        <button type="submit" class="btn btn-outline-danger btn-sm" form="deleteColorForm-{{ c.id }}" onclick="return confirm('حذف اللون؟')"><i class="fas fa-trash"></i></button>
                                    </span>
                                </label>
                                {% empty %}
                                <span class="text-muted">لا توجد ألوان متاحة حالياً</span>
                                {% endfor %}
                            </div>

                            <div class="section-title mt-4">المقاسات</div>
                            <div class="sizes-grid">
                                {% for s in sizes %}
                                <label class="size-option">
                                    <input class="form-check-input" type="checkbox" name="size_ids" value="{{ s.id }}" {% if s.id in existing_size_ids %}checked{% endif %}>
                                    <span class="size-label">{{ s.name }}</span>
                                    <button type="submit" class="btn btn-outline-danger btn-sm ms-auto" form="deleteSizeForm-{{ s.id }}" onclick="return confirm('حذف القياس؟')"><i class="fas fa-trash"></i></button>
                                </label>
                                {% empty %}
                                <span class="text-muted">لا توجد مقاسات لهذا المنتج</span>
                                {% endfor %}
                            </div>

                            

                            <div class="actions-row">
                                <button class="btn btn-success"><i class="fas fa-save me-2"></i>حفظ الخصائص والانتقال للمتغيرات</button>
                                <a href="{% url 'super_owner_add_product' %}?pid={{ product.id }}&step=info" class="btn btn-outline-secondary">رجوع لمعلومات المنتج</a>
                            </div>
                        </form>
                        <div class="mt-3 d-flex align-items-center gap-2">
                            <form method="post" class="d-flex align-items-center gap-2" data-ajax="true">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="add_attribute_size">
                                <input type="hidden" name="pid" value="{{ product.id }}">
                                <input type="text" name="size_name" class="form-control" placeholder="إضافة قياس" style="max-width:220px;">
                                <button class="btn btn-outline-primary">إضافة قياس</button>
                            </form>
                        </div>
                        <!-- نماذج الحذف خارج نموذج الحفظ لمنع التداخل -->
                        <div style="display:none">
                            {% for c in colors %}
                            <form id="deleteColorForm-{{ c.id }}" method="post" data-ajax="true">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="delete_attribute_color">
                                <input type="hidden" name="pid" value="{{ product.id }}">
                                <input type="hidden" name="color_id" value="{{ c.id }}">
                            </form>
                            {% endfor %}
                            {% for s in sizes %}
                            <form id="deleteSizeForm-{{ s.id }}" method="post" data-ajax="true">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="delete_attribute_size">
                                <input type="hidden" name="pid" value="{{ product.id }}">
                                <input type="hidden" name="size_id" value="{{ s.id }}">
                            </form>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    

                    

                    {% if product and step == 'variants' %}
                    <form method="post" class="mb-4" id="variantsForm">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="bulk_update_variants">
                        <input type="hidden" name="pid" value="{{ product.id }}">
                        <input type="hidden" name="goto" id="variantsGoto" value="">
                        <div id="variant-container" class="table-responsive admin-table-wrap"></div>
                        <div class="d-flex justify-content-between mt-3">
                            <a href="{% url 'super_owner_add_product' %}?pid={{ product.id }}&step=attributes" class="btn btn-outline-secondary">رجوع للخصائص</a>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-success"><i class="fas fa-save me-2"></i>حفظ المتغيرات</button>
                                <a href="{% url 'super_owner_add_product' %}?pid={{ product.id }}&step=images" class="btn btn-primary" id="goImagesBtn"><i class="fas fa-arrow-left me-2"></i>التالي: الصور</a>
                            </div>
                        </div>
                    </form>
                    {% endif %}

                    {% if product and step == 'images' %}
                    <form method="post" enctype="multipart/form-data" class="mb-4">
                        {% csrf_token %}
                        {{ product_form.non_field_errors }}
                        <div class="row g-3">
                            <div class="col-md-12">
                                {{ image_formset.management_form }}
                                <div class="table-responsive admin-table-wrap">
                                    <table class="table admin-table">
                                        <thead>
                                            <tr>
                                                <th>صورة</th>
                                                <th>رابط الصورة</th>
                                                <th>فيديو</th>
                                                <th>رابط الفيديو</th>
                                                <th>لون</th>
                                                <th>متغير</th>
                                                <th>رئيسية</th>
                                                <th>ترتيب</th>
                                                <th>حذف</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for iform in image_formset %}
                                            <tr>
                                                <td data-label="صورة">{{ iform.image }}</td>
                                                <td data-label="رابط الصورة">{{ iform.image_url }}</td>
                                                <td data-label="فيديو">{{ iform.video_file }}</td>
                                                <td data-label="رابط الفيديو">{{ iform.video_url }}</td>
                                                <td data-label="لون">{{ iform.color_attr }}</td>
                                                <td data-label="متغير">{{ iform.variant }}</td>
                                                <td data-label="رئيسية" class="text-center">{{ iform.is_main }}</td>
                                                <td data-label="ترتيب">{{ iform.order }}</td>
                                                <td data-label="حذف" class="text-center">{% if iform.DELETE %}{{ iform.DELETE }}{% endif %}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success" name="finish" value="0"><i class="fas fa-save me-2"></i>حفظ</button>
                                    <button type="submit" class="btn btn-primary" name="finish" value="1"><i class="fas fa-check me-2"></i>إنهاء</button>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="mb-3">
                        <form method="post" enctype="multipart/form-data" data-ajax="true" class="d-inline-block">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="upload_images">
                            <input type="hidden" name="pid" value="{{ product.id }}">
                            <div class="input-group">
                                <input type="file" class="form-control" name="images" multiple accept="image/*">
                                <button class="btn btn-primary"><i class="fas fa-upload me-1"></i>رفع الصور</button>
                            </div>
                        </form>
                    </div>
                    <div class="row g-3">
                        {% for img in images %}
                        <div class="col-md-3">
                            <div class="card h-100">
                                <img src="{{ img.get_image_url }}" class="card-img-top" alt="" style="height:180px;object-fit:cover;" onerror="this.onerror=null;this.src='https://placehold.co/300x180?text=Image'">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="badge {% if img.is_main %}bg-success{% else %}bg-light text-dark{% endif %}">{% if img.is_main %}رئيسية{% else %}عادية{% endif %}</span>
                                        <small class="text-muted">ترتيب: {{ img.order }}</small>
                                    </div>
                                    <form method="post" class="d-inline" data-ajax="true">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="set_main_image">
                                        <input type="hidden" name="pid" value="{{ product.id }}">
                                        <input type="hidden" name="image_id" value="{{ img.id }}">
                                        <button class="btn btn-outline-success btn-sm">اجعلها رئيسية</button>
                                    </form>
                                    <form method="post" class="d-inline" data-ajax="true">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="reorder_image">
                                        <input type="hidden" name="pid" value="{{ product.id }}">
                                        <input type="hidden" name="image_id" value="{{ img.id }}">
                                        <input type="hidden" name="direction" value="up">
                                        <button class="btn btn-outline-secondary btn-sm">أعلى</button>
                                    </form>
                                    <form method="post" class="d-inline" data-ajax="true">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="reorder_image">
                                        <input type="hidden" name="pid" value="{{ product.id }}">
                                        <input type="hidden" name="image_id" value="{{ img.id }}">
                                        <input type="hidden" name="direction" value="down">
                                        <button class="btn btn-outline-secondary btn-sm">أسفل</button>
                                    </form>
                                    <div class="mt-2">
                                        <form method="post" class="d-flex" data-ajax="true">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="assign_image_color">
                                            <input type="hidden" name="pid" value="{{ product.id }}">
                                            <input type="hidden" name="image_id" value="{{ img.id }}">
                                            <select name="color_id" class="form-select form-select-sm me-2">
                                                <option value="">بدون لون</option>
                                                {% for c in color_attrs %}
                                                    <option value="{{ c.id }}" {% if img.color_attr and img.color_attr.id == c.id %}selected{% endif %}>{{ c.name }}{% if c.code %} ({{ c.code }}){% endif %}</option>
                                                {% endfor %}
                                            </select>
                                            <button class="btn btn-outline-primary btn-sm">ربط لون</button>
                                        </form>
                                        <form method="post" class="d-inline" data-ajax="true">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="extract_color_from_image">
                                            <input type="hidden" name="pid" value="{{ product.id }}">
                                            <input type="hidden" name="image_id" value="{{ img.id }}">
                                            <button class="btn btn-outline-info btn-sm"><i class="fas fa-eye-dropper me-1"></i>استخراج لون تلقائي</button>
                                        </form>
                                    </div>
                                    <form method="post" class="mt-2" data-ajax="true" onsubmit="return confirm('حذف هذه الصورة؟')">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="remove_image">
                                        <input type="hidden" name="pid" value="{{ product.id }}">
                                        <input type="hidden" name="image_id" value="{{ img.id }}">
                                        <button class="btn btn-danger btn-sm"><i class="fas fa-trash me-1"></i>حذف</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12"><p class="text-muted">لا توجد صور حالياً.</p></div>
                        {% endfor %}
                    </div>
                    <div class="mt-4">
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="finish">
                            <input type="hidden" name="pid" value="{{ product.id }}">
                            <button type="submit" class="btn btn-success"><i class="fas fa-check me-2"></i>إنهاء إضافة المنتج</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.bg-gradient-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.form-control:focus, .form-select:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

.btn-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
    padding: 10px 30px;
}

.btn-success:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
}

.alert-info { border: none; background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; }
.ajax-error-toast { position: fixed; bottom: 20px; left: 20px; z-index: 1055; }

.section-block { margin-bottom: 1.25rem; }
.section-title { font-size: 1rem; font-weight: 600; margin-bottom: .5rem; }

.color-add-row .form-control { max-width: 240px; }
.color-add-row .form-control-color { width: 42px; height: 42px; padding: 0; }

.color-chips { display: grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: .75rem; }
.color-chip { display: flex; align-items: center; gap: .6rem; border: 1px solid #e0e0e0; border-radius: .5rem; padding: .5rem .6rem; position: relative; background: #fff; cursor: pointer; }
.color-preview { width: 24px; height: 24px; border-radius: .25rem; border: 1px solid #ddd; }
.chip-content { display: flex; align-items: center; justify-content: space-between; flex: 1; }
.chip-name { font-size: .95rem; font-weight: 500; color: #212529; }
.chip-actions { display: flex; align-items: center; gap: .5rem; }
.chip-select { position: absolute; top: .4rem; left: .4rem; }

.sizes-grid { display: grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: .5rem; }
.size-option { display: flex; align-items: center; gap: .5rem; border: 1px solid #e0e0e0; border-radius: .5rem; padding: .4rem .6rem; background: #fff; }
.size-label { font-size: .95rem; color: #212529; }

.actions-row { display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; }
</style>
<script>
(function(){
  var pid = {{ product.id|default:'0' }};
  function createAddProductJS_{{ product.id|default:'0' }}(){
    function getCookie_{{ product.id|default:'0' }}(name){
      var v=document.cookie.match('(^|; )'+name+'=([^;]*)');
      return v?decodeURIComponent(v[2]):'';
    }
    document.querySelectorAll('form[data-ajax="true"]').forEach(function(form){
        form.addEventListener('submit', function(e){
            const isAssign_{{ product.id|default:'0' }} = !!form.querySelector('input[name="action"][value="assign_image_color"]');
            const isExtract_{{ product.id|default:'0' }} = !!form.querySelector('input[name="action"][value="extract_color_from_image"]');
            if (isAssign_{{ product.id|default:'0' }} || isExtract_{{ product.id|default:'0' }}) { return; }
            e.preventDefault();
            const formData_{{ product.id|default:'0' }} = new FormData(form);
            const url_{{ product.id|default:'0' }} = form.getAttribute('action') || window.location.href;
            const method_{{ product.id|default:'0' }} = form.getAttribute('method') || (form.method || 'POST');
            fetch(url_{{ product.id|default:'0' }}, { method: method_{{ product.id|default:'0' }}, body: formData_{{ product.id|default:'0' }}, credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCookie_{{ product.id|default:'0' }}('csrftoken') } })
            .then(function(resp){
                if (resp.ok || (resp.status >= 300 && resp.status < 400)) { window.location.reload(); return; }
                return resp.text().then(function(text){
                    const alert_{{ product.id|default:'0' }} = document.createElement('div');
                    alert_{{ product.id|default:'0' }}.className = 'alert alert-danger ajax-error-toast';
                    alert_{{ product.id|default:'0' }}.innerHTML = 'فشل الحفظ (' + resp.status + '): ' + (text || 'خطأ غير معروف');
                    document.body.appendChild(alert_{{ product.id|default:'0' }});
                    setTimeout(function(){ alert_{{ product.id|default:'0' }}.remove(); }, 6000);
                });
            }).catch(function(err){
                const alert_{{ product.id|default:'0' }} = document.createElement('div');
                alert_{{ product.id|default:'0' }}.className = 'alert alert-danger ajax-error-toast';
                alert_{{ product.id|default:'0' }}.textContent = 'تعذر الإرسال: ' + err;
                document.body.appendChild(alert_{{ product.id|default:'0' }});
                setTimeout(function(){ alert_{{ product.id|default:'0' }}.remove(); }, 6000);
            });
        });
    });

    // احفظ المتغيرات تلقائياً قبل الانتقال إلى خطوة الصور
    try {
      var goBtn = document.getElementById('goImagesBtn');
      var vForm = document.getElementById('variantsForm');
      var gotoField = document.getElementById('variantsGoto');
      if (goBtn && vForm && gotoField) {
        goBtn.addEventListener('click', function(e){
          e.preventDefault();
          gotoField.value = 'images';
          vForm.submit();
        });
      }
    } catch (e) {}

    document.querySelectorAll('form').forEach(function(form){
        const isAssign_{{ product.id|default:'0' }} = !!form.querySelector('input[name="action"][value="assign_image_color"]');
        if (isAssign_{{ product.id|default:'0' }}) {
            form.addEventListener('submit', function(e){
                e.preventDefault();
                e.stopImmediatePropagation();
                const fd_{{ product.id|default:'0' }} = new FormData(form);
                const url_{{ product.id|default:'0' }} = form.getAttribute('action') || window.location.href;
                const imageId_{{ product.id|default:'0' }} = (form.querySelector('input[name="image_id"]') || {}).value || '';
                const colorId_{{ product.id|default:'0' }} = (form.querySelector('select[name="color_id"]') || {}).value || '';
                fetch(url_{{ product.id|default:'0' }}, { method: 'POST', body: fd_{{ product.id|default:'0' }}, credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCookie_{{ product.id|default:'0' }}('csrftoken') } })
                .then(function(resp){ window.location.reload(); })
                .catch(function(){ alert('فشل ربط اللون بالصورة'); });
            });
            const sel_{{ product.id|default:'0' }} = form.querySelector('select[name="color_id"]');
            if (sel_{{ product.id|default:'0' }}) {
                const BIND_URL_{{ product.id|default:'0' }} = '{% url "bind_image_to_color" %}';
                function bindColor_{{ product.id|default:'0' }}(imageId, colorId){
                  try{
                    fetch(BIND_URL_{{ product.id|default:'0' }}, {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie_{{ product.id|default:'0' }}('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                      },
                      body: JSON.stringify({ image_id: imageId, color_id: colorId })
                    }).then(function(resp){ return resp.json(); })
                      .then(function(data){ if(!data.ok){ throw new Error(data.error||'bind_failed'); } location.reload(); })
                      .catch(function(){ alert('فشل ربط اللون بالصورة'); });
                  }catch(e){ alert('فشل ربط اللون بالصورة'); }
                }
                sel_{{ product.id|default:'0' }}.addEventListener('change', function(){
                    const imageId_{{ product.id|default:'0' }} = (form.querySelector('input[name="image_id"]')||{}).value||'';
                    const colorId_{{ product.id|default:'0' }} = sel_{{ product.id|default:'0' }}.value||'';
                    if(!imageId_{{ product.id|default:'0' }}){ alert('صورة غير معروفة'); return; }
                    bindColor_{{ product.id|default:'0' }}(imageId_{{ product.id|default:'0' }}, colorId_{{ product.id|default:'0' }});
                });
            }
        }
        const isExtract_{{ product.id|default:'0' }} = !!form.querySelector('input[name="action"][value="extract_color_from_image"]');
        if (isExtract_{{ product.id|default:'0' }}) {
            form.addEventListener('submit', function(e){
                e.preventDefault();
                e.stopImmediatePropagation();
                const fd_{{ product.id|default:'0' }} = new FormData(form);
                const url_{{ product.id|default:'0' }} = form.getAttribute('action') || window.location.href;
                fetch(url_{{ product.id|default:'0' }}, { method: 'POST', body: fd_{{ product.id|default:'0' }}, credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCookie_{{ product.id|default:'0' }}('csrftoken') } })
                .then(function(){ window.location.reload(); });
            });
        }
    });

    document.querySelectorAll('.color-chip').forEach(function(chip){
        chip.addEventListener('click', function(e){
            if (e.target.closest('.chip-actions')) { return; }
            const cb_{{ product.id|default:'0' }} = chip.querySelector('input[name="color_ids"]');
            if (cb_{{ product.id|default:'0' }}) { cb_{{ product.id|default:'0' }}.checked = !cb_{{ product.id|default:'0' }}.checked; }
        });
    });

    const colorRow_{{ product.id|default:'0' }} = document.querySelector('.color-add-row');
    if (colorRow_{{ product.id|default:'0' }}) {
        const picker_{{ product.id|default:'0' }} = colorRow_{{ product.id|default:'0' }}.querySelector('input[name="color_code"]');
        const nameInput_{{ product.id|default:'0' }} = colorRow_{{ product.id|default:'0' }}.querySelector('input[name="color_name"]');
        function hexToRgb_{{ product.id|default:'0' }}(h){ return [parseInt(h.slice(1,3),16), parseInt(h.slice(3,5),16), parseInt(h.slice(5,7),16)]; }
        const palette_{{ product.id|default:'0' }} = [
            ['أسود','#000000'],['أبيض','#FFFFFF'],['أحمر','#FF0000'],['أخضر','#008000'],['أزرق','#0000FF'],
            ['أصفر','#FFFF00'],['برتقاني','#FFA500'],['بنفسجي','#800080'],['نيلي','#4B0082'],['تركوازي','#40E0D0'],
            ['كحلي','#000080'],['رمادي','#808080'],['زهري','#FFC0CB'],['بنّي','#8B4513'],['سماوي','#87CEEB']
        ].map(function(x){ return {name:x[0], rgb:hexToRgb_{{ product.id|default:'0' }}(x[1])}; });
        function nearestName_{{ product.id|default:'0' }}(hex){ var t=hexToRgb_{{ product.id|default:'0' }}(hex); var best=null,bd=1e9; for(var i=0;i<palette_{{ product.id|default:'0' }}.length;i++){ var p=palette_{{ product.id|default:'0' }}[i]; var d=(t[0]-p.rgb[0])*(t[0]-p.rgb[0])+(t[1]-p.rgb[1])*(t[1]-p.rgb[1])+(t[2]-p.rgb[2])*(t[2]-p.rgb[2]); if(d<bd){ bd=d; best=p.name; } } return best; }
        var lastAutoName_{{ product.id|default:'0' }}='';
        function syncName_{{ product.id|default:'0' }}(){ if (!picker_{{ product.id|default:'0' }} || !nameInput_{{ product.id|default:'0' }}) return; var hex=String(picker_{{ product.id|default:'0' }}.value||'').toUpperCase(); var next=nearestName_{{ product.id|default:'0' }}(hex); if (!nameInput_{{ product.id|default:'0' }}.value || nameInput_{{ product.id|default:'0' }}.value===lastAutoName_{{ product.id|default:'0' }}){ nameInput_{{ product.id|default:'0' }}.value=next; lastAutoName_{{ product.id|default:'0' }}=next; } }
        if (nameInput_{{ product.id|default:'0' }}){ nameInput_{{ product.id|default:'0' }}.addEventListener('input', function(){ if (nameInput_{{ product.id|default:'0' }}.value!==lastAutoName_{{ product.id|default:'0' }}){ lastAutoName_{{ product.id|default:'0' }}=''; } }); }
        if (picker_{{ product.id|default:'0' }}){ picker_{{ product.id|default:'0' }}.addEventListener('input', syncName_{{ product.id|default:'0' }}); picker_{{ product.id|default:'0' }}.addEventListener('change', syncName_{{ product.id|default:'0' }}); }
    }

    const sizeType_{{ product.id|default:'0' }} = document.getElementById('size_type');
    const grids_{{ product.id|default:'0' }} = [
        document.getElementById('createSizesGrid'),
        document.getElementById('attrSizesGrid')
    ].filter(Boolean);
    function applySizeFilter_{{ product.id|default:'0' }}(){
        if (!sizeType_{{ product.id|default:'0' }} || grids_{{ product.id|default:'0' }}.length === 0) return;
        const t_{{ product.id|default:'0' }} = sizeType_{{ product.id|default:'0' }}.value;
        grids_{{ product.id|default:'0' }}.forEach(function(grid){
            grid.querySelectorAll('.size-option').forEach(function(el){
                const name_{{ product.id|default:'0' }} = String(el.dataset.name || el.querySelector('.size-label')?.textContent || '');
                const isNum_{{ product.id|default:'0' }} = /^\d+$/.test(name_{{ product.id|default:'0' }});
                if (t_{{ product.id|default:'0' }} === 'numeric') {
                    el.style.display = isNum_{{ product.id|default:'0' }} ? '' : 'none';
                } else if (t_{{ product.id|default:'0' }} === 'symbolic') {
                    el.style.display = isNum_{{ product.id|default:'0' }} ? 'none' : '';
                } else {
                    el.style.display = 'none';
                }
            });
        });
    }
    applySizeFilter_{{ product.id|default:'0' }}();
    if (sizeType_{{ product.id|default:'0' }}) {
        sizeType_{{ product.id|default:'0' }}.addEventListener('change', applySizeFilter_{{ product.id|default:'0' }});
    }

    try{
        var stepVal_{{ product.id|default:'0' }} = '{{ step }}';
        var hasPid_{{ product.id|default:'0' }} = !!document.querySelector('input[name="pid"]');
        if (stepVal_{{ product.id|default:'0' }} === 'info' && !hasPid_{{ product.id|default:'0' }}){
            try{ localStorage.clear(); }catch(e){}
            var f_{{ product.id|default:'0' }} = document.getElementById('productInfoForm');
            if (f_{{ product.id|default:'0' }} && f_{{ product.id|default:'0' }}.reset){ f_{{ product.id|default:'0' }}.reset(); }
            var n_{{ product.id|default:'0' }} = document.querySelector('input[name="name"]'); if(n_{{ product.id|default:'0' }}){ n_{{ product.id|default:'0' }}.value=''; }
            var bp_{{ product.id|default:'0' }} = document.querySelector('input[name="base_price"]'); if(bp_{{ product.id|default:'0' }}){ bp_{{ product.id|default:'0' }}.value=''; }
            var cat_{{ product.id|default:'0' }} = document.querySelector('select[name="category"]'); if(cat_{{ product.id|default:'0' }}){ cat_{{ product.id|default:'0' }}.selectedIndex = 0; }
        }
        if (stepVal_{{ product.id|default:'0' }} === 'attributes'){
            var colorBoxes = Array.prototype.slice.call(document.querySelectorAll('input[name="color_ids"]'));
            var sizeBoxes = Array.prototype.slice.call(document.querySelectorAll('input[name="size_ids"]'));
            function storeSelections(){
                try{
                    var cs = colorBoxes.filter(function(cb){return cb.checked;}).map(function(cb){return cb.value;});
                    var ss = sizeBoxes.filter(function(sb){return sb.checked;}).map(function(sb){return sb.value;});
                    localStorage.setItem('ap_selected_colors_'+pid, JSON.stringify(cs));
                    localStorage.setItem('ap_selected_sizes_'+pid, JSON.stringify(ss));
                }catch(e){}
            }
            colorBoxes.forEach(function(cb){ cb.addEventListener('change', storeSelections); });
            sizeBoxes.forEach(function(sb){ sb.addEventListener('change', storeSelections); });
            storeSelections();
        }
        if (stepVal_{{ product.id|default:'0' }} === 'variants'){
            var container = document.getElementById('variant-container');
            if (container){ container.innerHTML = ''; }
            var onceKey = 'ap_variants_rendered_'+pid;
            if (window[onceKey]){ return; }
            var variantsData = [];
            {% for v in variants %}
            variantsData.push({
                id: {{ v.id }},
                color_id: {{ v.color_attr_id|default:'null' }},
                color_name: "{{ v.color_attr.name|default:'-' }}",
                size_id: {{ v.size_attr_id|default:'null' }},
                size_name: "{% if v.size_attr %}{{ v.size_attr.name }}{% else %}{{ v.size }}{% endif %}",
                qty: {{ v.stock_qty|default:0 }},
                price: "{{ v.price_override|default_if_none:'' }}",
                enabled: {% if v.is_enabled %}true{% else %}false{% endif %}
            });
            {% endfor %}
            var selColors = []; var selSizes = [];
            try{ selColors = JSON.parse(localStorage.getItem('ap_selected_colors_'+pid)||'[]'); }catch(e){ selColors = []; }
            try{ selSizes = JSON.parse(localStorage.getItem('ap_selected_sizes_'+pid)||'[]'); }catch(e){ selSizes = []; }
            if (!selColors || selColors.length === 0){ return; }
            var filtered = variantsData.filter(function(it){
                var cOk = selColors.length===0 ? true : (it.color_id!==null && selColors.indexOf(String(it.color_id))>=0);
                var sOk = selSizes.length===0 ? true : (it.size_id!==null && selSizes.indexOf(String(it.size_id))>=0);
                return cOk && sOk;
            });
            if (filtered.length===0){ return; }
            var html = '';
            html += '<table class="table table-bordered align-middle admin-table"><thead><tr><th>اللون</th><th>المقاس</th><th>الكمية</th><th>السعر الخاص</th><th>مفعل</th></tr></thead><tbody>';
            filtered.forEach(function(it){
                html += '<tr>'+
                    '<td data-label="اللون">'+ (it.color_name||'-') +'</td>'+
                    '<td data-label="المقاس">'+ (it.size_name||'-') +'</td>'+
                    '<td data-label="الكمية"><input type="number" class="form-control" name="v_'+it.id+'_qty" value="'+String(it.qty)+'" min="0"></td>'+
                    '<td data-label="السعر الخاص"><input type="number" step="0.01" class="form-control" name="v_'+it.id+'_price" value="'+String(it.price)+'"></td>'+
                    '<td data-label="مفعل" class="text-center"><input type="checkbox" name="v_'+it.id+'_enabled" '+(it.enabled?'checked':'')+'></td>'+
                '</tr>';
            });
            html += '</tbody></table>';
            if (container){ container.innerHTML = html; }
            window[onceKey] = true;
        }
    }catch(e){}
  }
  document.addEventListener('DOMContentLoaded', createAddProductJS_{{ product.id|default:'0' }});
})();
</script>
{% endblock %}
