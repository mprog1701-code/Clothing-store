{% extends 'base.html' %}
{% block title %}Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØ¬Ø± Ø¬Ø¯ÙŠØ¯{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-primary">Ø§Ù„Ø®Ø·ÙˆØ© {{ step }}</span>
          <span>Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØ¬Ø± Ø¬Ø¯ÙŠØ¯</span>
        </div>
        <a href="{% url 'super_owner_stores' %}" class="btn btn-outline-secondary">Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ§Ø¬Ø±</a>
      </div>
      <div class="progress" style="height: 8px;">
        <div class="progress-bar bg-success" role="progressbar" style="width: {% if step == '1' %}33{% elif step == '2' %}66{% else %}100{% endif %}%" aria-valuenow="{% if step == '1' %}33{% elif step == '2' %}66{% else %}100{% endif %}" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
    </div>
  </div>

  {% if errors.general %}
    <div class="alert alert-danger">{{ errors.general }}</div>
  {% endif %}

  {% if step == '1' %}
    <form method="post" class="card">
      {% csrf_token %}
      <input type="hidden" name="step" value="1">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Ø§Ù„Ù…Ø§Ù„Ùƒ</span>
        <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#createOwnerModal">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø§Ù„Ùƒ Ø¬Ø¯ÙŠØ¯</button>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ù„Ùƒ</label>
          <input type="text" class="form-control mb-2" id="owner_search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ù‡Ø§ØªÙ">
          <select class="form-select" name="owner_id" id="owner_list">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ</option>
            {% for o in owners %}
              <option value="{{ o.id }}">{% if o.get_full_name %}{{ o.get_full_name }}{% elif o.phone %}{{ o.phone }}{% else %}Ù…Ø§Ù„Ùƒ #{{ o.id }}{% endif %}{% if o.phone and o.get_full_name %} - {{ o.phone }}{% endif %}</option>
            {% endfor %}
          </select>
          {% if errors.owner_id %}<div class="text-danger small mt-1">{{ errors.owner_id }}</div>{% endif %}
        </div>
      </div>
      <div class="card-footer d-flex justify-content-between">
        <span></span>
        <button class="btn btn-primary" name="action" value="next">Ø§Ù„ØªØ§Ù„ÙŠ</button>
      </div>
    </form>
    <div class="modal fade" id="createOwnerModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø§Ù„Ùƒ Ø¬Ø¯ÙŠØ¯</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="mb-3"><label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label><input type="text" class="form-control" id="new_owner_full_name"></div>
            <div class="mb-3"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label><input type="tel" class="form-control" id="new_owner_phone" placeholder="07xxxxxxxxx"></div>
            <div class="mb-3"><label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input type="email" class="form-control" id="new_owner_email"></div>
            <div id="new_owner_error" class="text-danger small"></div>
          </div>
          <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button><button class="btn btn-success" id="submitCreateOwner">Ø¥Ù†Ø´Ø§Ø¡</button></div>
        </div>
      </div>
    </div>
  {% elif step == '2' %}
    <form method="post" class="card">
      {% csrf_token %}
      <input type="hidden" name="step" value="2">
      <div class="card-header">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
      <div class="card-body row g-3">
        <div class="col-md-6">
          <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø± *</label>
          <input type="text" class="form-control" name="name" value="{{ wizard.name|default:'' }}" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±">
          {% if errors.name %}<div class="text-danger small mt-1">{{ errors.name }}</div>{% endif %}
        </div>
        <div class="col-md-6">
          <label class="form-label">Ø§Ù„Ù‚Ø§Ù„Ø¨/Ø§Ù„ÙØ¦Ø©</label>
          <select class="form-select" name="category">
            <option value="">Ø¨Ø¯ÙˆÙ†</option>
            {% for v,l in categories %}<option value="{{ v }}" {% if wizard.category == v %}selected{% endif %}>{{ l }}</option>{% endfor %}
          </select>
          {% if errors.category %}<div class="text-danger small mt-1">{{ errors.category }}</div>{% endif %}
        </div>
        <div class="col-md-6">
          <label class="form-label">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© *</label>
          <select class="form-select" name="city">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
            {% for c in cities %}
              <option value="{{ c }}" {% if wizard.city == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
          {% if errors.city %}<div class="text-danger small mt-1">{{ errors.city }}</div>{% endif %}
        </div>
        <div class="col-md-6">
          <label class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¬Ø±</label>
          <select class="form-select" name="status">
            <option value="ACTIVE" {% if wizard.status == 'ACTIVE' %}selected{% endif %}>Ù†Ø´Ø·</option>
            <option value="DISABLED" {% if wizard.status == 'DISABLED' %}selected{% endif %}>ØºÙŠØ± Ù†Ø´Ø·</option>
          </select>
          <div class="form-text">Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ù†Ø´Ø·" ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…ØªØ¬Ø± ÙˆÙŠÙ‚Ø¨Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§ØªØ› "ØºÙŠØ± Ù†Ø´Ø·" ÙŠØ®ÙÙŠÙ‡ ÙˆÙ„Ø§ ÙŠÙ‚Ø¨Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.</div>
        </div>
        <div class="col-12">
          <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† *</label>
          <div class="input-group">
            <input type="text" class="form-control" id="addressInput" name="address" value="{{ wizard.address|default:'' }}" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø§Ø±Ø¹ØŒ Ù…Ù†Ø·Ù‚Ø©ØŒ ØªÙØ§ØµÙŠÙ„">
            <button type="button" class="btn btn-outline-secondary" id="openMap">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
          </div>
          {% if errors.address %}<div class="text-danger small mt-1">{{ errors.address }}</div>{% endif %}
          <div class="small text-muted mt-2" id="addrPreview"></div>
          <input type="hidden" name="latitude" id="latitude" value="{{ wizard.latitude|default:'' }}">
          <input type="hidden" name="longitude" id="longitude" value="{{ wizard.longitude|default:'' }}">
          <input type="hidden" name="formatted_address" id="formatted_address" value="{{ wizard.formatted_address|default:'' }}">
        </div>
        <div class="col-md-6">
          <label class="form-label">Ø§Ø³Ù… Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…ØªØ¬Ø± (Ù„Ù„ØªÙˆØ§ØµÙ„)</label>
          <input type="text" class="form-control" name="owner_contact_name" value="{{ wizard.owner_contact_name|default:'' }}" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÙŠ Ø­Ø³Ù†">
        </div>
        <div class="col-md-6">
          <label class="form-label">Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…ØªØ¬Ø± (Ù„Ù„ØªÙˆØ§ØµÙ„)</label>
          <input type="tel" class="form-control" name="owner_contact_phone" value="{{ wizard.owner_contact_phone|default:'' }}" placeholder="07xxxxxxxxx" pattern="07[0-9]{9}">
          {% if errors.owner_contact_phone %}<div class="text-danger small mt-1">{{ errors.owner_contact_phone }}</div>{% endif %}
          <div class="form-text">Ø¥Ù† Ù„Ù… ØªØ­Ø¯Ø¯ Ù…Ø§Ù„ÙƒÙ‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¯Ø¹ÙˆØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ØªØ¬Ø±.</div>
        </div>
      </div>
      <div class="card-footer d-flex justify-content-between">
        <a class="btn btn-secondary" href="{% url 'super_owner_create_store' %}?step=1">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
        <button class="btn btn-primary" name="action" value="next">Ø§Ù„ØªØ§Ù„ÙŠ</button>
      </div>
    </form>
    <div class="modal fade" id="mapModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2 d-flex gap-2">
              <input id="searchInput" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù†">
              <button id="searchBtn" class="btn btn-outline-secondary" type="button">Ø¨Ø­Ø«</button>
            </div>
            <div id="list" class="list-group mb-2"></div>
            <div id="map" style="height:420px"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelMap">Ø¥Ù„ØºØ§Ø¡</button>
            <button type="button" class="btn btn-primary" id="confirmLocation" data-bs-dismiss="modal">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
          </div>
        </div>
      </div>
    </div>
  {% elif step == '3' %}
    <form method="post" enctype="multipart/form-data" class="card">
      {% csrf_token %}
      <input type="hidden" name="step" value="3">
      <div class="card-header">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„</div>
      <div class="card-body row g-3">
        <div class="col-md-4">
          <label class="form-label">Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø¯ÙŠÙ†Ø§Ø±) *</label>
          <div class="input-group">
            <input type="number" step="0.01" class="form-control" name="delivery_fee" value="{{ wizard.delivery_fee|default:'' }}">
            <span class="input-group-text">IQD</span>
          </div>
          {% if errors.delivery_fee %}<div class="text-danger small mt-1">{{ errors.delivery_fee }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label class="form-label">Ø­Ø¯ Ù…Ø¬Ø§Ù†ÙŠ Ù„Ù„ØªÙˆØµÙŠÙ„ (Ø¯ÙŠÙ†Ø§Ø±)</label>
          <div class="input-group">
            <input type="number" step="0.01" class="form-control" name="free_delivery_threshold" value="{{ wizard.free_delivery_threshold|default:'' }}">
            <span class="input-group-text">IQD</span>
          </div>
          {% if errors.free_delivery_threshold %}<div class="text-danger small mt-1">{{ errors.free_delivery_threshold }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label class="form-label">Ø²Ù…Ù† Ø§Ù„ØªÙˆØµÙŠÙ„</label>
          <div class="row g-2">
            <div class="col-6">
              <label for="dt_value" class="form-label">Ù‚ÙŠÙ…Ø© Ø²Ù…Ù† Ø§Ù„ØªÙˆØµÙŠÙ„</label>
              <input id="dt_value" type="number" min="0" class="form-control" name="delivery_time_value" value="{{ wizard.delivery_time_value|default:24 }}">
            </div>
            <div class="col-6">
              <label for="dt_unit" class="form-label">ÙˆØ­Ø¯Ø© Ø²Ù…Ù† Ø§Ù„ØªÙˆØµÙŠÙ„</label>
              <select id="dt_unit" class="form-select" name="delivery_time_unit">
                <option value="hour" {% if wizard.delivery_time_unit == 'hour' or not wizard.delivery_time_unit %}selected{% endif %}>Ø³Ø§Ø¹Ø©</option>
                <option value="day" {% if wizard.delivery_time_unit == 'day' %}selected{% endif %}>ÙŠÙˆÙ…</option>
              </select>
            </div>
          </div>
          <div class="text-muted small" id="dt_text"></div>
          {% if errors.delivery_time_value or errors.delivery_time_unit %}<div class="text-danger small mt-1">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø²Ù…Ù† Ø§Ù„ØªÙˆØµÙŠÙ„ ÙˆÙ‚ÙŠÙ…ØªÙ‡</div>{% endif %}
        </div>
        <div class="col-md-6">
          <label class="form-label">Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØ¬Ø±</label>
          <input id="logo_input" type="file" class="form-control" name="logo" accept="image/*">
          <div class="mt-2">
            <img id="logo_preview" src="" alt="Logo preview" class="rounded" style="max-height:120px; display:none; object-fit:cover;">
          </div>
        </div>
      </div>
      <div class="card-footer d-flex justify-content-between">
        <a class="btn btn-secondary" href="{% url 'super_owner_create_store' %}?step=2">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
        <button class="btn btn-success" name="action" value="finish">Ø¥Ù†Ø´Ø§Ø¡</button>
      </div>
    </form>
  {% endif %}
</div>

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<style>
#map{background:#f0f0f0}
.list-group .res{padding:8px;cursor:pointer;border:1px solid #eee;border-radius:8px;margin-bottom:6px}
.list-group .res:hover{background:#f7f7f7}
.leaflet-bar.locate-control{box-shadow:0 2px 6px rgba(0,0,0,.2);border-radius:10px;overflow:hidden;z-index:1000;pointer-events:auto}
.leaflet-bar.locate-control .locate-btn{width:38px;height:38px;border:none;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;text-decoration:none;pointer-events:auto}
.leaflet-bar.locate-control .locate-btn:hover{background:#f5f5f5}
#map{width:100%;height:420px}
.modal .modal-body{overflow:hidden}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var openBtn = document.getElementById('openMap');
  var addrPreview = document.getElementById('addrPreview');
  var mapModalEl = document.getElementById('mapModal');
  var modal = mapModalEl ? new bootstrap.Modal(mapModalEl) : null;
  var map, marker;
  function initMap(){
    if(map) return;
    map = L.map('map', { attributionControl: false }).setView([33.3152,44.3661], 13);
    L.control.attribution({ prefix: false }).addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'Â© OpenStreetMap contributors'}).addTo(map);
    map.on('click', function(e){ setMarker(e.latlng.lat, e.latlng.lng); reverseGeocode(e.latlng.lat, e.latlng.lng); });
    addLocateControl();
  }
  function setMarker(lat,lng){
    if(!marker){ marker = L.marker([lat,lng], {draggable:true}).addTo(map); marker.on('dragend', function(){ var ll = marker.getLatLng(); updateLatLng(ll.lat, ll.lng); reverseGeocode(ll.lat, ll.lng); }); }
    marker.setLatLng([lat,lng]); updateLatLng(lat,lng);
  }
  function updateLatLng(lat,lng){ document.getElementById('latitude').value = lat; document.getElementById('longitude').value = lng; addrPreview.textContent = '('+parseFloat(lat).toFixed(5)+', '+parseFloat(lng).toFixed(5)+')'; }
  function reverseGeocode(lat,lng){
    fetch('/api/addresses/reverse-geocode/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ lat: lat, lng: lng }) })
      .then(function(r){ return r.json(); })
      .then(function(data){
        var disp = data.formatted || '';
        document.getElementById('formatted_address').value = disp;
        document.getElementById('addressInput').value = disp || document.getElementById('addressInput').value;
        addrPreview.textContent = disp || addrPreview.textContent;
      }).catch(function(){ });
  }
  var searchInput = document.getElementById('searchInput');
  var searchBtn = document.getElementById('searchBtn');
  function doSearch(){
    var q = (searchInput.value||'').trim();
    if(!q) return;
    fetch('/api/addresses/autocomplete/?q='+encodeURIComponent(q))
      .then(function(r){ return r.json(); })
      .then(function(payload){
        var items = (payload && payload.results) || [];
        var list = document.getElementById('list');
        list.innerHTML='';
        items.slice(0,10).forEach(function(it){
          var d = document.createElement('div');
          d.className='res';
          d.textContent = it.label || '';
          d.addEventListener('click', function(){
            if(!map) initMap();
            var lat = parseFloat(it.lat), lng = parseFloat(it.lng);
            if(!isNaN(lat) && !isNaN(lng)){ setMarker(lat, lng); map.setView([lat,lng], 16); }
            var disp = it.label || '';
            document.getElementById('formatted_address').value = disp;
            document.getElementById('addressInput').value = disp;
            addrPreview.textContent = disp;
          });
          list.appendChild(d);
        });
      }).catch(function(){ });
  }
  if(searchBtn){ searchBtn.addEventListener('click', doSearch); }
  if(searchInput){ searchInput.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); doSearch(); } }); }
  if(openBtn && modal){ openBtn.addEventListener('click', function(){ modal.show(); }); }
  if(mapModalEl){
    mapModalEl.addEventListener('shown.bs.modal', function(){
      initMap();
      function forceInvalidate(){
        if(map){ map.invalidateSize(); }
        setTimeout(function(){ if(map){ map.invalidateSize(); } }, 100);
        setTimeout(function(){ if(map){ map.invalidateSize(); } }, 250);
        requestAnimationFrame(function(){ if(map){ map.invalidateSize(); } });
      }
      forceInvalidate();
    });
    mapModalEl.addEventListener('hidden.bs.modal', function(){ if(map){ try{ map.remove(); }catch(e){} map=null; marker=null; } });
  }
  var confirmBtn = document.getElementById('confirmLocation');
  var cancelBtn = document.getElementById('cancelMap');
  var closeBtn = mapModalEl ? mapModalEl.querySelector('.btn-close') : null;
  function hideModal(){
    var inst = mapModalEl ? bootstrap.Modal.getInstance(mapModalEl) : null;
    if(inst){ inst.hide(); }
    else if(modal){ modal.hide(); }
    try{ document.querySelectorAll('.modal-backdrop').forEach(function(el){ el.remove(); }); }catch(e){}
    try{ document.body.classList.remove('modal-open'); document.body.style.paddingRight=''; }catch(e){}
  }
  if(confirmBtn){ confirmBtn.addEventListener('click', function(){ var fa = document.getElementById('formatted_address').value || ''; if(fa){ document.getElementById('addressInput').value = fa; addrPreview.textContent = fa; } hideModal(); }); }
  if(cancelBtn){ cancelBtn.addEventListener('click', function(){ hideModal(); }); }
  if(closeBtn){ closeBtn.addEventListener('click', function(){ hideModal(); }); }

  function addLocateControl(){ var C = L.Control.extend({ options: { position: 'topright' }, onAdd: function(m){ var wrap = L.DomUtil.create('div','leaflet-bar locate-control'); L.DomEvent.disableClickPropagation(wrap); L.DomEvent.disableScrollPropagation(wrap); var btn = L.DomUtil.create('a','locate-btn', wrap); btn.href='#'; btn.setAttribute('role','button'); btn.title='Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹ÙŠ'; btn.textContent='ğŸ“'; L.DomEvent.on(btn,'click', function(e){ L.DomEvent.preventDefault(e); if(!navigator.geolocation){ return; } var old = btn.textContent; btn.textContent='â³'; navigator.geolocation.getCurrentPosition(function(pos){ btn.textContent=old; var lat=pos.coords.latitude, lng=pos.coords.longitude; setMarker(lat,lng); map.setView([lat,lng],16); reverseGeocode(lat,lng); }, function(){ btn.textContent=old; }, { enableHighAccuracy:true, timeout:8000 }); }); return wrap; } }); map.addControl(new C()); }
});
</script>
{% endblock %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const s = document.getElementById('owner_search');
  const list = document.getElementById('owner_list');
  if(s && list){
    s.addEventListener('input', function(){
      const q = s.value.trim();
      fetch('{% url "super_owner_owner_search_json" %}?q='+encodeURIComponent(q)).then(r=>r.json()).then(d=>{
        list.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ</option>';
        (d.results||[]).forEach(function(o){
          const opt = document.createElement('option'); opt.value=o.id; opt.textContent = o.name + (o.phone?(' - '+o.phone):''); list.appendChild(opt);
        });
      }).catch(()=>{});
    });
  }
  const submitCreate = document.getElementById('submitCreateOwner');
  if(submitCreate){
    submitCreate.addEventListener('click', function(){
      const full = document.getElementById('new_owner_full_name').value.trim();
      const phone = document.getElementById('new_owner_phone').value.trim();
      const email = document.getElementById('new_owner_email').value.trim();
      const err = document.getElementById('new_owner_error'); err.textContent='';
      const fd = new FormData(); fd.append('full_name', full); fd.append('phone', phone); fd.append('email', email);
      function getCookie(name){ const value = `; ${document.cookie}`; const parts = value.split(`; ${name}=`); if (parts.length === 2) return parts.pop().split(';').shift(); }
      const csrf = getCookie('csrftoken');
      submitCreate.disabled = true; submitCreate.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...';
      fetch('{% url "super_owner_create_owner_json" %}', { method:'POST', body: fd, headers: csrf ? { 'X-CSRFToken': csrf } : {} }).then(r=>r.json().then(j=>({ok:r.ok, status:r.status, data:j}))).then(r=>{
        submitCreate.disabled = false; submitCreate.textContent = 'Ø¥Ù†Ø´Ø§Ø¡';
        if(!r.ok){
          let msg = 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„Ùƒ';
          if(r.status === 403){ msg = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„'; }
          else if(r.status === 405){ msg = 'Ø·Ø±ÙŠÙ‚Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©'; }
          else if(r.status === 409 && r.data && r.data.error === 'duplicate_phone'){ msg = 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹'; }
          else if(r.status === 400){
            if(r.data && r.data.error === 'missing_required'){ msg = 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†'; }
            else if(r.data && r.data.error === 'invalid_phone'){ msg = 'Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­. Ø§Ù„ØµÙŠØºØ©: 07xxxxxxxxx'; }
          }
          else if(r.status >= 500){ msg = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„Ùƒ'; }
          err.textContent = msg; return;
        }
        const opt = document.createElement('option'); opt.value = r.data.id; opt.textContent = r.data.name + (r.data.phone?(' - '+r.data.phone):''); opt.selected = true; list.appendChild(opt);
        const modalEl = document.getElementById('createOwnerModal'); const modal = bootstrap.Modal.getInstance(modalEl); modal && modal.hide();
      }).catch(()=>{ err.textContent='Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'; });
    });
  }
  const dtValue = document.getElementById('dt_value');
  const dtUnit = document.getElementById('dt_unit');
  const dtText = document.getElementById('dt_text');
  function updateDt(){
    if(!dtText) return;
    const v = dtValue ? parseInt(dtValue.value||'0',10) : 0;
    const u = dtUnit ? dtUnit.value : 'hour';
    dtText.textContent = v ? (u === 'day' ? (v+' ÙŠÙˆÙ…') : (v+' Ø³Ø§Ø¹Ø©')) : '';
  }
  if(dtValue && dtUnit){ dtValue.addEventListener('input', updateDt); dtUnit.addEventListener('change', updateDt); updateDt(); }
  const logoInput = document.getElementById('logo_input');
  const logoPreview = document.getElementById('logo_preview');
  if(logoInput && logoPreview){
    logoInput.addEventListener('change', function(){
      const f = logoInput.files && logoInput.files[0];
      if(f){ logoPreview.src = URL.createObjectURL(f); logoPreview.style.display = 'block'; }
      else { logoPreview.src=''; logoPreview.style.display='none'; }
    });
  }
});
</script>
<style>
.form-label,
.form-check-label {
  color: inherit;
}
</style>
{% endblock %}
