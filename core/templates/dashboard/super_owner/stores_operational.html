{% extends 'base.html' %}
{% load static %}

{% block title %}إدارة المتاجر التشغيلية{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-2">
        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#filtersModal"><i class="fas fa-filter me-1"></i> تصفية</button>
        <a href="{% url 'super_owner_create_store' %}" class="btn btn-success"><i class="fas fa-plus me-1"></i> إضافة متجر</a>
      </div>
      <div class="d-flex align-items-center gap-2">
        <a href="{% url 'home' %}" class="btn btn-outline-secondary"><i class="fas fa-home me-1"></i> الرئيسية</a>
        <a href="{% url 'super_owner_dashboard' %}" class="btn btn-outline-secondary"><i class="fas fa-tachometer-alt me-1"></i> لوحة التحكم</a>
      </div>
    </div>
  </div>

  <div class="modal fade" id="filtersModal" tabindex="-1">
    <div class="modal-dialog">
      <form method="get" class="modal-content">
        <div class="modal-header"><h5 class="modal-title">تصفية المتاجر</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">المدينة</label>
            <select class="form-select" name="city">
              <option value="">الكل</option>
              {% for c in cities %}
                <option value="{{ c }}" {% if filters.city == c %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">المالك</label>
            <select class="form-select" name="owner">
              <option value="">الكل</option>
              {% for o in owners %}
                <option value="{{ o.id }}" {% if filters.owner|default:'' == o.id|stringformat:'s' %}selected{% endif %}>{{ o.get_full_name|default:o.username }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">الحالة</label>
            <select class="form-select" name="active">
              <option value="">الكل</option>
              <option value="active" {% if filters.active == 'active' %}selected{% endif %}>نشط</option>
              <option value="inactive" {% if filters.active == 'inactive' %}selected{% endif %}>موقوف</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">القالب/الفئة</label>
            <select class="form-select" name="category">
              <option value="">الكل</option>
              {% for val, label in categories %}
                <option value="{{ val }}" {% if filters.category == val %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
          <button class="btn btn-primary">تطبيق</button>
        </div>
      </form>
    </div>
  </div>

  <form method="post">
    {% csrf_token %}
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center gap-2">
        <select name="action" class="form-select form-select-sm" style="max-width:200px">
          <option value="">اختر عملية جماعية</option>
          <option value="bulk_activate">تفعيل</option>
          <option value="bulk_deactivate">إيقاف</option>
          <option value="bulk_set_category">تطبيق قالب/فئة</option>
          <option value="bulk_set_delivery_fee">تغيير رسوم التوصيل</option>
          
        </select>
        <select name="category" class="form-select form-select-sm" style="max-width:180px">
          <option value="">الفئة</option>
          {% for val, label in categories %}
            <option value="{{ val }}">{{ label }}</option>
          {% endfor %}
        </select>
        <input type="number" step="0.01" name="delivery_fee" class="form-control form-control-sm" style="max-width:160px" placeholder="رسوم التوصيل">
        <button type="button" class="btn btn-outline-danger btn-sm" id="bulk_delete_selected_stores">حذف المحدد</button>
        <button type="button" class="btn btn-danger btn-sm" id="bulk_delete_all_stores">حذف الكل</button>
      </div>
      
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th><input type="checkbox" id="select_all"></th>
            <th>اسم المتجر</th>
            <th>المدينة</th>
            <th>القالب</th>
            <th>المالك</th>
            <th>الحالة</th>
            <th>المنتجات</th>
            <th>طلبات اليوم</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% for store in stores %}
            <tr>
              <td><input type="checkbox" name="selected_ids" value="{{ store.id }}" class="row_select"></td>
              <td>
                <div class="d-flex align-items-center">
                  {% if store.main_logo_url %}
                    <img src="{{ store.main_logo_url }}" alt="{{ store.name }}" class="rounded-circle me-2" width="36" height="36" style="object-fit: cover;" onerror="this.onerror=null;this.src='https://placehold.co/80x80?text=Store'">
                  {% endif %}
                  <div>
                    <a href="{% url 'super_owner_store_center' store.id %}" class="fw-bold">{{ store.name }}</a>
                    <div class="small text-muted">{{ store.description|truncatechars:60 }}</div>
                  </div>
                </div>
              </td>
              <td>{{ store.city }}</td>
              <td>{{ store.get_category_display }}</td>
              <td>
                {% if store.owner %}
                  {{ store.owner.get_full_name|default:store.owner.username }}
                {% else %}
                  غير مُعيّن
                {% endif %}
              </td>
              <td>
                {% if store.is_active %}
                  <span class="badge bg-success">نشط</span>
                {% else %}
                  <span class="badge bg-danger">موقوف</span>
                {% endif %}
              </td>
              <td>{{ store.products_count }}</td>
              <td>{{ store.orders_today }}</td>
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <a href="{% url 'super_owner_store_center' store.id %}" class="btn btn-primary" title="فتح"><i class="fas fa-external-link-alt"></i></a>
                  {% if store.is_active %}
                    <button name="action" value="deactivate" class="btn btn-warning" title="إيقاف" onclick="return submitRowAction({{ store.id }}, 'deactivate')"><i class="fas fa-pause"></i></button>
                  {% else %}
                    <button name="action" value="activate" class="btn btn-success" title="تفعيل" onclick="return submitRowAction({{ store.id }}, 'activate')"><i class="fas fa-play"></i></button>
                  {% endif %}
                  <a href="{% url 'super_owner_add_product' %}?store={{ store.id }}" class="btn btn-info" title="إنشاء منتج"><i class="fas fa-plus"></i></a>
                  <a href="{% url 'super_owner_orders' %}?store={{ store.id }}" class="btn btn-secondary" title="مشاهدة الطلبات"><i class="fas fa-list"></i></a>
                  
                </div>
              </div>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="9" class="text-center py-4">لا يوجد متاجر مطابقة</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <input type="hidden" name="store_id" id="row_action_store_id">
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const selectAll = document.getElementById('select_all');
  const rows = document.querySelectorAll('.row_select');
  selectAll && selectAll.addEventListener('change', function(){ rows.forEach(r=>{ r.checked = selectAll.checked; }); });
});
function submitRowAction(id, action){
  const form = document.querySelector('form[method="post"]');
  document.getElementById('row_action_store_id').value = id;
  const input = document.createElement('input'); input.type='hidden'; input.name='action'; input.value=action; form.appendChild(input);
  form.submit();
  return false;
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  var form=document.querySelector('form[method="post"]');
  var btnSel=document.getElementById('bulk_delete_selected_stores');
  var btnAll=document.getElementById('bulk_delete_all_stores');
  function submitBulkDelete(all){
    var actionInput=form.querySelector('select[name="action"]');
    if(actionInput){ actionInput.value='bulk_delete'; }
    if(all){
      document.querySelectorAll('.row_select').forEach(function(cb){ cb.checked=true; });
    }
    form.submit();
  }
  if(btnSel){ btnSel.addEventListener('click', function(){ submitBulkDelete(false); }); }
  if(btnAll){ btnAll.addEventListener('click', function(){ if(confirm('تأكيد حذف كل العناصر المعروضة؟')) submitBulkDelete(true); }); }
});
</script>

<style>
.badge{padding:.4rem .6rem}
@media (max-width:768px){
  .table-responsive{border:0}
  table thead{display:none}
  table tbody tr{display:block;margin-bottom:12px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:10px}
  table tbody td{display:flex;justify-content:space-between;align-items:center;padding:.4rem 0}
  table tbody td::before{content:attr(data-label);font-weight:600;color:#555}
}
</style>
{% endblock %}
