{% extends 'base.html' %}
{% load static %}
{% load math_filters %}

{% block title %}إدارة الطلبات - المالك الرئيسي{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-gradient-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-shopping-cart me-2"></i>
                            إدارة الطلبات
                        </h4>
                        <a href="{% url 'super_owner_dashboard' %}" class="btn btn-light btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>
                            العودة للوحة التحكم
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    <div class="row g-3 mb-3 align-items-center">
                        <div class="col-lg-8">
                            <form class="row g-3" method="get">
                                <input type="hidden" name="group" value="{{ group|default:'active' }}">
                                <div class="col-md-6">
                                    <input type="text" name="q" value="{{ q|default:'' }}" class="form-control" placeholder="بحث شامل: رقم الطلب، اسم العميل، رقم الجوال">
                                </div>
                                <div class="col-md-3">
                                    <button type="submit" class="btn btn-primary">بحث</button>
                                    <a href="?group={{ group|default:'active' }}" class="btn btn-outline-secondary">إعادة تعيين</a>
                                </div>
                            </form>
                        </div>
                        <div class="col-lg-4">
                            <div class="btn-group" role="group" aria-label="فلاتر الحالة">
                                <a href="?group=active{% if q %}&q={{ q }}{% endif %}" class="btn btn-outline-primary {% if group == 'active' %}active{% endif %}">نشطة</a>
                                <a href="?group=completed{% if q %}&q={{ q }}{% endif %}" class="btn btn-outline-success {% if group == 'completed' %}active{% endif %}">مكتملة</a>
                                <a href="?group=canceled{% if q %}&q={{ q }}{% endif %}" class="btn btn-outline-danger {% if group == 'canceled' %}active{% endif %}">ملغاة</a>
                                <a href="?group=recent{% if q %}&q={{ q }}{% endif %}" class="btn btn-outline-warning {% if group == 'recent' %}active{% endif %}">حديثة</a>
                                <a href="?group=all{% if q %}&q={{ q }}{% endif %}" class="btn btn-outline-secondary {% if group == 'all' %}active{% endif %}">الكل</a>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <button type="button" class="btn btn-outline-danger btn-sm" id="bulk_delete_selected_orders">حذف المحدد</button>
                            <button type="button" class="btn btn-danger btn-sm" id="bulk_delete_all_orders">حذف الكل</button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th><input type="checkbox" id="select_all_orders"></th>
                                    <th>#</th>
                                    <th>رقم الطلب</th>
                                    <th>العميل</th>
                                    <th>المتجر</th>
                                    <th>المبلغ الإجمالي</th>
                                    <th>حالة الطلب</th>
                                    <th>طريقة الدفع</th>
                                    <th>تاريخ الطلب</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for oi in orders_info %}
                                {% with order=oi.order %}
                                <tr>
                                    <td><input type="checkbox" class="order-select" value="{{ order.id }}"></td>
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                        <strong>#{{ order.id }}</strong>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if order.user.profile.avatar %}
                                                <img src="{{ order.user.profile.avatar.url }}" alt="{{ order.user.username }}" class="rounded-circle me-2" width="30" height="30">
                                            {% else %}
                                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px;">
                                                    <i class="fas fa-user text-white"></i>
                                                </div>
                                            {% endif %}
                                            <div>
                                                <strong>{{ order.user.get_full_name|default:order.user.username }}</strong>
                                                <br>
                                                <small class="text-muted">{{ order.user.phone }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if order.store.main_logo_url %}
                                                <img src="{{ order.store.main_logo_url }}" alt="{{ order.store.name }}" class="rounded-circle me-2" width="30" height="30" style="object-fit: cover;">
                                            {% else %}
                                                <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px;">
                                                    <i class="fas fa-store text-white"></i>
                                                </div>
                                            {% endif %}
                                            <span>{{ order.store.name }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <strong>{{ order.total_amount|iqd }}</strong>
                                        <br>
                                        <small class="text-muted">شحن: {{ order.delivery_fee|iqd }}</small>
                                    </td>
                                    <td>
                                        <span class="order-status" data-order-id="{{ order.id }}">
                                            {% if order.status == 'pending' %}
                                                <span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i> قيد الانتظار</span>
                                            {% elif order.status == 'accepted' %}
                                                <span class="badge bg-info"><i class="fas fa-check me-1"></i> تم القبول</span>
                                            {% elif order.status == 'packed' %}
                                                <span class="badge bg-primary"><i class="fas fa-box me-1"></i> تم التعبئة</span>
                                            {% elif order.status == 'delivered' %}
                                                <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i> تم التسليم</span>
                                            {% elif order.status == 'canceled' %}
                                                <span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i> ملغي</span>
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        {% if order.payment_method == 'cod' %}
                                            <span class="badge bg-light text-dark">
                                                <i class="fas fa-money-bill-wave me-1"></i>
                                                الدفع عند الاستلام
                                            </span>
                                        {% elif order.payment_method == 'card' %}
                                            <span class="badge bg-light text-dark">
                                                <i class="fas fa-credit-card me-1"></i>
                                                بطاقة ائتمان
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>{{ order.created_at|date:"Y/m/d H:i" }}</td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2 flex-wrap">
                                            <a href="{% url 'order_detail' order.id %}" class="btn btn-outline-primary btn-sm" title="عرض التفاصيل" data-bs-toggle="tooltip">
                                                <i class="fas fa-eye" style="font-size:1.25rem;width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;"></i>
                                            </a>
                                            {% if oi.wa_number %}
                                            <a class="btn btn-success btn-sm wa-owner-btn" title="واتساب صاحب المتجر" target="_blank" href="https://wa.me/{{ oi.wa_number }}?text={{ oi.wa_text }}" data-bs-toggle="tooltip">
                                                <i class="fab fa-whatsapp" style="font-size:1.25rem;width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;"></i>
                                            </a>
                                            {% else %}
                                            <button type="button" class="btn btn-success btn-sm" disabled title="لا يوجد رقم مالك" data-bs-toggle="tooltip">
                                                <i class="fab fa-whatsapp" style="font-size:1.25rem;width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;"></i>
                                            </button>
                                            <span class="text-danger small">رقم مالك المتجر غير متوفر</span>
                                            {% endif %}

                                            <div class="dropdown">
                                                <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle status-dd" data-bs-toggle="dropdown" title="تغيير الحالة" data-bs-placement="top">
                                                    <i class="fas fa-edit" style="font-size:1.25rem;width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;"></i>
                                                </button>
                                                <div class="dropdown-menu">
                                                    {% for st in allowed_statuses %}
                                                        {% if order.status != st %}
                                                        <button type="button" class="dropdown-item {% if st == 'canceled' %}text-danger{% endif %} status-item" data-order-id="{{ order.id }}" data-status="{{ st }}">
                                                            {% if st == 'pending' %}<i class="fas fa-clock me-1"></i> قيد الانتظار{% elif st == 'accepted' %}<i class="fas fa-check me-1"></i> تم القبول{% elif st == 'packed' %}<i class="fas fa-box me-1"></i> تم التعبئة{% elif st == 'delivered' %}<i class="fas fa-check-circle me-1"></i> تم التسليم{% elif st == 'canceled' %}<i class="fas fa-times-circle me-1"></i> ملغي{% endif %}
                                                        </button>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>

                                            <input type="text" class="form-control form-control-sm track-input" value="{{ order.tracking_number|default:'' }}" placeholder="رقم التتبع" style="width:160px;" data-order-id="{{ order.id }}">
                                            <button type="button" class="btn btn-outline-primary btn-sm save-track" data-order-id="{{ order.id }}" title="حفظ رقم التتبع" data-bs-toggle="tooltip">
                                                <i class="fas fa-save" style="font-size:1.25rem;width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;"></i>
                                            </button>

                                            <button type="button" class="btn btn-outline-success btn-sm delivery-btn" data-order-id="{{ order.id }}" title="إرسال لشركة التوصيل" data-bs-toggle="tooltip">
                                                <i class="fas fa-shipping-fast" style="font-size:1.25rem;width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;"></i>
                                            </button>

                                            <button type="button" class="btn btn-outline-danger btn-sm delete-order" data-order-id="{{ order.id }}" title="حذف الطلب" data-bs-toggle="tooltip">
                                                <i class="fas fa-trash" style="font-size:1.25rem;width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endwith %}
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">لا يوجد طلبات حتى الآن</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.bg-gradient-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.btn-group-sm .btn {
    padding: 0.25rem 0.4rem;
    font-size: 0.8rem;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

.badge {
    font-weight: 500;
    padding: 0.4em 0.6em;
}

.dropdown-menu {
    min-width: 200px;
    max-height: 220px;
    overflow-y: auto;
}

.dropdown-item {
    padding: 0.5rem 1rem;
    border: none;
    background: none;
    width: 100%;
    text-align: right;
    cursor: pointer;
}

.dropdown-item:hover {
    background-color: #f8f9fa;
}
</style>

<div class="modal fade" id="deliveryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">إرسال لشركة التوصيل</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">هاتف شركة التوصيل</label>
          <input type="tel" class="form-control" id="delivery_phone_input" placeholder="07xxxxxxxxx">
        </div>
        <div class="mb-3">
          <label class="form-label">رقم التتبع</label>
          <input type="text" class="form-control" id="tracking_number_input" placeholder="رقم التتبع" required>
        </div>
        <div id="track_link_row" class="mb-2 d-none">
          <label class="form-label">رابط تتبع الطلب</label>
          <div class="input-group">
            <input type="text" class="form-control" id="track_link_input" readonly>
            <button class="btn btn-outline-primary" type="button" id="copy_track_btn">نسخ</button>
          </div>
          <small class="text-muted">انسخ الرابط لإرساله عبر إنستغرام أو أي تطبيق.</small>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="include_address_input">
          <label class="form-check-label" for="include_address_input">إضافة العنوان في الرسالة</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        <button type="button" class="btn btn-success" id="confirm_delivery_btn">تأكيد وإرسال</button>
      </div>
    </div>
  </div>
</div>

<div id="snackbar" class="position-fixed bottom-0 end-0 p-3" style="z-index:1080; display:none;">
  <div class="toast align-items-center text-white bg-success border-0 show">
    <div class="d-flex">
      <div class="toast-body" id="snackbar-text">تم الحفظ</div>
      <button type="button" class="btn-close btn-close-white ms-2 m-auto" onclick="document.getElementById('snackbar').style.display='none'"></button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  try { var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')); tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el); }); } catch (e) {}
  var pending = false;
  function showSnack(text, error) { var el = document.getElementById('snackbar'); var body = document.getElementById('snackbar-text'); body.textContent = text; var toast = el.querySelector('.toast'); toast.classList.remove('bg-success','bg-danger'); toast.classList.add(error ? 'bg-danger' : 'bg-success'); el.style.display = 'block'; setTimeout(function(){ el.style.display='none'; }, 6000); }
  function getCookie(name){ var v = document.cookie.split(';').map(function(s){return s.trim();}).filter(function(s){return s.indexOf(name+'=')===0;}); if(!v.length) return ''; return decodeURIComponent(v[0].split('=')[1]); }
  var csrftoken = getCookie('csrftoken');
  var STATUS_UI = {
    'pending': { cls: 'badge bg-warning text-dark', html: '<i class="fas fa-clock me-1"></i> قيد الانتظار' },
    'accepted': { cls: 'badge bg-info', html: '<i class="fas fa-check me-1"></i> تم القبول' },
    'packed': { cls: 'badge bg-primary', html: '<i class="fas fa-box me-1"></i> تم التعبئة' },
    'on_the_way': { cls: 'badge bg-secondary', html: '<i class="fas fa-truck me-1"></i> في الطريق' },
    'delivered': { cls: 'badge bg-success', html: '<i class="fas fa-check-circle me-1"></i> تم التسليم' },
    'canceled': { cls: 'badge bg-danger', html: '<i class="fas fa-times-circle me-1"></i> ملغي' }
  };
  function updateOrderStatusBadge(orderId, status){ var container = document.querySelector('.order-status[data-order-id="'+orderId+'"]'); if(!container) return; var ui = STATUS_UI[status] || { cls: 'badge bg-secondary', html: status }; container.innerHTML = '<span class="'+ui.cls+'">'+ui.html+'</span>'; }
  document.querySelectorAll('.status-item').forEach(function(btn){ btn.addEventListener('click', function(ev){ ev.stopPropagation(); ev.preventDefault(); if(pending) return; pending = true; var oid = this.getAttribute('data-order-id'); var st = this.getAttribute('data-status'); fetch('{% url "super_owner_update_order_status_json" %}', { method:'POST', headers:{'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded','X-CSRFToken':csrftoken}, body:'order_id='+encodeURIComponent(oid)+'&status='+encodeURIComponent(st) }).then(function(r){ pending=false; if(!r.ok) throw r; return r.json(); }).then(function(j){ if(j.ok){ updateOrderStatusBadge(oid, j.status); showSnack('تم الحفظ', false); } else { showSnack('فشل الحفظ', true); } }).catch(function(){ pending=false; showSnack('خطأ بالخادم', true); }); }); });
  document.querySelectorAll('.save-track').forEach(function(btn){ btn.addEventListener('click', function(ev){ ev.stopPropagation(); ev.preventDefault(); if(pending) return; var oid = this.getAttribute('data-order-id'); var inp = document.querySelector('.track-input[data-order-id="'+oid+'"]'); var val = inp ? inp.value.trim() : ''; pending = true; fetch('{% url "super_owner_update_delivery_json" %}', { method:'POST', headers:{'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded','X-CSRFToken':csrftoken}, body:'order_id='+encodeURIComponent(oid)+'&tracking_number='+encodeURIComponent(val) }).then(function(r){ pending=false; if(!r.ok) throw r; return r.json(); }).then(function(j){ if(j.ok){ showSnack('تم الحفظ', false); } else { showSnack('فشل الحفظ', true); } }).catch(function(){ pending=false; showSnack('خطأ بالخادم', true); }); }); });
  var deliveryModal = document.getElementById('deliveryModal'); var dm; try { dm = new bootstrap.Modal(deliveryModal); } catch(e) {}
  var currentOrderId = null;
  document.querySelectorAll('.delivery-btn').forEach(function(btn){ btn.addEventListener('click', function(ev){ ev.stopPropagation(); ev.preventDefault(); currentOrderId = this.getAttribute('data-order-id'); var inp = document.querySelector('.track-input[data-order-id="'+currentOrderId+'"]'); document.getElementById('tracking_number_input').value = inp ? inp.value.trim() : ''; document.getElementById('delivery_phone_input').value = ''; document.getElementById('include_address_input').checked = false; if(dm) dm.show(); }); });
  document.getElementById('confirm_delivery_btn').addEventListener('click', function(){ if(pending) return; var tn = document.getElementById('tracking_number_input').value.trim(); var dp = document.getElementById('delivery_phone_input').value.trim(); var inc = document.getElementById('include_address_input').checked ? '1' : '0'; if(!tn){ showSnack('رقم التتبع مطلوب', true); return; } pending = true; fetch('{% url "super_owner_update_delivery_json" %}', { method:'POST', headers:{'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded','X-CSRFToken':csrftoken}, body:'order_id='+encodeURIComponent(currentOrderId)+'&tracking_number='+encodeURIComponent(tn)+'&delivery_phone='+encodeURIComponent(dp)+'&include_address='+encodeURIComponent(inc) }).then(function(r){ pending=false; if(!r.ok) throw r; return r.json(); }).then(function(j){ if(j.ok){ showSnack('تم الحفظ', false); try { dm.hide(); } catch(e) {} if(j.wa_url){ window.open(j.wa_url, '_blank'); } if(j.share_url){ var row = document.getElementById('track_link_row'); var input = document.getElementById('track_link_input'); input.value = j.share_url; row.classList.remove('d-none'); try { navigator.clipboard.writeText(j.share_url); showSnack('تم نسخ رابط المشاركة', false); } catch(e) {} } } else { showSnack('فشل الحفظ', true); } }).catch(function(){ pending=false; showSnack('خطأ بالخادم', true); }); });
  document.getElementById('copy_track_btn').addEventListener('click', function(){ var v = document.getElementById('track_link_input').value; if(!v){ showSnack('لا يوجد رابط', true); return; } try { navigator.clipboard.writeText(v); showSnack('تم النسخ', false); } catch(e){ showSnack('تعذر النسخ', true); } });
  document.querySelectorAll('.wa-owner-btn').forEach(function(a){ a.addEventListener('click', function(ev){ ev.stopPropagation(); }); });

  document.querySelectorAll('.delete-order').forEach(function(btn){ btn.addEventListener('click', function(ev){ ev.stopPropagation(); ev.preventDefault(); if(pending) return; var tr = this.closest('tr'); var oid = this.getAttribute('data-order-id'); if(!confirm('تأكيد حذف الطلب #' + oid + '؟')) return; pending = true; fetch('{% url "super_owner_delete_order_json" %}', { method:'POST', headers:{'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded','X-CSRFToken':csrftoken}, body:'order_id='+encodeURIComponent(oid) }).then(function(r){ pending=false; if(!r.ok) throw r; return r.json(); }).then(function(j){ if(j.ok){ if(tr) tr.remove(); showSnack('تم حذف الطلب', false); } else { showSnack('فشل حذف الطلب', true); } }).catch(function(){ pending=false; showSnack('خطأ بالخادم', true); }); }); });

  var selectAllOrders = document.getElementById('select_all_orders');
  if(selectAllOrders){ selectAllOrders.addEventListener('change', function(){ document.querySelectorAll('.order-select').forEach(function(cb){ cb.checked = selectAllOrders.checked; }); }); }
  function collectVisibleOrderIds(){ var ids=[]; document.querySelectorAll('.order-select').forEach(function(cb){ ids.push(cb.value); }); return ids; }
  function deleteBulk(ids){ if(!ids.length){ showSnack('يرجى اختيار طلبات', true); return; } pending = true; var fd = new FormData(); fd.append('action','bulk'); ids.forEach(function(id){ fd.append('selected_ids', id); }); fetch('{% url "super_owner_delete_order_json" %}', { method:'POST', body: fd, headers: {'X-Requested-With':'XMLHttpRequest','X-CSRFToken': csrftoken }, credentials:'same-origin' }).then(function(r){ pending=false; if(!r.ok) throw r; return r.json(); }).then(function(j){ if(j.ok){ location.reload(); } else { showSnack('فشل حذف الطلبات', true); } }).catch(function(){ pending=false; showSnack('خطأ بالخادم', true); }); }
  var btnSel=document.getElementById('bulk_delete_selected_orders');
  var btnAll=document.getElementById('bulk_delete_all_orders');
  if(btnSel){ btnSel.addEventListener('click', function(){ var ids=[]; document.querySelectorAll('.order-select:checked').forEach(function(cb){ ids.push(cb.value); }); deleteBulk(ids); }); }
  if(btnAll){ btnAll.addEventListener('click', function(){ if(!confirm('تأكيد حذف كل العناصر المعروضة؟')) return; deleteBulk(collectVisibleOrderIds()); }); }

  // Auto-refresh statuses
  function pollStatuses(){
    try {
      var ids = Array.prototype.map.call(document.querySelectorAll('.order-status[data-order-id]'), function(el){ return el.getAttribute('data-order-id'); }).filter(function(x){ return !!x; });
      if(!ids.length) return;
      var url = '{% url "super_owner_orders_statuses_json" %}?ids=' + encodeURIComponent(ids.join(','));
      fetch(url, { headers: {'X-Requested-With':'XMLHttpRequest'} }).then(function(r){ if(!r.ok) throw r; return r.json(); }).then(function(j){
        if(j && j.statuses){
          Object.keys(j.statuses).forEach(function(k){ var st = j.statuses[k].status; updateOrderStatusBadge(k, st); });
        }
      }).catch(function(){});
    } catch(e) {}
  }
  setInterval(pollStatuses, 10000);
  setTimeout(pollStatuses, 2000);
});
</script>
</style>
{% endblock %}
