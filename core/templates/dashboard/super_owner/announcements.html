{% extends 'base.html' %}
{% load static %}

{% block title %}لوحة المالك - إدارة الإعلانات{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="mb-3" style="color: var(--gold);">إدارة الإعلانات</h1>
  <p class="text-muted">أضف إعلانات جديدة أو فعّل/عطّل الإعلانات الحالية. تظهر الإعلانات كشرائح في راية الصفحة الرئيسية.</p>
  <div class="d-flex align-items-center gap-2 mb-3">
    <a href="{% url 'home' %}" class="btn btn-outline-secondary">
      <i class="fas fa-home me-1"></i> الرئيسية
    </a>
    <a href="{% url 'super_owner_dashboard' %}" class="btn btn-outline-secondary">
      <i class="fas fa-tachometer-alt me-1"></i> لوحة التحكم
    </a>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <form method="post" enctype="multipart/form-data" class="row g-3">
        {% csrf_token %}
        <input type="hidden" name="action" value="create">
        <div class="col-md-6">
          <label class="form-label">العنوان</label>
          <input type="text" name="title" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">رابط الإجراء</label>
          <input type="text" name="action_url" class="form-control" value="/stores/">
        </div>
        <div class="col-12">
          <label class="form-label">الوصف</label>
          <textarea name="description" class="form-control" rows="2"></textarea>
        </div>
        <div class="col-md-4">
          <label class="form-label">نسبة الخصم</label>
          <input type="number" name="discount_percent" class="form-control" min="0" max="100" value="0">
        </div>
        <div class="col-md-4">
          <label class="form-label">تاريخ البداية</label>
          <input type="datetime-local" name="start_date" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">تاريخ النهاية</label>
          <input type="datetime-local" name="end_date" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">صورة البانر</label>
          <input type="file" name="banner_image" class="form-control" accept="image/*">
        </div>
        <div class="col-md-6 d-flex align-items-center">
          <div class="form-check mt-4">
            <input class="form-check-input" type="checkbox" id="isActiveCheck" name="is_active">
            <label class="form-check-label" for="isActiveCheck">نشط</label>
          </div>
        </div>
        <div class="col-12 d-flex justify-content-end">
          <button type="submit" class="btn btn-primary"><i class="bi bi-plus-circle"></i> إضافة إعلان</button>
        </div>
      </form>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <button type="button" class="btn btn-outline-danger btn-sm" id="bulk_delete_selected_campaigns">حذف المحدد</button>
      <button type="button" class="btn btn-danger btn-sm" id="bulk_delete_all_campaigns">حذف الكل</button>
    </div>
    <div>
      <input type="checkbox" id="select_all_campaigns"> <label for="select_all_campaigns" class="ms-1">تحديد الكل</label>
    </div>
  </div>

  <div class="row g-3">
    {% for c in campaigns %}
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="form-check">
              <input class="form-check-input campaign-select" type="checkbox" value="{{ c.id }}" id="csel_{{ c.id }}">
              <label class="form-check-label" for="csel_{{ c.id }}">اختيار</label>
            </div>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="card-title mb-0">{{ c.title }}</h5>
            <span class="badge {% if c.is_active %}bg-success{% else %}bg-secondary{% endif %}">{% if c.is_active %}نشط{% else %}غير نشط{% endif %}</span>
          </div>
          <p class="card-text text-muted">{{ c.description|default:'' }}</p>
          {% if c.banner_image %}
            <img src="{{ c.banner_image.url }}" alt="{{ c.title }}" class="img-fluid rounded mb-2" style="max-height:160px; object-fit:cover;">
          {% endif %}
          <div class="small text-muted">من {{ c.start_date }} إلى {{ c.end_date }}</div>
        </div>
        <div class="card-footer d-flex gap-2">
          <form method="post" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="action" value="{% if c.is_active %}deactivate{% else %}activate{% endif %}">
            <input type="hidden" name="campaign_id" value="{{ c.id }}">
            <button class="btn btn-sm {% if c.is_active %}btn-outline-warning{% else %}btn-outline-success{% endif %}">
              {% if c.is_active %}تعطيل{% else %}تفعيل{% endif %}
            </button>
          </form>
          <form method="post" class="d-inline flex-grow-1">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_url">
            <input type="hidden" name="campaign_id" value="{{ c.id }}">
            <div class="input-group input-group-sm">
              <input type="text" class="form-control" name="action_url" value="{{ c.action_url|default:'/stores/' }}">
              <button class="btn btn-outline-primary">تحديث الرابط</button>
            </div>
          </form>
          <form method="post" class="d-inline ms-auto">
            {% csrf_token %}
            <input type="hidden" name="action" value="delete">
            <input type="hidden" name="campaign_id" value="{{ c.id }}">
            <button class="btn btn-sm btn-outline-danger">حذف</button>
          </form>
        </div>
      </div>
    </div>
    {% empty %}
      <div class="col-12">
        <div class="alert alert-info">لا توجد إعلانات بعد. قم بإضافة إعلان جديد من النموذج أعلى الصفحة.</div>
      </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .card .badge { font-size: .8rem; }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  function getCookie(name){ var v=document.cookie.match('(^|; )'+name+'=([^;]*)'); return v?decodeURIComponent(v[2]):''; }
  var csrftoken=getCookie('csrftoken');
  var selectAll=document.getElementById('select_all_campaigns');
  if(selectAll){ selectAll.addEventListener('change', function(){ document.querySelectorAll('.campaign-select').forEach(function(cb){ cb.checked = selectAll.checked; }); }); }
  function collectVisibleIds(){ var ids=[]; document.querySelectorAll('.campaign-select').forEach(function(cb){ ids.push(cb.value); }); return ids; }
  function submitBulk(ids){ if(!ids.length){ var a=document.createElement('div'); a.className='alert alert-warning'; a.textContent='يرجى اختيار إعلانات'; document.body.appendChild(a); setTimeout(function(){ a.remove(); },6000); return; } var fd=new FormData(); fd.append('action','bulk_delete_selected'); ids.forEach(function(id){ fd.append('selected_ids', id); }); fetch(window.location.href, { method:'POST', body: fd, credentials:'same-origin', headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken': csrftoken} }).then(function(r){ if(r.ok){ location.reload(); return; } return r.text().then(function(){ var a=document.createElement('div'); a.className='alert alert-danger'; a.textContent='فشل الحذف'; document.body.appendChild(a); setTimeout(function(){ a.remove(); },6000); }); }); }
  var btnSel=document.getElementById('bulk_delete_selected_campaigns');
  var btnAll=document.getElementById('bulk_delete_all_campaigns');
  if(btnSel){ btnSel.addEventListener('click', function(){ var ids=[]; document.querySelectorAll('.campaign-select:checked').forEach(function(cb){ ids.push(cb.value); }); submitBulk(ids); }); }
  if(btnAll){ btnAll.addEventListener('click', function(){ if(!confirm('تأكيد حذف كل العناصر المعروضة؟')) return; submitBulk(collectVisibleIds()); }); }
});
</script>
{% endblock %}
