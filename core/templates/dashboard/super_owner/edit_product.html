{% extends 'base.html' %}
{% load static %}
{% load color_filters %}
{% load l10n %}

{% block title %}تعديل المنتج - {{ product.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-gradient-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-edit me-2"></i>
                            تعديل المنتج: {{ product.name }}
                        </h4>
                        <a href="{% url 'super_owner_products' %}" class="btn btn-light btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>
                            العودة للمنتجات
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    {% if request.GET.section == 'properties' %}
                    <div class="alert alert-info mb-3">هذه الصفحة مخصصة لإدارة الألوان والمقاسات وتوليد المتغيرات فقط.</div>
                    {% else %}
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_product">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">اسم المنتج *</label>
                                    <input type="text" class="form-control" id="name" name="name" value="{{ product.name }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="store" class="form-label">المتجر *</label>
                                    <select class="form-select" id="store" name="store" required>
                                        <option value="">اختر المتجر</option>
                                        {% for store in stores %}
                                            <option value="{{ store.id }}" {% if store.id == product.store.id %}selected{% endif %}>
                                                {{ store.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="category" class="form-label">الفئة *</label>
                                    <select class="form-select" id="category" name="category" required>
                                        <option value="">اختر الفئة</option>
                                        <option value="men" {% if product.category == 'men' %}selected{% endif %}>رجالي</option>
                                        <option value="women" {% if product.category == 'women' %}selected{% endif %}>نسائي</option>
                                        <option value="kids" {% if product.category == 'kids' %}selected{% endif %}>أطفال</option>
                                        <option value="sports" {% if product.category == 'sports' %}selected{% endif %}>رياضية</option>
                                        <option value="casual" {% if product.category == 'casual' %}selected{% endif %}>كاجوال</option>
                                        <option value="formal" {% if product.category == 'formal' %}selected{% endif %}>رسمية</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="size_type" class="form-label">نوع القياس *</label>
                                    <select class="form-select" id="size_type" name="size_type" required>
                                        <option value="symbolic" {% if size_type == 'symbolic' %}selected{% endif %}>رمزية (XS, S, M ...)</option>
                                        <option value="numeric" {% if size_type == 'numeric' %}selected{% endif %}>رقمية (38, 40, 42 ...)</option>
                                        <option value="none" {% if size_type == 'none' %}selected{% endif %}>بدون قياس</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="base_price" class="form-label">السعر الأساسي *</label>
                                    <input type="number" class="form-control" id="base_price" name="base_price" 
                                           value="{{ product.base_price|unlocalize }}" step="0.01" min="0" required>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="is_active" name="is_active" {% if product.is_active %}checked{% endif %}>
                                        <label class="form-check-label" for="is_active">
                                            المنتج نشط
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="is_featured" name="is_featured" {% if product.is_featured %}checked{% endif %}>
                                        <label class="form-check-label" for="is_featured">
                                            منتج مميز
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">الصور الحالية</label>
                                    {% if product.images.all %}
                                        <div class="row">
                                            {% for image in product.images.all %}
                                                <div class="col-md-4 mb-2">
                                                    <img src="{{ image.get_image_url }}" alt="{{ product.name }}" 
                                                         class="img-thumbnail" style="max-height: 100px;">
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <p class="text-muted">لا توجد صور للمنتج</p>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="new_images" class="form-label">إضافة صور جديدة</label>
                                    <input type="file" class="form-control" id="new_images" name="new_images" multiple accept="image/*">
                                    <small class="text-muted">يمكنك اختيار عدة صور في المرة الواحدة</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="description" class="form-label">وصف المنتج *</label>
                                    <textarea class="form-control" id="description" name="description" rows="4" required>{{ product.description }}</textarea>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <button type="submit" class="btn btn-info">
                                        <i class="fas fa-save me-2"></i>
                                        حفظ التغييرات
                                    </button>
                                    <a href="{% url 'super_owner_products' %}" class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>
                                        إلغاء
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>

                    <div class="d-flex justify-content-end mb-3">
                        <a href="?section=properties" class="btn btn-outline-primary"><i class="fas fa-palette me-1"></i>اذهب إلى خصائص المنتج</a>
                    </div>

                    {% endif %}

                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-gradient-info text-white">
                                        <h5 class="mb-0"><i class="fas fa-ruler-combined me-2"></i>خصائص المنتج</h5>
                                    </div>
                                    <div class="card-body">
                                        {% if request.GET.section != 'properties' %}
                                        <div class="alert alert-secondary">الألوان والمقاسات تُدار من صفحة الخصائص. استخدم الزر أعلاه للانتقال.</div>
                                        {% endif %}
                                        {% if request.GET.section == 'properties' %}
                                        <div class="mb-3 d-flex align-items-center gap-2">
                                            <form id="addColorForm" class="d-flex align-items-center gap-2" onsubmit="return false;">
                                                {% csrf_token %}
                                                <input type="text" name="color_name" class="form-control" placeholder="اسم اللون" style="max-width:220px;">
                                                <input type="color" name="color_code" class="form-control form-control-color" value="#000000">
                                                <button id="addColorBtn" class="btn btn-primary">إضافة لون</button>
                                            </form>
                                        </div>
                                        <script>
                                        (function(){
                                            var btn=document.getElementById('addColorBtn');
                                            if(btn){
                                                btn.addEventListener('click',async function(){
                                                    var f=document.getElementById('addColorForm');
                                                    var name=f.querySelector('[name=color_name]').value.trim();
                                                    var code=f.querySelector('[name=color_code]').value.trim();
                                                    if(!name){alert('يرجى إدخال اسم اللون');return;}
                                                    try{
                                                        var fd=new FormData();
                                                        var t=f.querySelector('input[name=csrfmiddlewaretoken]');
                                                        if(t){fd.append('csrfmiddlewaretoken',t.value);}    
                                                        fd.append('action','add_global_color');
                                                        fd.append('pid','{{ product.id }}');
                                                        fd.append('color_name',name);
                                                        fd.append('color_code',code);
                                                        await fetch('{% url "super_owner_add_product" %}',{method:'POST',body:fd,credentials:'same-origin'});
                                                        location.reload();
                                                    }catch(e){alert('تعذر إضافة اللون');}
                                                });
                                            }
                                            var form=document.getElementById('addColorForm');
                                            if(form){
                                                var picker=form.querySelector('input[name=color_code]');
                                                var nameInput=form.querySelector('input[name=color_name]');
                                                function hexToRgb(h){ return [parseInt(h.slice(1,3),16), parseInt(h.slice(3,5),16), parseInt(h.slice(5,7),16)]; }
                                                var palette=[
                                                    ['أسود','#000000'],['أبيض','#FFFFFF'],['أحمر','#FF0000'],['أخضر','#008000'],['أزرق','#0000FF'],
                                                    ['أصفر','#FFFF00'],['برتقالي','#FFA500'],['بنفسجي','#800080'],['نيلي','#4B0082'],['تركوازي','#40E0D0'],
                                                    ['كحلي','#000080'],['رمادي','#808080'],['زهري','#FFC0CB'],['بنّي','#8B4513'],['سماوي','#87CEEB']
                                                ].map(function(x){ return {name:x[0], rgb:hexToRgb(x[1])}; });
                                                function nearestName(hex){ var t=hexToRgb(hex); var best=null,bd=1e9; for(var i=0;i<palette.length;i++){ var p=palette[i]; var d=(t[0]-p.rgb[0])*(t[0]-p.rgb[0])+(t[1]-p.rgb[1])*(t[1]-p.rgb[1])+(t[2]-p.rgb[2])*(t[2]-p.rgb[2]); if(d<bd){ bd=d; best=p.name; } } return best; }
                                                var lastAuto='';
                                                function autofill(force){
                                                    if(!picker||!nameInput) return;
                                                    var hex=String(picker.value||'').toUpperCase();
                                                    var suggestion=nearestName(hex);
                                                    if(force || !nameInput.dataset.manual || nameInput.value===lastAuto || !nameInput.value){
                                                        nameInput.value=suggestion;
                                                        lastAuto=suggestion;
                                                        nameInput.dataset.manual='';
                                                    } else {
                                                        nameInput.setAttribute('placeholder', suggestion);
                                                    }
                                                }
                                                if(picker){ picker.addEventListener('input',function(){autofill(false);}); picker.addEventListener('change',function(){autofill(true);}); }
                                                if(nameInput){ nameInput.addEventListener('input',function(){ this.dataset.manual='true'; }); }
                                            }
                                        })();
                                        </script>

                                        <div class="accordion" id="variantsAccordion">
                                            <div class="accordion-item">
                                                <h2 class="accordion-header" id="headingSel">
                                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSel" aria-expanded="true" aria-controls="collapseSel">توليد بحسب الاختيار هنا</button>
                                                </h2>
                                                <div id="collapseSel" class="accordion-collapse collapse show" data-bs-parent="#variantsAccordion">
                                                    <div class="accordion-body">
                                                        <form method="post" class="mb-3">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="action" value="edit_generate_variants">
                                                            <div class="row g-3" id="attrControls">
                                                                <div class="col-md-6">
                                                                    <label class="form-label">الألوان</label>
                                                                    <div class="color-chips">
                                                                        {% for c in color_attrs %}
                                                                        <div class="chip-wrap">
                                                                            <div class="color-chip">
                                                                                <div class="chip-center">
                                                                                    <div class="color-preview" style="background-color: {{ c|color_code }}"></div>
                                                                                    <label class="chip-name" for="color-attr-{{ c.id }}">{{ c.name }}</label>
                                                                                </div>
                                                                                <div class="chip-select"><input id="color-attr-{{ c.id }}" class="form-check-input" type="checkbox" name="color_attr_ids" value="{{ c.id }}" {% if c.id in existing_color_attr_ids %}checked{% endif %}></div>
                                                                            </div>
                                                                            <span class="chip-actions">
                                                                                <button class="icon-btn" type="button" data-delete="color" data-id="{{ c.id }}" title="حذف">
                                                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                                        <polyline points="3 6 5 6 21 6"></polyline>
                                                                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                                                                                        <path d="M10 11v6"></path>
                                                                                        <path d="M14 11v6"></path>
                                                                                        <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
                                                                                    </svg>
                                                                                </button>
                                                                            </span>
                                                                        </div>
                                                                        {% endfor %}
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <label class="form-label">المقاسات</label>
                                                                    <div class="sizes-grid">
                                                                        {% for s in size_attrs %}
                                                                        <div class="size-wrap">
                                                                            <div class="size-option">
                                                                                <label class="size-label" for="size-{{ s.id }}">{{ s.name }}</label>
                                                                                <div class="size-select"><input id="size-{{ s.id }}" class="form-check-input" type="checkbox" name="size_attr_ids" value="{{ s.id }}" {% if s.id in existing_size_attr_ids %}checked{% endif %}></div>
                                                                            </div>
                                                                            <span class="chip-actions">
                                                                                <button class="icon-btn" type="button" data-delete="size" data-id="{{ s.id }}" title="حذف">
                                                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                                        <polyline points="3 6 5 6 21 6"></polyline>
                                                                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                                                                                        <path d="M10 11v6"></path>
                                                                                        <path d="M14 11v6"></path>
                                                                                        <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
                                                                                    </svg>
                                                                                </button>
                                                                            </span>
                                                                        </div>
                                                                        {% endfor %}
                                                                    </div>
                                                                </div>
                                                                    <div class="mt-3 d-flex align-items-center gap-2" id="addSizeControls">
                                                                        <input type="text" id="addSizeName" class="form-control" placeholder="إضافة قياس" style="max-width:220px;">
                                                                        <button type="button" id="addSizeBtn" class="btn btn-outline-primary">إضافة قياس</button>
                                                                    </div>
                                                                <div class="col-md-3"><label class="form-label">كمية افتراضية</label><input type="number" name="default_qty" class="form-control" min="0" value="0"></div>
                                                                <div class="col-md-3"><label class="form-label">سعر خاص افتراضي</label><input type="number" name="default_price" class="form-control" step="0.01" min="0"></div>
                                                                <div class="col-md-3 d-flex align-items-end"><div class="form-check"><input type="checkbox" class="form-check-input" id="enable_all" name="enable_all"><label class="form-check-label" for="enable_all">تفعيل الكل</label></div></div>
                                                                <div class="col-md-3 d-flex align-items-end justify-content-end"><button class="btn btn-success"><i class="fas fa-save me-1"></i>حفظ</button></div>
                                                            </div>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="accordion-item">
                                                <h2 class="accordion-header" id="headingAuto">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAuto" aria-expanded="false" aria-controls="collapseAuto">توليد تلقائي من خصائص المنتج</button>
                                                </h2>
                                                <div id="collapseAuto" class="accordion-collapse collapse" data-bs-parent="#variantsAccordion">
                                                    <div class="accordion-body">
                                                        <form method="post" class="mb-3">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="action" value="edit_generate_from_product">
                                                            <div class="row g-3">
                                                                <div class="col-md-3"><label class="form-label">كمية افتراضية</label><input type="number" name="default_qty" class="form-control" min="0" value="0"></div>
                                                                <div class="col-md-3"><label class="form-label">سعر خاص افتراضي</label><input type="number" name="default_price" class="form-control" step="0.01" min="0"></div>
                                                                <div class="col-md-3 d-flex align-items-end"><div class="form-check"><input type="checkbox" class="form-check-input" id="enable_all2" name="enable_all"><label class="form-check-label" for="enable_all2">تفعيل الكل</label></div></div>
                                                                <div class="col-md-3 d-flex align-items-end justify-content-end"><button class="btn btn-info"><i class="fas fa-bolt me-1"></i>توليد من ألوان ومقاسات المنتج</button></div>
                                                            </div>
                                                            <small class="text-muted">التوليد يضيف المتغيرات الناقصة فقط.</small>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.bg-gradient-info {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
}

.form-control:focus, .form-select:focus {
    border-color: #17a2b8;
    box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
}

.btn-info {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    border: none;
    padding: 10px 30px;
    color: white;
}

.btn-info:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(23, 162, 184, 0.4);
    color: white;
}
.color-chips{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem}
.color-chip{display:flex;align-items:center;justify-content:center;border:1px solid #e0e0e0;border-radius:.6rem;padding:.6rem .8rem;position:relative;background:#fff;min-height:44px}
.chip-center{display:flex;align-items:center;gap:.6rem}
.color-preview{width:26px;height:26px;border-radius:.3rem;border:1px solid #ddd}
.chip-name{font-size:1rem;font-weight:500;color:#212529;text-align:center}
.chip-select{position:absolute;top:.35rem;left:.35rem}
.chip-wrap,.size-wrap{position:relative;margin-right:12px}
.chip-actions{position:absolute;top:.35rem;right:-10px;z-index:2}
.color-chips,.sizes-grid{overflow:visible}
.icon-btn:hover{color:#a71d2a}
.icon-btn svg{width:18px;height:18px}
.sizes-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:.75rem}
.size-option{display:flex;align-items:center;gap:.7rem;border:1px solid #e0e0e0;border-radius:.6rem;padding:.6rem .9rem;background:#fff;position:relative;min-height:44px}
.size-label{flex:1;text-align:center;padding-right:20px}
.size-label{font-size:1rem;color:#212529}
.color-chip .form-check-input,.size-option .form-check-input{transform:scale(1.2);transform-origin:center;}
.color-chip .form-check-input{margin-left:.1rem}
.size-option .form-check-input{margin-left:.1rem}
</style>

<script>
(function(){
  try{
    function getCookie(name){
      var v=document.cookie.match('(^|; )'+name+'=([^;]*)');
      return v?decodeURIComponent(v[2]):'';
    }
    document.querySelectorAll('form[data-ajax="true"]').forEach(function(f){
      f.addEventListener('submit',async function(e){
        e.preventDefault();
        try{
          var fd=new FormData(f);
          await fetch(window.location.href,{method:'POST',body:fd,credentials:'same-origin',headers:{'X-CSRFToken':getCookie('csrftoken')}});
          location.reload();
        }catch(err){
          alert('حدث خطأ أثناء التنفيذ');
        }
      });
    });
    var tokenEl=document.querySelector('input[name=csrfmiddlewaretoken]');
    var csrf=(tokenEl?tokenEl.value:'');
    document.querySelectorAll('[data-delete]').forEach(function(btn){
      btn.addEventListener('click',async function(ev){
        ev.preventDefault(); ev.stopPropagation();
        try{
          var t=this.getAttribute('data-delete');
          var id=this.getAttribute('data-id');
          if(!id) return;
          var ok=confirm(t==='color'?'حذف اللون؟':'حذف القياس؟');
          if(!ok) return;
          var fd=new FormData();
          if(csrf) fd.append('csrfmiddlewaretoken',csrf);
          if(t==='color'){ fd.append('action','delete_attribute_color'); fd.append('color_id',id); }
          else { fd.append('action','delete_attribute_size'); fd.append('size_id',id); }
          await fetch(window.location.href,{method:'POST',body:fd,credentials:'same-origin',headers:{'X-CSRFToken':getCookie('csrftoken')}});
          var wrap=this.closest('.chip-wrap, .size-wrap');
          if(wrap){ wrap.remove(); }
        }catch(err){ alert('تعذر تنفيذ الحذف'); }
      });
    });
    var attr=document.getElementById('attrControls');
    if(attr){
      // Prevent bubbling from checkboxes to parent form
      attr.querySelectorAll('.form-check-input').forEach(function(cb){
        cb.addEventListener('click',function(e){ e.stopPropagation(); }, true);
        cb.addEventListener('change',function(e){ e.stopPropagation(); }, true);
      });
      // Ensure only explicit save submits the form
      var genForm=attr.closest('form');
      var formEl=document.querySelector('input[name="action"][value="edit_generate_variants"]');
      if(formEl){ genForm=formEl.closest('form'); }
      if(genForm){
        genForm.addEventListener('submit',function(e){
          var sub=e.submitter;
          if(!sub || !sub.matches('.btn-success')){ e.preventDefault(); e.stopPropagation(); }
        });
      }
    }
    var addBtn=document.getElementById('addSizeBtn');
    var addName=document.getElementById('addSizeName');
    if(addBtn && addName){
      addBtn.addEventListener('click',async function(e){
        e.preventDefault(); e.stopPropagation();
        var name=(addName.value||'').trim();
        if(!name){ addName.focus(); return; }
        var fd=new FormData();
        if(csrf) fd.append('csrfmiddlewaretoken',csrf);
        fd.append('action','add_attribute_size');
        fd.append('size_name',name);
        await fetch(window.location.href,{method:'POST',body:fd,credentials:'same-origin',headers:{'X-CSRFToken':getCookie('csrftoken')}});
        location.reload();
      });
    }
  }catch(e){}
})();
</script>
{% endblock %}
