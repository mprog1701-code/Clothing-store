{% extends 'base.html' %}
{% load math_filters %}

{% block title %}{{ product.name }} - متجر الملابس{% endblock %}

{% block content %}
<!-- PD_UI_V2 | core/templates/products/detail.html | 2026-02-07 -->
<style>
    .product-hero {
        background: linear-gradient(135deg, var(--copper) 0%, var(--copper-dark) 100%);
    }
    .product-gallery-card img { height: 420px; object-fit: cover; }
    .product-info-card { min-height: 420px; }
    .price-old { text-decoration: line-through; color: #888; font-size: 1.25rem; }
    .price-new { color: var(--gold); font-weight: 800; font-size: 2rem; }
    .variant-card { border-color: rgba(0,0,0,0.08); }
    .add-to-cart-form .btn { border-radius: 12px; }
    .product-description p { line-height: 1.9; }
    .product-category .badge { background: linear-gradient(45deg, #667eea, #764ba2); }
    .store-info-section { border: 1px dashed rgba(0,0,0,0.1); }
    .swatch { width: 44px; height: 44px; border-radius: 8px; border: 2px solid transparent; box-shadow: 0 0 0 1px rgba(0,0,0,0.08); cursor: pointer; }
    .swatch.selected { border-color: #111; outline: 2px solid var(--gold); }
    .size-btn { min-width: 56px; height: 40px; border: 1px solid #ddd; border-radius: 8px; background: #fff; cursor: pointer; padding: 0 12px; }
    .size-btn.disabled { opacity: 0.5; cursor: not-allowed; }
    .size-btn.selected { border-color: var(--gold); background: #fff7e6; font-weight: 700; }
</style>
<!-- Hero Section -->
<section class="product-hero bg-gradient-primary py-5 mb-5">
    <div class="container">
        <div class="d-flex justify-content-end mb-2">
            <span class="badge bg-dark text-white">PD_V1_SIMPLE_{% now "Y-m-d" %}</span>
        </div>
        <div class="row align-items-center">
            <div class="col-lg-8">
                <nav aria-label="breadcrumb" class="mb-4">
                    <ol class="breadcrumb breadcrumb-light">
                        <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-light">الرئيسية</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'store_list' %}" class="text-light">المتاجر</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'store_detail' product.store.id %}" class="text-light">{{ product.store.name }}</a></li>
                        <li class="breadcrumb-item active text-light-50">{{ product.name }}</li>
                    </ol>
                </nav>
                <h1 class="display-4 fw-bold text-white mb-3 animate-fade-in">
                    {{ product.name }}
                </h1>
                <p class="lead text-light mb-4 animate-fade-in-delay">
                    من <a href="{% url 'store_detail' product.store.id %}" class="text-white fw-bold">{{ product.store.name }}</a>
                </p>
            </div>
            <div class="col-lg-4 text-center">
                <div class="product-hero-icon animate-bounce">
                    <i class="bi bi-bag-heart display-1 text-white opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Product Details Section -->
<section class="product-details-section mb-5">
    <div class="container">
        <div class="row g-5">
            <!-- Product Images -->
            <div class="col-lg-6">
                <div class="product-gallery-card p-4 bg-white rounded-4 shadow-lg">
                    <div class="rounded-3 overflow-hidden">
                        <img id="pdMain" src="{{ default_main_image_url }}" alt="{{ product.name }}" class="w-100" style="height: 500px; object-fit: cover;" onerror="this.onerror=null;this.src='{{ placeholder_image_url }}'">
                    </div>
                    <div id="pdThumbs" class="mt-3 d-flex flex-wrap gap-2"></div>
                </div>
            </div>
            
            <!-- Product Info -->
            <div class="col-lg-6">
                <div class="product-info-card p-5 bg-white rounded-4 shadow-lg">
                    <!-- Price and Category -->
                    <div class="product-header mb-4">
                        <div class="product-category mb-3">
                            <span class="badge bg-primary-gradient text-white px-4 py-2 fs-6">
                                <i class="bi bi-tag me-2"></i>
                                {{ product.get_category_display }}
                            </span>
                        </div>
                        <div class="product-price mb-3">
                            {% if product.discount_price %}
                                <div class="d-flex align-items-baseline gap-3">
                                    <span class="price-old">{{ product.base_price|iqd }}</span>
                                    <span class="price-new">{{ product.discount_price|iqd }}</span>
                                </div>
                            {% else %}
                                <span class="price-new">{{ product.base_price|iqd }}</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Description -->
                    {% if product.description %}
                    <div class="product-description mb-5">
                        <h5 class="fw-bold mb-3 text-gradient">
                            <i class="bi bi-info-circle me-2"></i>
                            وصف المنتج
                        </h5>
                        <p class="lead text-muted">{{ product.description }}</p>
                    </div>
                    {% endif %}
                    
                    <!-- Variants -->
                    <div class="product-variants mb-5">
                        <h5 class="fw-bold mb-4 text-gradient">
                            <i class="bi bi-palette me-2"></i>
                            اختر اللون والمقاس
                        </h5>
                        <div class="mb-3">
                            <span class="badge bg-light text-dark">لون: <span id="selColor">غير محدد</span></span>
                            <span class="badge bg-light text-dark ms-2">قياس: <span id="selSize">غير محدد</span></span>
                        </div>
                        <form method="post" action="{% url 'cart_items_json' %}" class="add-to-cart-form" id="variantPickerForm">
                            {% csrf_token %}
                            <input type="hidden" name="productId" value="{{ product.id }}">
                            <input type="hidden" name="storeId" value="{{ product.store.id }}">
                            <input type="hidden" name="variantId" id="selectedVariantId">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold"><i class="bi bi-palette me-2"></i>اللون</label>
                                    <div id="pdSwatches" class="d-flex flex-wrap gap-2"></div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold"><i class="bi bi-rulers me-2"></i>المقاس</label>
                                    <div id="pdSizes" class="d-flex flex-wrap gap-2" style="display:none;"></div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">الكمية</label>
                                    <input type="number" class="form-control" name="quantity" id="qtyInput" value="1" min="1" style="width: 120px;">
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div id="stockInfo" class="text-muted"></div>
                                </div>
                                <div class="col-md-6 text-end">
                                    <div id="variantPrice" class="h5 text-primary fw-bold"></div>
                                </div>
                            </div>
                            <div class="mt-3" id="pdAddBtn">
                                <button type="submit" class="btn btn-gradient btn-lg w-100" id="addToCartBtn" disabled>
                                    <i class="bi bi-cart-plus me-2"></i>
                                    أضف للسلة
                                </button>
                                <div id="inlineMsg" class="text-danger mt-2" style="display:none;">يرجى اختيار اللون والمقاس قبل الإضافة إلى السلة</div>
                            </div>
                        </form>
                        <script type="application/json" id="variant-data">{{ variant_data|safe }}</script>
                        <script type="application/json" id="sizes-data">{{ sizes_by_color|safe }}</script>
                        <script type="application/json" id="images-data">{{ images_by_color|safe }}</script>
                        <script type="application/json" id="colors-data">{{ available_colors|safe }}</script>
                        <script>
                            const VARIANTS = JSON.parse(document.getElementById('variant-data').textContent || '[]');
                            const SIZES_BY_COLOR = JSON.parse(document.getElementById('sizes-data').textContent || '{}');
                            const IMAGES_BY_COLOR = JSON.parse(document.getElementById('images-data').textContent || '{}');
                            const AVAILABLE_COLORS = JSON.parse(document.getElementById('colors-data').textContent || '[]');
                            const DEFAULT_COLOR = {{ default_color|default:'null'|safe }};
                            const DEFAULT_MAIN_IMAGE = '{{ default_main_image_url }}';
                                console.log('pd:init:data', {variantsLen: VARIANTS.length, colorsLen: AVAILABLE_COLORS.length, sizesKeys: Object.keys(SIZES_BY_COLOR), defaultColor: DEFAULT_COLOR});
                            const swatchesEl = document.getElementById('pdSwatches');
                            const sizesEl = document.getElementById('pdSizes');
                            const selColor = document.getElementById('selColor');
                            const selSize = document.getElementById('selSize');
                            const qtyInput = document.getElementById('qtyInput');
                            const stockInfo = document.getElementById('stockInfo');
                            const variantPrice = document.getElementById('variantPrice');
                            const addBtn = document.getElementById('addToCartBtn');
                            const hiddenVariantId = document.getElementById('selectedVariantId');
                            const pdMain = document.getElementById('pdMain');
                            const pdThumbs = document.getElementById('pdThumbs');
                            const inlineMsg = document.getElementById('inlineMsg');
                            const REQUIRES_SIZE = '{{ product.size_type }}' !== 'none';
                            const REQUIRED_MSG = REQUIRES_SIZE ? 'يرجى اختيار اللون والمقاس قبل الإضافة إلى السلة' : 'يرجى اختيار اللون قبل الإضافة إلى السلة';
                            inlineMsg.textContent = REQUIRED_MSG;
                            let selectedColor = null;
                            let selectedSize = null;

                            function renderColorSwatches(){
                                console.log('pd:renderColorSwatches:start', {availableColors: AVAILABLE_COLORS});
                                swatchesEl.innerHTML = '';
                                AVAILABLE_COLORS.forEach(c => {
                                    const sw = document.createElement('button');
                                    sw.type = 'button';
                                    sw.className = 'swatch';
                                    sw.setAttribute('title', c.name);
                                    sw.setAttribute('aria-label', c.name);
                                    sw.setAttribute('data-color', c.name);
                                    const hex = (c.hex || '').trim();
                                    if (hex) sw.style.backgroundColor = hex;
                                    else sw.style.background = 'linear-gradient(45deg,#999,#bbb)';
                                    if (selectedColor && selectedColor === c.name) sw.classList.add('selected');
                                    sw.addEventListener('click', function(){ selectColor(c.name); });
                                    swatchesEl.appendChild(sw);
                                });
                                console.log('pd:renderColorSwatches:end', {count: (AVAILABLE_COLORS || []).length});
                            }
                            function updateGallery(color){
                                const list = (color && IMAGES_BY_COLOR[color] && IMAGES_BY_COLOR[color].length > 0) ? IMAGES_BY_COLOR[color] : (IMAGES_BY_COLOR['__default__'] || []);
                                const limited = (list || []).slice(0, 3);
                                console.log('pd:updateGallery', {color, urlsLen: limited.length});
                                const first = limited.length ? limited[0] : DEFAULT_MAIN_IMAGE;
                                pdMain.src = first;
                                pdThumbs.innerHTML = '';
                                if (limited.length > 1) {
                                    limited.forEach(function(u){
                                        const t = document.createElement('img');
                                        t.src = u;
                                        t.alt = '{{ product.name }}';
                                        t.style.cssText = 'width:72px;height:72px;object-fit:cover;border-radius:8px;cursor:pointer;border:1px solid #eee;';
                                        t.addEventListener('click', function(){ pdMain.src = u; });
                                        pdThumbs.appendChild(t);
                                    });
                                }
                            }
                            function resetSize(){
                                console.log('pd:resetSize');
                                sizesEl.innerHTML = '';
                                sizesEl.style.display = 'none';
                                hiddenVariantId.value = '';
                                addBtn.disabled = true;
                                inlineMsg.style.display = 'block';
                                stockInfo.textContent = '';
                                variantPrice.textContent = '';
                                qtyInput.value = 1;
                                qtyInput.removeAttribute('max');
                                selectedSize = null;
                                selSize.textContent = 'غير محدد';
                            }
                            function selectColor(color){
                                resetSize();
                                const sizes = SIZES_BY_COLOR[color] || [];
                                console.log('pd:selectColor', {color, sizesLen: sizes.length});
                                let availableCount = 0;
                                // mark selected color
                                selectedColor = color;
                                Array.from(swatchesEl.children || []).forEach(el => {
                                    el.classList.toggle('selected', el.getAttribute('data-color') === color);
                                });
                                // build size buttons
                                sizes.forEach(s => {
                                    const v = VARIANTS.find(x => x.color === color && x.size === s);
                                    const out = !v || v.stock_qty <= 0;
                                    const b = document.createElement('button');
                                    b.type = 'button';
                                    b.className = 'size-btn' + (out ? ' disabled' : '');
                                    b.textContent = s;
                                    b.setAttribute('data-size', s);
                                    if (!out) availableCount++;
                                    if (!out) {
                                        b.addEventListener('click', function(){ selectSize(color, s); });
                                    }
                                    sizesEl.appendChild(b);
                                });
                                sizesEl.style.display = sizes.length > 0 ? '' : 'none';
                                updateGallery(color);
                                stockInfo.textContent = (sizes.length > 0 && availableCount === 0) ? 'هذا اللون غير متوفر' : '';
                                selColor.textContent = color || 'غير محدد';
                                selSize.textContent = 'غير محدد';
                                const firstAvail = VARIANTS.find(x => x.color === color && x.stock_qty > 0);
                                if (firstAvail){ selectSize(color, firstAvail.size); }
                                inlineMsg.style.display = addBtn.disabled ? 'block' : 'none';
                            }

                            function selectSize(color, size){
                                selectedSize = size;
                                console.log('pd:selectSize:start', {color, size});
                                Array.from(sizesEl.children || []).forEach(el => {
                                    el.classList.toggle('selected', el.getAttribute('data-size') === size);
                                });
                                const v = VARIANTS.find(x => x.color === (color || '') && x.size === size);
                                if (!v){
                                    console.log('pd:selectSize:notFound', {color, size});
                                    hiddenVariantId.value = '';
                                    addBtn.disabled = true;
                                    stockInfo.textContent = '';
                                    variantPrice.textContent = '';
                                    qtyInput.value = 1;
                                    qtyInput.removeAttribute('max');
                                    selSize.textContent = size || 'غير محدد';
                                    return;
                                }
                                console.log('pd:selectSize:found', {id: v.id, stock_qty: v.stock_qty, price: v.price});
                                hiddenVariantId.value = v.id;
                                addBtn.disabled = v.stock_qty <= 0;
                                stockInfo.textContent = v.stock_qty > 0 ? `متاح (${v.stock_qty} قطعة)` : 'هذا القياس غير متوفر';
                                qtyInput.value = 1;
                                qtyInput.max = v.stock_qty > 0 ? v.stock_qty : 1;
                                variantPrice.textContent = `${v.price.toLocaleString('ar-IQ')} دينار`;
                                selColor.textContent = color || 'غير محدد';
                                selSize.textContent = size || 'غير محدد';
                                inlineMsg.style.display = addBtn.disabled ? 'block' : 'none';
                            }

                            function initPage(){
                                console.log('pd:initPage:start');
                                renderColorSwatches();
                                updateGallery(DEFAULT_COLOR);
                                if (Array.isArray(VARIANTS) && VARIANTS.length > 0){
                                    const hasColors = Array.isArray(AVAILABLE_COLORS) && AVAILABLE_COLORS.length > 0;
                                    const initialColor = DEFAULT_COLOR || (hasColors && AVAILABLE_COLORS[0] ? AVAILABLE_COLORS[0].name : null);
                                    console.log('pd:initPage:variants', {hasColors, initialColor});
                                    if (initialColor) {
                                        selectColor(initialColor);
                                    } else {
                                        const nocSizes = SIZES_BY_COLOR['__no_color__'] || Array.from(new Set(VARIANTS.map(x => x.size)));
                                        sizesEl.innerHTML = '';
                                        nocSizes.forEach(s => {
                                            const v = VARIANTS.find(x => (x.color || '') === '' && x.size === s) || VARIANTS.find(x => x.size === s);
                                            const out = !v || v.stock_qty <= 0;
                                            const b = document.createElement('button');
                                            b.type = 'button';
                                            b.className = 'size-btn' + (out ? ' disabled' : '');
                                            b.textContent = s;
                                            b.setAttribute('data-size', s);
                                            if (!out) {
                                                b.addEventListener('click', function(){ selectSize('', s); });
                                            }
                                            sizesEl.appendChild(b);
                                        });
                                        sizesEl.style.display = nocSizes.length > 0 ? '' : 'none';
                                        selColor.textContent = 'غير محدد';
                                        selSize.textContent = 'غير محدد';
                                        hiddenVariantId.value = '';
                                        addBtn.disabled = true;
                                        inlineMsg.style.display = 'none';
                                        console.log('pd:initPage:noColor', {sizesLen: nocSizes.length});
                                    }
                                } else {
                                    hiddenVariantId.value = '';
                                    addBtn.disabled = false;
                                    stockInfo.textContent = '';
                                    variantPrice.textContent = `${parseFloat({{ product.discount_price|default:product.base_price }}).toLocaleString('ar-IQ')} دينار`;
                                    inlineMsg.style.display = 'none';
                                    console.log('pd:initPage:noVariants');
                                }
                            }
                            document.getElementById('variantPickerForm').addEventListener('submit', function(e){
                                if (Array.isArray(VARIANTS) && VARIANTS.length > 0 && !hiddenVariantId.value){
                                    e.preventDefault();
                                    console.log('pd:submit:blocked', {variantId: hiddenVariantId.value});
                                    inlineMsg.style.display = 'block';
                                }
                                console.log('pd:submit:ok', {variantId: hiddenVariantId.value});
                            });

                                // Initialize default selection on page load if variants exist
                            document.addEventListener('DOMContentLoaded', initPage);
                        </script>
                        <script></script>
                </div>
                    
                    <!-- Store Info -->
                    <div class="store-info-section p-4 bg-light rounded-3">
                        <h6 class="fw-bold mb-3 text-gradient">
                            <i class="bi bi-shop me-2"></i>
                            متجر: {{ product.store.name }}
                        </h6>
                        <p class="text-muted mb-2">
                            <i class="bi bi-geo-alt me-2"></i>
                            {{ product.store.city }} - {{ product.store.address }}
                        </p>
                        <a href="{% url 'store_detail' product.store.id %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-shop-window me-2"></i>
                            زيارة المتجر
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Similar Products -->
<section class="mb-5">
    <div class="container">
        {% if similar_products or same_store_products %}
        <h4 class="fw-bold mb-3">منتجات مشابهة</h4>
        <div class="row g-3">
            {% if similar_products %}
                {% for p in similar_products|slice:"8" %}
                <div class="col-6 col-md-3">
                    <a href="{% url 'product_detail' p.id %}" class="card h-100 text-decoration-none">
                        <div class="ratio ratio-1x1">
                            {% with img=p.images.all|first %}
                                {% if img %}
                                    <img src="{{ img.get_image_url }}" alt="{{ p.name }}" class="card-img-top" onerror="this.onerror=null;this.src='{{ placeholder_image_url }}'">
                                {% else %}
                                    <img src="{{ placeholder_image_url }}" alt="{{ p.name }}" class="card-img-top">
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="card-body">
                            <div class="small text-muted">{{ p.store.name }}</div>
                            <div class="fw-semibold">{{ p.name }}</div>
                            <div class="text-primary">{{ p.discount_price|default:p.base_price|iqd }}</div>
                        </div>
                    </a>
                </div>
                {% endfor %}
            {% elif same_store_products %}
                {% for p in same_store_products|slice:"8" %}
                <div class="col-6 col-md-3">
                    <a href="{% url 'product_detail' p.id %}" class="card h-100 text-decoration-none">
                        <div class="ratio ratio-1x1">
                            {% with img=p.images.all|first %}
                                {% if img %}
                                    <img src="{{ img.get_image_url }}" alt="{{ p.name }}" class="card-img-top" onerror="this.onerror=null;this.src='{{ placeholder_image_url }}'">
                                {% else %}
                                    <img src="{{ placeholder_image_url }}" alt="{{ p.name }}" class="card-img-top">
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="card-body">
                            <div class="small text-muted">{{ p.store.name }}</div>
                            <div class="fw-semibold">{{ p.name }}</div>
                            <div class="text-primary">{{ p.discount_price|default:p.base_price|iqd }}</div>
                        </div>
                    </a>
                </div>
                {% endfor %}
            {% endif %}
        </div>
        {% endif %}
        {% if similar_products and same_store_products %}
        <h5 class="fw-bold mt-4 mb-3">منتجات من نفس المتجر</h5>
        <div class="row g-3">
            {% for p in same_store_products %}
            <div class="col-6 col-md-3">
                <a href="{% url 'product_detail' p.id %}" class="card h-100 text-decoration-none">
                    <div class="ratio ratio-1x1">
                        {% with img=p.images.all|first %}
                            {% if img %}
                                <img src="{{ img.get_image_url }}" alt="{{ p.name }}" class="card-img-top" onerror="this.onerror=null;this.src='{{ placeholder_image_url }}'">
                            {% else %}
                                <img src="{{ placeholder_image_url }}" alt="{{ p.name }}" class="card-img-top">
                            {% endif %}
                        {% endwith %}
                    </div>
                    <div class="card-body">
                        <div class="small text-muted">{{ p.store.name }}</div>
                        <div class="fw-semibold">{{ p.name }}</div>
                        <div class="text-primary">{{ p.discount_price|default:p.base_price|iqd }}</div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
</section>
{% endblock %}
