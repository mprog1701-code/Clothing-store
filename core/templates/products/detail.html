{% extends 'base.html' %}
{% load math_filters %}

{% block title %}{{ product.name }} - متجر الملابس{% endblock %}

{% block content %}
<!-- PD_UI_V2 | core/templates/products/detail.html | 2026-02-07 -->
<style>
  .pdWrap{display:flex;flex-direction:row;gap:16px;background:#ffffff;padding:16px}
  @media (max-width:768px){.pdWrap{flex-direction:column}}
  .pdMedia{flex:1;background:#ffffff}
  .pdInfo{flex:1;background:#ffffff}
  #pdMain{width:100%;height:auto;background:#ffffff}
  #pdThumbs{display:flex;gap:8px;flex-wrap:wrap;background:#ffffff;margin-top:8px}
  .thumb{width:72px;height:72px;border:1px solid #e5e7eb;background:#ffffff;transition:all 0.2s ease}
  .thumb.selected{border:2px solid #ff6a00 !important}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .title{font-size:22px;font-weight:700;margin-bottom:8px}
  .price{display:flex;gap:12px;align-items:baseline;margin:8px 0}
  .price-new{font-size:20px;font-weight:800}
  .price-old{font-size:14px;color:#888;text-decoration:line-through}
  .fit{border:1px solid #e5e7eb;background:#ffffff;border-radius:8px;padding:10px;margin:8px 0;font-size:14px}
  .sizes{display:flex;gap:8px;flex-wrap:wrap;background:#ffffff}
  .sz{min-width:52px;padding:10px 12px;border:2px solid #000;border-radius:10px;background:#ffffff;font-weight:700}
  .sz:disabled{opacity:.5;cursor:not-allowed}
  .btn{padding:12px 18px;border:2px solid #000;border-radius:10px;background:#ffffff;font-weight:700}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .product-hero{display:none}
  .product-details-section{display:none}
  section.mb-5{display:none}
  .modal{display:none}
  .pdWrap, .pdMedia, .pdInfo, .title, .fit, .price-new, .sz, .btn{color:#1a1a1a}
  #addBtn{background:#ff6a00;color:#ffffff;border-color:#ff6a00}
  #addBtn:hover{filter:brightness(0.95)}
  .thumb{cursor:pointer}
  .related-wrap{margin:24px 16px;background:#ffffff}
  .related-wrap, .related-wrap *{color:#000000 !important;background-color:#ffffff !important}
  .relTitle{font-size:18px;font-weight:800;color:#1a1a1a;margin-bottom:8px}
  .relList{display:flex;gap:12px;flex-wrap:wrap}
  .relCard{display:block;width:180px;border:1px solid #e5e7eb;border-radius:10px;background:#ffffff;text-decoration:none;color:#000000 !important}
  .relImg{width:100%;height:160px;background:#ffffff;border-bottom:1px solid #e5e7eb}
  .relImg img{width:100%;height:100%;object-fit:cover}
  .relBody{padding:10px;background:#ffffff}
  .relStore{font-size:12px;color:#000000 !important}
  .relName{font-size:13px;color:#000000 !important;margin:4px 0;height:34px;overflow:hidden}
  .relPrice{font-size:14px;font-weight:800;color:#000000 !important}
</style>
<div class="pdWrap">
  <div class="pdMedia">
    {% if primary_video_url %}
    <video id="pdVideo" src="{{ primary_video_url }}" controls playsinline style="width:100%;height:auto;background:#ffffff"></video>
    {% endif %}
    <img id="pdMain" src="{{ default_main_image_url }}" alt="{{ product.name }}" onerror="this.onerror=null;this.src='{{ placeholder_image_url }}'">
    <div id="pdThumbs">
      {% if images_by_color %}
        {% for img in product.images.all %}
        <button type="button" class="thumb" data-src="{{ img.get_image_url }}">
          <img src="{{ img.get_image_url }}" alt="{{ product.name }}" onerror="this.onerror=null;this.src='{{ placeholder_image_url }}'">
        </button>
        {% endfor %}
      {% else %}
        {% for img in product.images.all %}
        <button type="button" class="thumb" data-src="{{ img.get_image_url }}">
          <img src="{{ img.get_image_url }}" alt="{{ product.name }}" onerror="this.onerror=null;this.src='{{ placeholder_image_url }}'">
        </button>
        {% endfor %}
      {% endif %}
    </div>
  </div>
  <div class="pdInfo">
    <div class="title">{{ product.name }}</div>
    <div class="price">
      {% if product.discount_price %}
        <span class="price-old">{{ product.base_price|iqd }}</span>
        <span class="price-new">{{ product.discount_price|iqd }}</span>
      {% else %}
        <span class="price-new">{{ product.base_price|iqd }}</span>
      {% endif %}
    </div>
    {% if fit_advice %}
    <div class="fit">{{ fit_advice }}</div>
    {% endif %}
    <form method="post" action="{% url 'cart_items_json' %}">
      {% csrf_token %}
      <input type="hidden" name="productId" value="{{ product.id }}">
      <input type="hidden" name="storeId" value="{{ product.store.id }}">
      <input type="hidden" name="variantId" id="variantId">
      <input type="hidden" name="quantity" id="qty" value="1">
      <div class="sizes" id="sizes">
        {% regroup variants by size as size_groups %}
        {% for g in size_groups %}
          <button type="button" class="sz" data-size="{{ g.grouper }}">{{ g.grouper }}</button>
        {% endfor %}
      </div>
      <div style="margin-top:12px"><button class="btn" id="addBtn">أضف للسلة</button></div>
    </form>
  </div>
</div>
{% if similar_products %}
<section class="related-wrap">
  <div class="relTitle">متوفر في متاجر أخرى بأسعار مختلفة</div>
  <div class="relList">
    {% for p in similar_products %}
    <a href="{% url 'product_detail' p.id %}" class="relCard">
      <div class="relImg">
        {% with img=p.images.all|first %}
          {% if img %}
            <img src="{{ img.get_image_url }}" alt="{{ p.name }}" onerror="this.onerror=null;this.src='{{ placeholder_image_url }}'">
          {% else %}
            <img src="{{ placeholder_image_url }}" alt="{{ p.name }}">
          {% endif %}
        {% endwith %}
      </div>
      <div class="relBody">
        <div class="relStore">{{ p.store.name }}</div>
        <div class="relName">{{ p.name }}</div>
        <div class="relPrice">{{ p.discount_price|default:p.base_price|iqd }}</div>
      </div>
    </a>
    {% endfor %}
  </div>
</section>
{% endif %}
<script type="application/json" id="variant-data">{{ variant_data|safe }}</script>
<script type="application/json" id="images-data">{{ images_by_color|safe }}</script>
<script type="application/json" id="colors-data">{{ available_colors|safe }}</script>
<script>
  const VARIANTS = JSON.parse(document.getElementById('variant-data').textContent || '[]');
  console.log('VARIANTS:', VARIANTS);
  const sizesEl = document.getElementById('sizes');
  const addBtn = document.getElementById('addBtn');
  const hiddenVar = document.getElementById('variantId');
  const pdWrap = document.querySelector('.pdWrap');
  const pdMain = (pdWrap ? pdWrap.querySelector('#pdMain') : document.getElementById('pdMain'));
  let pdThumbs = (pdWrap ? pdWrap.querySelector('#pdThumbs') : document.getElementById('pdThumbs'));
  const IMAGES_BY_COLOR = (function(){ try { return JSON.parse(document.getElementById('images-data').textContent || '{}'); } catch(e){ return {}; } })();
  const DEFAULT_IMAGE = '{{ default_main_image_url }}';
  function getImagesForColorId(colorId){
    const key = String(colorId);
    const arr = (IMAGES_BY_COLOR && (IMAGES_BY_COLOR[key] || IMAGES_BY_COLOR[colorId])) || IMAGES_BY_COLOR['__default__'] || [];
    return Array.isArray(arr) ? arr : [];
  }
  function renderThumbs(urls){
    if (!pdThumbs) return;
    const list = (Array.isArray(urls) ? urls : []).slice(0, 24);
    pdThumbs.innerHTML = '';
    const first = list[0] || DEFAULT_IMAGE;
    if (pdMain && first) pdMain.src = first;
    list.forEach(function(u,i){
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'thumb' + (i === 0 ? ' selected' : '');
      btn.setAttribute('data-src', u);
      const img = document.createElement('img');
      img.src = u;
      img.alt = '{{ product.name }}';
      img.onerror = function(){ this.onerror=null; this.src='{{ placeholder_image_url }}'; };
      btn.appendChild(img);
      pdThumbs.appendChild(btn);
    });
  }
  function bestVariantForSize(size){
    const same = VARIANTS.filter(v => String(v.size || '') === String(size || ''));
    if (same.length === 0) return null;
    const inStock = same.find(v => (v.stock_qty || 0) > 0);
    return inStock || same[0];
  }
  function updateButtonsState(){
    const chips = Array.from(sizesEl.querySelectorAll('.sz'));
    const noVariants = !(Array.isArray(VARIANTS) && VARIANTS.length > 0);
    chips.forEach(chip => {
      const size = chip.dataset.size;
      if (noVariants) {
        chip.disabled = false;
        return;
      }
      const v = bestVariantForSize(size);
      const out = !v || (v.stock_qty || 0) <= 0;
      chip.disabled = !!out;
    });
    const firstAvail = chips.find(ch => !ch.disabled);
    if (firstAvail){
      selectSize(firstAvail);
    } else {
      hiddenVar.value='';
      addBtn.disabled = true;
      if (chips.length === 0) {
        sizesEl.innerHTML = '<div class="fit">نفذت الكمية</div>';
      }
    }
  }
  function selectSize(chip){
    Array.from(sizesEl.querySelectorAll('.sz')).forEach(c => c.classList.remove('selected'));
    chip.classList.add('selected');
    const size = chip.dataset.size;
    const v = bestVariantForSize(size);
    hiddenVar.value = v && v.id ? String(v.id) : '';
    addBtn.disabled = !(v && (v.stock_qty || 0) > 0);
    try {
      const urls = v && v.color_id ? getImagesForColorId(v.color_id) : (IMAGES_BY_COLOR['__default__'] || []);
      renderThumbs(urls);
    } catch(e){}
  }
  document.addEventListener('DOMContentLoaded', function(){
    updateButtonsState();
    sizesEl.addEventListener('click', function(e){
      const b = e.target.closest('.sz');
      if (!b || b.disabled) return;
      selectSize(b);
    });
    if (pdThumbs) {
      pdThumbs.addEventListener('click', function(e){
        const b = e.target.closest('.thumb');
        if (!b) return;
        const src = b.getAttribute('data-src');
        console.log('Thumbnail clicked:', src);
        if (src && pdMain) pdMain.src = src;
        Array.from(pdThumbs.querySelectorAll('.thumb')).forEach(t => t.classList.remove('selected'));
        b.classList.add('selected');
      });
      const firstThumb = pdThumbs.querySelector('.thumb');
      if (firstThumb) firstThumb.classList.add('selected');
    }
    const form = addBtn.closest('form');
    form.addEventListener('submit', function(e){
      if (Array.isArray(VARIANTS) && VARIANTS.length > 0 && !hiddenVar.value){ e.preventDefault(); }
    });
  });
</script>
<!-- Hero Section -->
<section class="product-hero bg-gradient-primary py-5 mb-5">
    <div class="container">
        <div class="d-flex justify-content-end mb-2">
            <span class="badge bg-dark text-white">PD_V1_SIMPLE_{% now "Y-m-d" %}</span>
        </div>
        <div class="row align-items-center">
            <div class="col-lg-8">
                <nav aria-label="breadcrumb" class="mb-4">
                    <ol class="breadcrumb breadcrumb-light">
                        <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-light">الرئيسية</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'store_list' %}" class="text-light">المتاجر</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'store_detail' product.store.id %}" class="text-light">{{ product.store.name }}</a></li>
                        <li class="breadcrumb-item active text-light-50">{{ product.name }}</li>
                    </ol>
                </nav>
                <h1 class="display-4 fw-bold text-white mb-3 animate-fade-in">
                    {{ product.name }}
                </h1>
                <p class="lead text-light mb-4 animate-fade-in-delay">
                    من <a href="{% url 'store_detail' product.store.id %}" class="text-white fw-bold">{{ product.store.name }}</a>
                </p>
            </div>
            <div class="col-lg-4 text-center">
                <div class="product-hero-icon animate-bounce">
                    <i class="bi bi-bag-heart display-1 text-white opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Product Details Section -->
<section class="product-details-section mb-5">
    <div class="container">
        <div class="row g-5">
            <!-- Product Images -->
            <div class="col-lg-6">
                <div class="product-gallery-card p-4 bg-white rounded-4 shadow-lg">
                    {% if primary_video_url %}
                    <div class="rounded-3 overflow-hidden mb-3">
                        <video id="pdVideo" src="{{ primary_video_url }}" class="w-100" style="height: 500px; object-fit: cover;" controls playsinline></video>
                    </div>
                    {% endif %}
                    <div class="rounded-3 overflow-hidden">
                        <img id="pdMain" src="{{ default_main_image_url }}" alt="{{ product.name }}" class="w-100" style="height: 500px; object-fit: cover;" onerror="this.onerror=null;this.src='{{ placeholder_image_url }}'">
                    </div>
                    <div id="pdThumbs" class="mt-3 d-flex flex-wrap gap-2"></div>
                </div>
            </div>
            
            <!-- Product Info -->
            <div class="col-lg-6">
                <div class="product-info-card p-5 bg-white rounded-4 shadow-lg">
                    <!-- Price and Category -->
                    <div class="product-header mb-4">
                        <div class="product-category mb-3">
                            <span class="badge bg-primary-gradient text-white px-4 py-2 fs-6">
                                <i class="bi bi-tag me-2"></i>
                                {{ product.get_category_display }}
                            </span>
                        </div>
                        <div class="product-price mb-3">
                            {% if product.discount_price %}
                                <div class="d-flex align-items-baseline gap-3">
                                    <span class="price-old">{{ product.base_price|iqd }}</span>
                                    <span class="price-new">{{ product.discount_price|iqd }}</span>
                                </div>
                            {% else %}
                                <span class="price-new">{{ product.base_price|iqd }}</span>
                            {% endif %}
                        </div>
                        {% if fit_advice %}
                        <div class="alert alert-warning d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                {{ fit_advice }}
                            </div>
                            <button type="button" class="btn btn-outline-dark btn-sm" data-bs-toggle="modal" data-bs-target="#sizeChartModal">جدول القياسات</button>
                        </div>
                        {% endif %}
                        <div class="d-flex align-items-center mb-2">
                            <div class="rating-stars me-2">
                                {% with r=product.rating|default:0 %}
                                {% for i in "12345" %}
                                    {% if forloop.counter <= r|floatformat:0 %}
                                        <i class="bi bi-star-fill"></i>
                                    {% else %}
                                        <i class="bi bi-star"></i>
                                    {% endif %}
                                {% endfor %}
                                {% endwith %}
                            </div>
                            <div class="text-muted">({{ reviews_count|default:0 }} مراجعة)</div>
                        </div>
                        <div class="cta-group d-flex gap-2 mb-3">
                            {% if not pd_simple %}
                            <button type="button" class="btn btn-primary flex-grow-1" id="quickAddBtn">أضف للسلة</button>
                            <button type="button" class="btn cta-buy" id="buyNowBtn">شراء الآن</button>
                            {% else %}
                            <button type="button" class="btn btn-primary flex-grow-1" id="quickAddSimpleBtn" {% if add_disabled %}disabled{% endif %}>أضف للسلة</button>
                            <button type="button" class="btn cta-buy" id="buyNowSimpleBtn" {% if add_disabled %}disabled{% endif %}>شراء الآن</button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Description -->
                    {% if product.description %}
                    <div class="product-description mb-5">
                        <h5 class="fw-bold mb-3 text-gradient">
                            <i class="bi bi-info-circle me-2"></i>
                            وصف المنتج
                        </h5>
                        <p class="lead text-muted">{{ product.description }}</p>
                    </div>
                    {% endif %}
                    
                    {% if not pd_simple %}
                    <!-- Variants -->
                    <div class="product-variants mb-5">
                        <h5 class="fw-bold mb-4 text-gradient">
                            <i class="bi bi-palette me-2"></i>
                            اختر اللون والمقاس
                        </h5>
                        <div class="mb-3">
                            <span class="badge bg-light text-dark">لون: <span id="selColor">غير محدد</span></span>
                            <span class="badge bg-light text-dark ms-2">قياس: <span id="selSize">غير محدد</span></span>
                        </div>
                        <form method="post" action="{% url 'cart_items_json' %}" class="add-to-cart-form" id="variantPickerForm">
                            {% csrf_token %}
                            <input type="hidden" name="productId" value="{{ product.id }}">
                            <input type="hidden" name="storeId" value="{{ product.store.id }}">
                            <input type="hidden" name="variantId" id="selectedVariantId">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold"><i class="bi bi-palette me-2"></i>اللون</label>
                                    <div id="pdSwatches" class="d-flex flex-wrap gap-2"></div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold"><i class="bi bi-rulers me-2"></i>المقاس</label>
                                    <div id="pdSizes" class="d-flex flex-wrap gap-2" style="display:none;"></div>
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#sizeChartModal">جدول القياسات</button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">الكمية</label>
                                    <input type="number" class="form-control" name="quantity" id="qtyInput" value="1" min="1" style="width: 120px;">
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div id="stockInfo" class="text-muted"></div>
                                </div>
                                <div class="col-md-6 text-end">
                                    <div id="variantPrice" class="h5 text-primary fw-bold"></div>
                                </div>
                            </div>
                            <div class="mt-3" id="pdAddBtn">
                                <button type="submit" class="btn btn-gradient btn-lg w-100" id="addToCartBtn" disabled>
                                    <i class="bi bi-cart-plus me-2"></i>
                                    أضف للسلة
                                </button>
                                <div id="inlineMsg" class="text-danger mt-2" style="display:none;">يرجى اختيار اللون والمقاس قبل الإضافة إلى السلة</div>
                            </div>
                        </form>
                        <script type="application/json" id="variant-data">{{ variant_data|safe }}</script>
                        <script type="application/json" id="sizes-data">{{ sizes_by_color|safe }}</script>
                        <script type="application/json" id="images-data">{{ images_by_color|safe }}</script>
                        <script type="application/json" id="colors-data">{{ available_colors|safe }}</script>
                        <script>
                            const VARIANTS = JSON.parse(document.getElementById('variant-data').textContent || '[]');
                            const SIZES_BY_COLOR = JSON.parse(document.getElementById('sizes-data').textContent || '{}');
                            const IMAGES_BY_COLOR = JSON.parse(document.getElementById('images-data').textContent || '{}');
                            const AVAILABLE_COLORS = JSON.parse(document.getElementById('colors-data').textContent || '[]');
                            const DEFAULT_COLOR = {{ default_color|default:'null'|safe }};
                            const DEFAULT_MAIN_IMAGE = '{{ default_main_image_url }}';
                                console.log('pd:init:data', {variantsLen: VARIANTS.length, colorsLen: AVAILABLE_COLORS.length, sizesKeys: Object.keys(SIZES_BY_COLOR), defaultColor: DEFAULT_COLOR});
                            const swatchesEl = document.getElementById('pdSwatches');
                            const sizesEl = document.getElementById('pdSizes');
                            const selColor = document.getElementById('selColor');
                            const selSize = document.getElementById('selSize');
                            const qtyInput = document.getElementById('qtyInput');
                            const stockInfo = document.getElementById('stockInfo');
                            const variantPrice = document.getElementById('variantPrice');
                            const addBtn = document.getElementById('addToCartBtn');
                            const hiddenVariantId = document.getElementById('selectedVariantId');
                            const pdMain = document.getElementById('pdMain');
                            const pdThumbs = document.getElementById('pdThumbs');
                            const inlineMsg = document.getElementById('inlineMsg');
                            const REQUIRES_SIZE = '{{ product.size_type }}' !== 'none';
                            const REQUIRED_MSG = REQUIRES_SIZE ? 'يرجى اختيار اللون والمقاس قبل الإضافة إلى السلة' : 'يرجى اختيار اللون قبل الإضافة إلى السلة';
                            inlineMsg.textContent = REQUIRED_MSG;
                            let selectedColor = null;
                            let selectedSize = null;

                            function renderColorSwatches(){
                                console.log('pd:renderColorSwatches:start', {availableColors: AVAILABLE_COLORS});
                                swatchesEl.innerHTML = '';
                                AVAILABLE_COLORS.forEach(c => {
                                    const sw = document.createElement('button');
                                    sw.type = 'button';
                                    sw.className = 'swatch';
                                    sw.setAttribute('title', c.name);
                                    sw.setAttribute('aria-label', c.name);
                                    sw.setAttribute('data-color', c.name);
                                    const hex = (c.hex || '').trim();
                                    if (hex) sw.style.backgroundColor = hex;
                                    else sw.style.background = 'linear-gradient(45deg,#999,#bbb)';
                                    if (selectedColor && selectedColor === c.name) sw.classList.add('selected');
                                    sw.addEventListener('click', function(){ selectColor(c.name); });
                                    swatchesEl.appendChild(sw);
                                });
                                console.log('pd:renderColorSwatches:end', {count: (AVAILABLE_COLORS || []).length});
                            }
                            function updateGallery(color){
                                const list = (color && IMAGES_BY_COLOR[color] && IMAGES_BY_COLOR[color].length > 0) ? IMAGES_BY_COLOR[color] : (IMAGES_BY_COLOR['__default__'] || []);
                                const limited = (list || []).slice(0, 3);
                                console.log('pd:updateGallery', {color, urlsLen: limited.length});
                                const first = limited.length ? limited[0] : DEFAULT_MAIN_IMAGE;
                                pdMain.src = first;
                                pdMain.setAttribute('fetchpriority','high');
                                pdThumbs.innerHTML = '';
                                if (limited.length > 1) {
                                    limited.forEach(function(u){
                                        const t = document.createElement('img');
                                        t.src = u;
                                        t.alt = '{{ product.name }}';
                                        t.className = 'thumb';
                                        t.loading = 'lazy';
                                        t.decoding = 'async';
                                        t.addEventListener('click', function(){ pdMain.src = u; });
                                        pdThumbs.appendChild(t);
                                    });
                                }
                            }
                            function resetSize(){
                                console.log('pd:resetSize');
                                sizesEl.innerHTML = '';
                                sizesEl.style.display = 'none';
                                hiddenVariantId.value = '';
                                addBtn.disabled = true;
                                inlineMsg.style.display = 'block';
                                stockInfo.textContent = '';
                                variantPrice.textContent = '';
                                qtyInput.value = 1;
                                qtyInput.removeAttribute('max');
                                selectedSize = null;
                                selSize.textContent = 'غير محدد';
                            }
                            function selectColor(color){
                                resetSize();
                                const sizes = SIZES_BY_COLOR[color] || [];
                                console.log('pd:selectColor', {color, sizesLen: sizes.length});
                                let availableCount = 0;
                                // mark selected color
                                selectedColor = color;
                                Array.from(swatchesEl.children || []).forEach(el => {
                                    el.classList.toggle('selected', el.getAttribute('data-color') === color);
                                });
                                // build size buttons
                                sizes.forEach(s => {
                                    const v = VARIANTS.find(x => x.color === color && x.size === s);
                                    const out = !v || v.stock_qty <= 0;
                                    const b = document.createElement('button');
                                    b.type = 'button';
                                    b.className = 'size-btn' + (out ? ' disabled' : '');
                                    b.disabled = !!out;
                                    b.textContent = s;
                                    b.setAttribute('data-size', s);
                                    if (!out) availableCount++;
                                    if (!out) {
                                        b.addEventListener('click', function(){ selectSize(color, s); });
                                    }
                                    sizesEl.appendChild(b);
                                });
                                sizesEl.style.display = sizes.length > 0 ? '' : 'none';
                                updateGallery(color);
                                stockInfo.textContent = (sizes.length > 0 && availableCount === 0) ? 'هذا اللون غير متوفر' : '';
                                selColor.textContent = color || 'غير محدد';
                                selSize.textContent = 'غير محدد';
                                const firstAvail = VARIANTS.find(x => x.color === color && x.stock_qty > 0);
                                if (firstAvail){ selectSize(color, firstAvail.size); }
                                inlineMsg.style.display = addBtn.disabled ? 'block' : 'none';
                            }

                            function selectSize(color, size){
                                selectedSize = size;
                                console.log('pd:selectSize:start', {color, size});
                                Array.from(sizesEl.children || []).forEach(el => {
                                    el.classList.toggle('selected', el.getAttribute('data-size') === size);
                                });
                                const v = VARIANTS.find(x => x.color === (color || '') && x.size === size);
                                if (!v){
                                    console.log('pd:selectSize:notFound', {color, size});
                                    hiddenVariantId.value = '';
                                    addBtn.disabled = true;
                                    stockInfo.textContent = '';
                                    variantPrice.textContent = '';
                                    qtyInput.value = 1;
                                    qtyInput.removeAttribute('max');
                                    selSize.textContent = size || 'غير محدد';
                                    return;
                                }
                                console.log('pd:selectSize:found', {id: v.id, stock_qty: v.stock_qty, price: v.price});
                                hiddenVariantId.value = v.id;
                                addBtn.disabled = v.stock_qty <= 0;
                                stockInfo.textContent = v.stock_qty > 0 ? `متاح (${v.stock_qty} قطعة)` : 'هذا القياس غير متوفر';
                                qtyInput.value = 1;
                                qtyInput.max = v.stock_qty > 0 ? v.stock_qty : 1;
                                variantPrice.textContent = `${v.price.toLocaleString('ar-IQ')} دينار`;
                                selColor.textContent = color || 'غير محدد';
                                selSize.textContent = size || 'غير محدد';
                                inlineMsg.style.display = addBtn.disabled ? 'block' : 'none';
                            }

                            function initPage(){
                                console.log('pd:initPage:start');
                                renderColorSwatches();
                                updateGallery(DEFAULT_COLOR);
                                if (Array.isArray(VARIANTS) && VARIANTS.length > 0){
                                    const hasColors = Array.isArray(AVAILABLE_COLORS) && AVAILABLE_COLORS.length > 0;
                                    const initialColor = DEFAULT_COLOR || (hasColors && AVAILABLE_COLORS[0] ? AVAILABLE_COLORS[0].name : null);
                                    console.log('pd:initPage:variants', {hasColors, initialColor});
                                    if (initialColor) {
                                        selectColor(initialColor);
                                    } else {
                                        const nocSizes = SIZES_BY_COLOR['__no_color__'] || Array.from(new Set(VARIANTS.map(x => x.size)));
                                        sizesEl.innerHTML = '';
                                        nocSizes.forEach(s => {
                                            const v = VARIANTS.find(x => (x.color || '') === '' && x.size === s) || VARIANTS.find(x => x.size === s);
                                            const out = !v || v.stock_qty <= 0;
                                            const b = document.createElement('button');
                                            b.type = 'button';
                                            b.className = 'size-btn' + (out ? ' disabled' : '');
                                        b.disabled = !!out;
                                            b.textContent = s;
                                            b.setAttribute('data-size', s);
                                            if (!out) {
                                                b.addEventListener('click', function(){ selectSize('', s); });
                                            }
                                            sizesEl.appendChild(b);
                                        });
                                        sizesEl.style.display = nocSizes.length > 0 ? '' : 'none';
                                        selColor.textContent = 'غير محدد';
                                        selSize.textContent = 'غير محدد';
                                        hiddenVariantId.value = '';
                                        addBtn.disabled = true;
                                        inlineMsg.style.display = 'none';
                                        console.log('pd:initPage:noColor', {sizesLen: nocSizes.length});
                                    }
                                } else {
                                    hiddenVariantId.value = '';
                                    addBtn.disabled = false;
                                    stockInfo.textContent = '';
                                    variantPrice.textContent = `${parseFloat({{ product.discount_price|default:product.base_price }}).toLocaleString('ar-IQ')} دينار`;
                                    inlineMsg.style.display = 'none';
                                    console.log('pd:initPage:noVariants');
                                }
                            }
                            document.getElementById('variantPickerForm').addEventListener('submit', function(e){
                                if (Array.isArray(VARIANTS) && VARIANTS.length > 0 && !hiddenVariantId.value){
                                    e.preventDefault();
                                    console.log('pd:submit:blocked', {variantId: hiddenVariantId.value});
                                    inlineMsg.style.display = 'block';
                                }
                                console.log('pd:submit:ok', {variantId: hiddenVariantId.value});
                            });

                                // Initialize default selection on page load if variants exist
                            document.addEventListener('DOMContentLoaded', initPage);
                        </script>
                        <script>
                            const quickAddBtn = document.getElementById('quickAddBtn');
                            if (quickAddBtn) {
                                quickAddBtn.addEventListener('click', function(){
                                    const form = document.getElementById('variantPickerForm');
                                    const hiddenVariantId = document.getElementById('selectedVariantId');
                                    const VARIANTS = JSON.parse(document.getElementById('variant-data').textContent || '[]');
                                    const inlineMsg = document.getElementById('inlineMsg');
                                    if (!hiddenVariantId.value && VARIANTS.length > 0) { inlineMsg.style.display = 'block'; return; }
                                    form.requestSubmit();
                                });
                            }
                            const buyNowBtn = document.getElementById('buyNowBtn');
                            if (buyNowBtn) {
                                buyNowBtn.addEventListener('click', async function(){
                                    const form = document.getElementById('variantPickerForm');
                                    const hiddenVariantId = document.getElementById('selectedVariantId');
                                    const VARIANTS = JSON.parse(document.getElementById('variant-data').textContent || '[]');
                                    const inlineMsg = document.getElementById('inlineMsg');
                                    if (!hiddenVariantId.value && VARIANTS.length > 0) { inlineMsg.style.display = 'block'; return; }
                                    const fd = new FormData(form);
                                    const resp = await fetch(form.action, { method: 'POST', body: fd });
                                    if (resp.ok) { window.location.href = '{% url "checkout" %}'; }
                                });
                            }
                        </script>
                    </div>
                    {% else %}
                    <div class="product-variants mb-4">
                        <form method="post" action="{% url 'cart_items_json' %}" class="add-to-cart-form" id="simpleAddForm">
                            {% csrf_token %}
                            <input type="hidden" name="productId" value="{{ product.id }}">
                            <input type="hidden" name="storeId" value="{{ product.store.id }}">
                            <input type="hidden" name="variantId" value="{{ preselected_variant_id|default:'' }}">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">الكمية</label>
                                    <input type="number" class="form-control" name="quantity" value="1" min="1" style="width: 120px;">
                                </div>
                                <div class="col-md-8 text-end">
                                    <button type="submit" class="btn btn-gradient btn-lg w-100" {% if add_disabled %}disabled{% endif %}>
                                        <i class="bi bi-cart-plus me-2"></i>
                                        أضف للسلة
                                    </button>
                                    <div class="mt-2 d-flex gap-2 justify-content-end">
                                        <button type="button" class="btn btn-primary" id="quickAddSimpleBtn" {% if add_disabled %}disabled{% endif %}>أضف بسرعة</button>
                                        <button type="button" class="btn cta-buy" id="buyNowSimpleBtn" {% if add_disabled %}disabled{% endif %}>شراء الآن</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <script>
                            const quickAddSimpleBtn = document.getElementById('quickAddSimpleBtn');
                            const buyNowSimpleBtn = document.getElementById('buyNowSimpleBtn');
                            function _submitSimple(){ const f=document.getElementById('simpleAddForm'); if(f) f.requestSubmit(); }
                            if (quickAddSimpleBtn) quickAddSimpleBtn.addEventListener('click', _submitSimple);
                            async function _buyNowSimple(){
                                const form = document.getElementById('simpleAddForm');
                                if (!form) return;
                                const fd = new FormData(form);
                                const resp = await fetch(form.action, { method: 'POST', body: fd });
                                if (resp.ok) { window.location.href = '{% url "checkout" %}'; }
                            }
                            if (buyNowSimpleBtn) buyNowSimpleBtn.addEventListener('click', _buyNowSimple);
                        </script>
                    </div>
                    {% endif %}
                </div>
                    
                    <!-- Store Info -->
                    <div class="store-info-section p-4 bg-light rounded-3">
                        <h6 class="fw-bold mb-3 text-gradient">
                            <i class="bi bi-shop me-2"></i>
                            متجر: {{ product.store.name }}
                        </h6>
                        <p class="text-muted mb-2">
                            <i class="bi bi-geo-alt me-2"></i>
                            {{ product.store.city }} - {{ product.store.address }}
                        </p>
                        <a href="{% url 'store_detail' product.store.id %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-shop-window me-2"></i>
                            زيارة المتجر
                        </a>
                    </div>
                    <div class="specs-card p-4 bg-white rounded-3 mt-4">
                        <h6 class="fw-bold mb-3">المواصفات التقنية</h6>
                        <div class="spec-row"><div class="text-muted">الفئة</div><div>{{ product.get_category_display }}</div></div>
                        <div class="spec-row"><div class="text-muted">نوع المقاس</div><div>{{ product.get_size_type_display|default:product.size_type }}</div></div>
                        <div class="spec-row"><div class="text-muted">المتجر</div><div>{{ product.store.name }}</div></div>
                        <div class="spec-row"><div class="text-muted">الحالة</div><div>{% if product.is_active %}نشط{% else %}غير نشط{% endif %}</div></div>
                        <div class="spec-row"><div class="text-muted">أضيف في</div><div>{{ product.created_at|date:"Y/m/d" }}</div></div>
                    </div>
                    <div class="reviews-card p-4 bg-white rounded-3 mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-0">مراجعات العملاء</h6>
                            <div class="d-flex gap-2">
                                <select id="reviewsSort" class="form-select form-select-sm" style="width:160px">
                                    <option value="recent">الأحدث</option>
                                    <option value="rating_desc">الأعلى تقييماً</option>
                                    <option value="rating_asc">الأقل تقييماً</option>
                                </select>
                                <select id="reviewsFilter" class="form-select form-select-sm" style="width:160px">
                                    <option value="all">الكل</option>
                                    <option value="5">5 نجوم</option>
                                    <option value="4">4 نجوم</option>
                                    <option value="3">3 نجوم</option>
                                    <option value="2">2 نجوم</option>
                                    <option value="1">1 نجمة</option>
                                </select>
                            </div>
                        </div>
                        <div id="reviewsList" class="text-muted">لا توجد مراجعات بعد</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<div class="modal fade" id="sizeChartModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">جدول القياسات بالسنتيمتر</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% if product.size_type == 'numeric' %}
        <div class="table-responsive">
          <table class="table">
            <thead><tr><th>المقاس</th><th>الطول</th><th>العرض</th></tr></thead>
            <tbody>
              <tr><td>28</td><td>62 سم</td><td>36 سم</td></tr>
              <tr><td>30</td><td>63 سم</td><td>37 سم</td></tr>
              <tr><td>32</td><td>64 سم</td><td>38 سم</td></tr>
              <tr><td>34</td><td>65 سم</td><td>39 سم</td></tr>
              <tr><td>36</td><td>66 سم</td><td>40 سم</td></tr>
              <tr><td>38</td><td>67 سم</td><td>41 سم</td></tr>
              <tr><td>40</td><td>68 سم</td><td>42 سم</td></tr>
              <tr><td>42</td><td>69 سم</td><td>43 سم</td></tr>
              <tr><td>44</td><td>70 سم</td><td>44 سم</td></tr>
              <tr><td>46</td><td>71 سم</td><td>45 سم</td></tr>
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="table-responsive">
          <table class="table">
            <thead><tr><th>المقاس</th><th>الصدر</th><th>الطول</th></tr></thead>
            <tbody>
              <tr><td>XS</td><td>82 سم</td><td>62 سم</td></tr>
              <tr><td>S</td><td>86 سم</td><td>63 سم</td></tr>
              <tr><td>M</td><td>90 سم</td><td>64 سم</td></tr>
              <tr><td>L</td><td>96 سم</td><td>66 سم</td></tr>
              <tr><td>XL</td><td>102 سم</td><td>68 سم</td></tr>
              <tr><td>XXL</td><td>108 سم</td><td>70 سم</td></tr>
              <tr><td>3XL</td><td>114 سم</td><td>72 سم</td></tr>
              <tr><td>4XL</td><td>120 سم</td><td>74 سم</td></tr>
            </tbody>
          </table>
        </div>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
      </div>
    </div>
  </div>
</div>
<!-- Similar Products -->
<section class="mb-5">
    <div class="container">
        {% if similar_products or same_store_products %}
        <h4 class="fw-bold mb-3">منتجات مشابهة</h4>
        <div class="row g-3">
            {% if similar_products %}
                {% for p in similar_products|slice:"8" %}
                <div class="col-6 col-md-3">
                    <a href="{% url 'product_detail' p.id %}" class="card h-100 text-decoration-none">
                        <div class="ratio ratio-1x1">
                            {% with img=p.images.all|first %}
                                {% if img %}
                                    <img src="{{ img.get_image_url }}" alt="{{ p.name }}" class="card-img-top" onerror="this.onerror=null;this.src='{{ placeholder_image_url }}'">
                                {% else %}
                                    <img src="{{ placeholder_image_url }}" alt="{{ p.name }}" class="card-img-top">
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="card-body">
                            <div class="small text-muted">{{ p.store.name }}</div>
                            <div class="fw-semibold">{{ p.name }}</div>
                            <div class="text-primary">{{ p.discount_price|default:p.base_price|iqd }}</div>
                        </div>
                    </a>
                </div>
                {% endfor %}
            {% elif same_store_products %}
                {% for p in same_store_products|slice:"8" %}
                <div class="col-6 col-md-3">
                    <a href="{% url 'product_detail' p.id %}" class="card h-100 text-decoration-none">
                        <div class="ratio ratio-1x1">
                            {% with img=p.images.all|first %}
                                {% if img %}
                                    <img src="{{ img.get_image_url }}" alt="{{ p.name }}" class="card-img-top" onerror="this.onerror=null;this.src='{{ placeholder_image_url }}'">
                                {% else %}
                                    <img src="{{ placeholder_image_url }}" alt="{{ p.name }}" class="card-img-top">
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="card-body">
                            <div class="small text-muted">{{ p.store.name }}</div>
                            <div class="fw-semibold">{{ p.name }}</div>
                            <div class="text-primary">{{ p.discount_price|default:p.base_price|iqd }}</div>
                        </div>
                    </a>
                </div>
                {% endfor %}
            {% endif %}
        </div>
        {% endif %}
        {% if similar_products and same_store_products %}
        <h5 class="fw-bold mt-4 mb-3">منتجات من نفس المتجر</h5>
        <div class="row g-3">
            {% for p in same_store_products %}
            <div class="col-6 col-md-3">
                <a href="{% url 'product_detail' p.id %}" class="card h-100 text-decoration-none">
                    <div class="ratio ratio-1x1">
                        {% with img=p.images.all|first %}
                            {% if img %}
                                <img src="{{ img.get_image_url }}" alt="{{ p.name }}" class="card-img-top" onerror="this.onerror=null;this.src='{{ placeholder_image_url }}'">
                            {% else %}
                                <img src="{{ placeholder_image_url }}" alt="{{ p.name }}" class="card-img-top">
                            {% endif %}
                        {% endwith %}
                    </div>
                    <div class="card-body">
                        <div class="small text-muted">{{ p.store.name }}</div>
                        <div class="fw-semibold">{{ p.name }}</div>
                        <div class="text-primary">{{ p.discount_price|default:p.base_price|iqd }}</div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
</section>
{% endblock %}
