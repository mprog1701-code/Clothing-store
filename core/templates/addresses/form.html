{% extends 'base.html' %}

{% block title %}{% if form.instance.pk %}تعديل{% else %}إضافة{% endif %} عنوان - متجر الملابس{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient-primary text-white py-4">
                    <h3 class="mb-0">
                        <i class="bi bi-geo-alt-fill me-2"></i>
                        {% if form.instance.pk %}
                            تعديل العنوان
                        {% else %}
                            إضافة عنوان جديد
                        {% endif %}
                    </h3>
                </div>
                <div class="card-body p-4">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label">اسم العنوان</label>
                                {{ form.title }}
                                <div class="invalid-feedback">
                                    {{ form.title.errors }}
                                </div>
                                <small class="form-text text-muted">مثال: المنزل، العمل</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.recipient_name.id_for_label }}" class="form-label">اسم المستلم</label>
                                {{ form.recipient_name }}
                                <div class="invalid-feedback">
                                    {{ form.recipient_name.errors }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.phone.id_for_label }}" class="form-label">رقم الجوال</label>
                                {{ form.phone }}
                                <div class="invalid-feedback">
                                    {{ form.phone.errors }}
                                </div>
                                <small class="form-text text-muted">07xxxxxxxxx</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.postal_code.id_for_label }}" class="form-label">الرمز البريدي</label>
                                {{ form.postal_code }}
                                <div class="invalid-feedback">
                                    {{ form.postal_code.errors }}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12 mb-3 d-flex align-items-center gap-2">
                                <button type="button" id="addrGpsBtn" class="btn btn-outline-primary btn-sm">استخدم موقعي الحالي</button>
                                <span id="addrGpsSpinner" class="spinner-border spinner-border-sm" style="display:none;" aria-hidden="true"></span>
                                <span id="addrGpsStatus" class="text-muted small"></span>
                                <input type="hidden" id="addrLatitude" name="latitude">
                                <input type="hidden" id="addrLongitude" name="longitude">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.city.id_for_label }}" class="form-label">المدينة</label>
                                {{ form.city }}
                                <div class="invalid-feedback">
                                    {{ form.city.errors }}
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.district.id_for_label }}" class="form-label">الحي</label>
                                {{ form.district }}
                                <div class="invalid-feedback">
                                    {{ form.district.errors }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.street.id_for_label }}" class="form-label">الشارع</label>
                            {{ form.street }}
                            <div class="invalid-feedback">
                                {{ form.street.errors }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.building_number.id_for_label }}" class="form-label">رقم المبنى</label>
                            {{ form.building_number }}
                            <div class="invalid-feedback">
                                {{ form.building_number.errors }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.additional_info.id_for_label }}" class="form-label">معلومات إضافية</label>
                            {{ form.additional_info }}
                            <div class="invalid-feedback">
                                {{ form.additional_info.errors }}
                            </div>
                            <small class="form-text text-muted">تفاصيل إضافية لتسهيل الوصول (اختياري)</small>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.is_default }}
                                <label class="form-check-label" for="{{ form.is_default.id_for_label }}">
                                    تعيين كعنوان افتراضي
                                </label>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'address_list' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-return-right me-2"></i>العودة
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>
                                {% if form.instance.pk %}
                                    حفظ التغييرات
                                {% else %}
                                    إضافة العنوان
                                {% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.form-control {
    border-radius: 10px;
    padding: 12px 15px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.form-control::placeholder {
    color: #6c757d;
    opacity: 0.7;
}
</style>

<script>
// Form validation
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();

// Phone number formatting
document.addEventListener('DOMContentLoaded', function() {
    const phoneInput = document.querySelector('input[name="phone"]');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if (value.length > 0 && !value.startsWith('07')) {
                value = '07' + value.substring(2);
            }
            if (value.length > 11) {
                value = value.substring(0, 11);
            }
            e.target.value = value;
        });
    }
});

function addrReverseGeocode(lat, lon){
    var apiKey = window.GOOGLE_MAPS_API_KEY || '';
    if(apiKey){
        var gurl = 'https://maps.googleapis.com/maps/api/geocode/json?latlng='+encodeURIComponent(lat+','+lon)+'&key='+encodeURIComponent(apiKey);
        return fetch(gurl).then(function(r){return r.json()}).then(function(data){
            var res = (data && data.results && data.results[0]) || {};
            var comps = res.address_components || [];
            var addr = {};
            comps.forEach(function(c){
                if(c.types.indexOf('locality')>-1){ addr.city = c.long_name; }
                if(c.types.indexOf('administrative_area_level_1')>-1 && !addr.city){ addr.city = c.long_name; }
                if(c.types.indexOf('sublocality')>-1 || c.types.indexOf('neighborhood')>-1){ addr.suburb = c.long_name; }
                if(c.types.indexOf('route')>-1){ addr.road = c.long_name; }
                if(c.types.indexOf('street_number')>-1){ addr.house_number = c.long_name; }
            });
            return { address: addr, display_name: res.formatted_address || '' };
        });
    }
    var url = 'https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat='+encodeURIComponent(lat)+'&lon='+encodeURIComponent(lon)+'&accept-language=ar';
    return fetch(url).then(function(r){return r.json()});
}

function addrFillFields(place){
    var addr = place.address || {};
    var cityInput = document.querySelector('input[name="city"]');
    var areaInput = document.querySelector('input[name="area"]') || document.querySelector('input[name="district"]');
    var streetInput = document.querySelector('input[name="street"]');
    var buildingInput = document.querySelector('input[name="building_number"]');
    var detailsTextarea = document.querySelector('textarea[name="details"]') || document.querySelector('textarea[name="additional_info"]');
    if(cityInput){ cityInput.value = addr.city || addr.town || addr.village || addr.state || ''; }
    var areaCandidate = addr.suburb || addr.neighbourhood || addr.quarter || addr.district || addr.county || '';
    if(areaInput){ areaInput.value = areaCandidate; }
    var road = addr.road || '';
    var house = addr.house_number || '';
    var streetStr = road + (house ? ' ' + house : '');
    if(streetInput){ streetInput.value = streetStr; }
    if(buildingInput && house){ buildingInput.value = house; }
    if(detailsTextarea && place.display_name){
        var dn = place.display_name.split(',').slice(0,5).join(',').trim();
        detailsTextarea.value = dn;
    }
}

document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('addrGpsBtn');
    var statusEl = document.getElementById('addrGpsStatus');
    var spinnerEl = document.getElementById('addrGpsSpinner');
    var latEl = document.getElementById('addrLatitude');
    var lonEl = document.getElementById('addrLongitude');
    if(btn){
        btn.addEventListener('click', function(){
            if(!navigator.geolocation){
                if(statusEl){ statusEl.textContent = 'المتصفح لا يدعم GPS'; }
                return;
            }
            var secure = (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1');
            if(!secure){ if(statusEl){ statusEl.textContent = 'يتطلب تحديد الموقع اتصالاً آمناً (HTTPS)'; } console.log('GPS error: insecure context'); return; }
            btn.disabled = true;
            if(statusEl){ statusEl.textContent = 'جارٍ تحديد الموقع...'; }
            if(spinnerEl){ spinnerEl.style.display = 'inline-block'; }
            navigator.geolocation.getCurrentPosition(function(pos){
                var lat = pos.coords.latitude;
                var lon = pos.coords.longitude;
                if(!latEl){ latEl = document.createElement('input'); latEl.type='hidden'; latEl.name='latitude'; latEl.id='addrLatitude'; btn.closest('form')?.appendChild(latEl); }
                if(!lonEl){ lonEl = document.createElement('input'); lonEl.type='hidden'; lonEl.name='longitude'; lonEl.id='addrLongitude'; btn.closest('form')?.appendChild(lonEl); }
                latEl.value = lat; lonEl.value = lon; console.log('GPS success:', lat, lon);
                if(statusEl){ statusEl.textContent = 'تم الحصول على الإحداثيات ('+lat.toFixed(5)+', '+lon.toFixed(5)+')، جارٍ التعرف على العنوان...'; }
                addrReverseGeocode(lat, lon).then(function(place){
                    addrFillFields(place);
                    if(statusEl){ statusEl.textContent = 'تم ملء العنوان من الموقع'; }
                    btn.disabled = false;
                    if(spinnerEl){ spinnerEl.style.display = 'none'; }
                    console.log('Reverse geocode success:', place);
                }).catch(function(){
                    var detailsTextarea = document.querySelector('textarea[name="details"]') || document.querySelector('textarea[name="additional_info"]');
                    if(detailsTextarea){ detailsTextarea.value = 'إحداثيات: '+lat+', '+lon; }
                    if(statusEl){ statusEl.textContent = 'تم تحديد الإحداثيات ولم يُتعرف على العنوان، الرجاء إدخاله يدوياً'; }
                    btn.disabled = false;
                    if(spinnerEl){ spinnerEl.style.display = 'none'; }
                    console.log('Reverse geocode error');
                });
            }, function(err){
                var msg = 'تعذر تحديد الموقع';
                if(err && err.code === 1){ msg = 'تم رفض الإذن لتحديد الموقع'; }
                else if(err && err.code === 2){ msg = 'الموقع غير متاح حالياً'; }
                else if(err && err.code === 3){ msg = 'انتهت مهلة تحديد الموقع'; }
                if(statusEl){ statusEl.textContent = msg; }
                console.log('GPS error:', err);
                btn.disabled = false;
                if(spinnerEl){ spinnerEl.style.display = 'none'; }
            }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
        });
    }
});
</script>
{% endblock %}
