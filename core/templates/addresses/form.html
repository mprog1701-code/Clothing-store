{% extends 'base.html' %}

{% block title %}{% if form.instance.pk %}ØªØ¹Ø¯ÙŠÙ„{% else %}Ø¥Ø¶Ø§ÙØ©{% endif %} Ø¹Ù†ÙˆØ§Ù† - Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù„Ø§Ø¨Ø³{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient-primary text-white py-4">
                    <h3 class="mb-0">
                        <i class="bi bi-geo-alt-fill me-2"></i>
                        {% if form.instance.pk %}
                            ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                        {% else %}
                            Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯
                        {% endif %}
                    </h3>
                </div>
                <div class="card-body p-4">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}

                        <div class="mb-3">
                            <div class="input-group">
                                <input type="text" id="addrPlaceSearch" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù† Ø£Ùˆ Ø¹Ù†ÙˆØ§Ù†">
                                <button type="button" id="addrSearchBtn" class="btn btn-outline-secondary">Ø§Ø¨Ø­Ø«</button>
                            </div>
                            <div id="addrPlaceResults" class="list-group mt-2"></div>
                        </div>

                        <div class="position-relative mb-3">
                            <div id="addrMap" style="height: calc(100vh - 280px); border-radius: 12px; background: #f7f7f7;"></div>
                            <button type="button" id="addrGpsFab" class="btn btn-light position-absolute" style="top:10px; left:10px; border:1px solid #ddd; border-radius:50%; width:44px; height:44px; display:flex; align-items:center; justify-content:center;">ğŸ“</button>
                            <div class="position-absolute" style="top:10px; right:10px;">
                                <span id="addrDiag" class="badge bg-light text-dark"></span>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø®ØªØµØ±:</strong>
                                    <span id="addrSummary" class="text-muted">Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… GPS</span>
                                </div>
                                <div class="row g-2">
                                    <div class="col-md-4"><div class="small">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</div><div id="addrCity" class="fw-semibold"></div></div>
                                    <div class="col-md-4"><div class="small">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</div><div id="addrArea" class="fw-semibold"></div></div>
                                    <div class="col-md-4"><div class="small">Ø§Ù„Ø´Ø§Ø±Ø¹</div><div id="addrStreet" class="fw-semibold"></div></div>
                                </div>
                                <div class="mt-2"><span class="small">Plus Code</span> <span id="addrPlusCode" class="fw-semibold"></span></div>
                                <div class="mt-3">
                                    <label class="form-label">ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©</label>
                                    <textarea name="details" class="form-control" rows="2" placeholder="(Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØª/Ø§Ù„Ø´Ù‚Ø© Ø£Ùˆ Ø¹Ù„Ø§Ù…Ø© Ù…Ù…ÙŠØ²Ø©"></textarea>
                                </div>
                            </div>
                        </div>

                        <input type="hidden" name="city" id="addrCityInput">
                        <input type="hidden" name="area" id="addrAreaInput">
                        <input type="hidden" name="street" id="addrStreetInput">
                        <input type="hidden" name="latitude" id="addrLatitude" value="">
                        <input type="hidden" name="longitude" id="addrLongitude" value="">
                        <input type="hidden" name="accuracy_m" id="addrAccuracy" value="">
                        <input type="hidden" name="formatted_address" id="addrFormatted" value="">
                        <input type="hidden" name="provider" id="addrProvider" value="">
                        <input type="hidden" name="provider_place_id" id="addrPlaceId" value="">
                        <input type="hidden" name="plus_code" id="addrPlusInput" value="">
                        <input type="hidden" name="next" value="{{ request.GET.next|default:'' }}">

                        <div class="d-flex justify-content-between mb-3">
                            <a href="{% url 'address_list' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-return-right me-2"></i>Ø§Ù„Ø¹ÙˆØ¯Ø©
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                            </button>
                        </div>

                        <div id="legacyFields" style="display:none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                                {{ form.title }}
                                <div class="invalid-feedback">
                                    {{ form.title.errors }}
                                </div>
                                <small class="form-text text-muted">Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ù†Ø²Ù„ØŒ Ø§Ù„Ø¹Ù…Ù„</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.recipient_name.id_for_label }}" class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
                                {{ form.recipient_name }}
                                <div class="invalid-feedback">
                                    {{ form.recipient_name.errors }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.phone.id_for_label }}" class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                                {{ form.phone }}
                                <div class="invalid-feedback">
                                    {{ form.phone.errors }}
                                </div>
                                <small class="form-text text-muted">07xxxxxxxxx</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.postal_code.id_for_label }}" class="form-label">Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ</label>
                                {{ form.postal_code }}
                                <div class="invalid-feedback">
                                    {{ form.postal_code.errors }}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12 mb-3 d-flex align-items-center gap-2">
                                <button type="button" id="addrGpsBtn" class="btn btn-outline-primary btn-sm">Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
                                <span id="addrGpsSpinner" class="spinner-border spinner-border-sm" style="display:none;" aria-hidden="true"></span>
                                <span id="addrGpsStatus" class="text-muted small"></span>
                                <input type="hidden" id="addrLatitude" name="latitude">
                                <input type="hidden" id="addrLongitude" name="longitude">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.city.id_for_label }}" class="form-label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                                {{ form.city }}
                                <div class="invalid-feedback">
                                    {{ form.city.errors }}
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.district.id_for_label }}" class="form-label">Ø§Ù„Ø­ÙŠ</label>
                                {{ form.district }}
                                <div class="invalid-feedback">
                                    {{ form.district.errors }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.street.id_for_label }}" class="form-label">Ø§Ù„Ø´Ø§Ø±Ø¹</label>
                            {{ form.street }}
                            <div class="invalid-feedback">
                                {{ form.street.errors }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.building_number.id_for_label }}" class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰</label>
                            {{ form.building_number }}
                            <div class="invalid-feedback">
                                {{ form.building_number.errors }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.additional_info.id_for_label }}" class="form-label">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
                            {{ form.additional_info }}
                            <div class="invalid-feedback">
                                {{ form.additional_info.errors }}
                            </div>
                            <small class="form-text text-muted">ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</small>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.is_default }}
                                <label class="form-check-label" for="{{ form.is_default.id_for_label }}">
                                    ØªØ¹ÙŠÙŠÙ† ÙƒØ¹Ù†ÙˆØ§Ù† Ø§ÙØªØ±Ø§Ø¶ÙŠ
                                </label>
                            </div>
                        </div>
                        
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
.bg-gradient-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.form-control { border-radius: 10px; padding: 12px 15px; border: 2px solid #e9ecef; transition: all 0.3s ease; }
.form-control:focus { border-color: #667eea; box-shadow: 0 0 0 0.2rem rgba(102,126,234,.25); }
.form-control::placeholder { color: #6c757d; opacity: .7; }
</style>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
(function(){
    var mapEl = document.getElementById('addrMap');
    var summaryEl = document.getElementById('addrSummary');
    var cityEl = document.getElementById('addrCity');
    var areaEl = document.getElementById('addrArea');
    var streetEl = document.getElementById('addrStreet');
    var plusEl = document.getElementById('addrPlusCode');
    var cityIn = document.getElementById('addrCityInput');
    var areaIn = document.getElementById('addrAreaInput');
    var streetIn = document.getElementById('addrStreetInput');
    var latIn = document.getElementById('addrLatitude');
    var lonIn = document.getElementById('addrLongitude');
    var accIn = document.getElementById('addrAccuracy');
    var formattedIn = document.getElementById('addrFormatted');
    var providerIn = document.getElementById('addrProvider');
    var placeIdIn = document.getElementById('addrPlaceId');
    var plusIn = document.getElementById('addrPlusInput');
    var diagEl = document.getElementById('addrDiag');
    var searchInput = document.getElementById('addrPlaceSearch');
    var searchBtn = document.getElementById('addrSearchBtn');
    var resultsEl = document.getElementById('addrPlaceResults');
    var gpsFab = document.getElementById('addrGpsFab');

    function setSummary(place){
        var addr = place.address || {};
        var city = addr.city || addr.town || addr.village || addr.state || '';
        var area = addr.suburb || addr.neighbourhood || addr.quarter || addr.district || addr.county || '';
        var road = addr.road || '';
        var house = addr.house_number || '';
        var street = (road + (house ? ' ' + house : '')).trim();
        if(cityEl) cityEl.textContent = city;
        if(areaEl) areaEl.textContent = area;
        if(streetEl) streetEl.textContent = street;
        if(cityIn) cityIn.value = city;
        if(areaIn) areaIn.value = area;
        if(streetIn) streetIn.value = street;
        var dn = (place.display_name || '').split(',').slice(0,4).join(',');
        if(summaryEl) summaryEl.textContent = dn || street || city || 'ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
        if(place.plus_code){
            var pc = (place.plus_code.global_code || place.plus_code.compound_code || '').split(' ').shift();
            if(plusEl) plusEl.textContent = pc || '';
            if(plusIn) plusIn.value = pc || '';
        }
        if(formattedIn) formattedIn.value = place.display_name || '';
        if(providerIn) providerIn.value = place.provider || providerIn.value || '';
        if(placeIdIn) placeIdIn.value = place.place_id || placeIdIn.value || '';
    }

    function reverseGeocode(lat, lon){
        var key = window.GOOGLE_MAPS_API_KEY || '';
        if(key){
            var url = 'https://maps.googleapis.com/maps/api/geocode/json?latlng='+encodeURIComponent(lat+','+lon)+'&key='+encodeURIComponent(key);
            return fetch(url).then(function(r){return r.json()}).then(function(data){
                var res = (data && data.results && data.results[0]) || {};
                var comps = res.address_components || [];
                var addr = {};
                comps.forEach(function(c){
                    if(c.types.indexOf('locality')>-1){ addr.city = c.long_name; }
                    if(c.types.indexOf('administrative_area_level_1')>-1 && !addr.city){ addr.city = c.long_name; }
                    if(c.types.indexOf('sublocality')>-1 || c.types.indexOf('neighborhood')>-1){ addr.suburb = c.long_name; }
                    if(c.types.indexOf('route')>-1){ addr.road = c.long_name; }
                    if(c.types.indexOf('street_number')>-1){ addr.house_number = c.long_name; }
                });
                return { address: addr, display_name: res.formatted_address || '', provider: 'google', place_id: (res.place_id || ''), plus_code: data.plus_code || {} };
            }).catch(function(){ return fetch('/api/addresses/reverse-geocode/', { method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':document.querySelector('input[name="csrfmiddlewaretoken"]').value }, body: JSON.stringify({lat:lat,lng:lon}) }).then(function(r){return r.json()}); });
        }
        return fetch('/api/addresses/reverse-geocode/', { method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':document.querySelector('input[name="csrfmiddlewaretoken"]').value }, body: JSON.stringify({lat:lat,lng:lon}) }).then(function(r){return r.json()});
    }

    function forwardGeocode(q){
        return fetch('/api/addresses/autocomplete/?q='+encodeURIComponent(q)).then(function(r){return r.json()}).then(function(p){ return (p.results||[]).map(function(it){ return { display_name: it.label, address:{ city: it.city, suburb: it.area, road: it.street }, lat: it.lat, lon: it.lng, provider: it.provider, place_id: it.provider_place_id }; }); });
    }

    var map = null, marker = null, debTimer = null;
    function initMap(){
        if(!window.L || !mapEl){ if(diagEl){ diagEl.textContent = 'ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©'; } return; }
        map = L.map('addrMap', { zoomControl: true }).setView([33.3152, 44.3661], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
        marker = L.marker([33.3152, 44.3661], { draggable: true }).addTo(map);
        marker.on('dragend', function(){ var p = marker.getLatLng(); latIn.value = p.lat; lonIn.value = p.lng; debouncedLookup(p.lat, p.lng); });
        map.on('click', function(e){ latIn.value = e.latlng.lat; lonIn.value = e.latlng.lng; marker.setLatLng(e.latlng); debouncedLookup(e.latlng.lat, e.latlng.lng); });
        map.on('moveend', function(){ var c = map.getCenter(); latIn.value = c.lat; lonIn.value = c.lng; debouncedLookup(c.lat, c.lng); });
    }
    function debouncedLookup(lat, lon){ clearTimeout(debTimer); debTimer = setTimeout(function(){ reverseGeocode(lat, lon).then(function(place){ setSummary(place); formattedIn.value = place.display_name || ''; providerIn.value = place.provider || providerIn.value || ''; placeIdIn.value = place.place_id || placeIdIn.value || ''; }); }, 500); }

    function setFromCoords(lat, lon, acc){
        latIn.value = lat; lonIn.value = lon; accIn.value = acc || '';
        if(map){ marker.setLatLng([lat, lon]); map.setView([lat, lon], map.getZoom()||15); }
        reverseGeocode(lat, lon).then(function(place){ setSummary(place); }).catch(function(){ if(summaryEl){ summaryEl.textContent = '('+parseFloat(lat).toFixed(6)+', '+parseFloat(lon).toFixed(6)+')'; } });
    }

    if(gpsFab){ gpsFab.addEventListener('click', function(){ if(!navigator.geolocation){ if(diagEl){ diagEl.textContent = 'Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS'; } return; } var secure = (location.protocol==='https:' || location.hostname==='localhost' || location.hostname==='127.0.0.1'); if(!secure){ if(diagEl){ diagEl.textContent = 'ÙŠØªØ·Ù„Ø¨ GPS Ø§ØªØµØ§Ù„Ø§Ù‹ Ø¢Ù…Ù†Ø§Ù‹ (HTTPS)'; } return; } gpsFab.disabled=true; diagEl.textContent='Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...'; navigator.geolocation.getCurrentPosition(function(pos){ var lat = pos.coords.latitude, lon = pos.coords.longitude, acc = pos.coords.accuracy||''; gpsFab.disabled=false; diagEl.textContent=''; setFromCoords(lat, lon, acc); }, function(err){ gpsFab.disabled=false; var msg='ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'; if(err && err.code===1){ msg='ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù† Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'; } else if(err && err.code===2){ msg='Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹'; } else if(err && err.code===3){ msg='Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'; } if(diagEl){ diagEl.textContent = msg; } }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }); }); }

    if(searchBtn){ function render(items){ resultsEl.innerHTML=''; (items||[]).forEach(function(it){ var a=document.createElement('a'); a.href='#'; a.className='list-group-item list-group-item-action'; a.textContent = it.display_name || 'Ù†ØªÙŠØ¬Ø©'; a.addEventListener('click', function(ev){ ev.preventDefault(); latIn.value=it.lat; lonIn.value=it.lon; if(map){ marker.setLatLng([it.lat,it.lon]); map.setView([it.lat,it.lon], 15); } setSummary(it); formattedIn.value = it.display_name || ''; providerIn.value = it.provider || 'nominatim'; placeIdIn.value = it.place_id || ''; }); resultsEl.appendChild(a); }); }
        var d=null; function trigger(){ var q=(searchInput.value||'').trim(); if(!q){ resultsEl.innerHTML=''; return; } clearTimeout(d); d=setTimeout(function(){ forwardGeocode(q).then(function(items){ render(items); }).catch(function(){ resultsEl.innerHTML=''; }); }, 300); }
        searchBtn.addEventListener('click', function(){ trigger(); }); searchInput.addEventListener('keyup', function(){ trigger(); }); }

    initMap();
})();
</script>
{% endblock %}
