{% extends 'base.html' %}
{% load math_filters %}

{% block title %}السلة{% endblock %}

{% block extra_css %}
<style>
.cart-page{direction:rtl;background:#f8f9fa}
.cart-grid{display:grid;grid-template-columns:70% 30%;gap:24px}
@media(max-width:991px){.cart-grid{grid-template-columns:1fr}}
/* Item card */
.item-card{display:grid;grid-template-columns:140px 1fr 180px;gap:16px;align-items:center;background:#fff;border:1px solid #eaeaea;border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.item-image img{width:140px;height:140px;border-radius:14px;object-fit:cover}
.item-title{font-weight:800;font-size:18px;margin-bottom:4px;color:#111}
.item-details{font-size:16px;color:#333;margin-bottom:8px}
.chip{display:inline-block;background:#f5f5f5;border:1px solid #ddd;border-radius:12px;padding:4px 8px;margin-inline-end:6px;font-size:12px}
.cart-item__price{justify-self:end;text-align:end}
.cart-item__price .price-base{font-weight:800;font-size:20px;color:#111}
.cart-item__price .subtotal{margin-top:6px;color:#444;font-size:14px}
.cart-item__price .price-proposed{display:inline-block;margin-top:8px;background:#eaffd0;border:1px solid #c9e7a7;color:#2f6b00;padding:6px 10px;border-radius:12px;font-weight:700}
.cart-item__price .price-proposed .price-status{margin-inline-start:8px;color:#555;font-weight:700}
.item-actions{display:flex;justify-content:flex-end;align-items:center;gap:10px}
.qty{display:flex;gap:8px;align-items:center}
.qty input{width:64px;text-align:center;border:1px solid #ddd;border-radius:8px;padding:8px}
.qty button{border:1px solid #ddd;background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
.remove-btn{border:none;background:#fff;color:#d9534f;cursor:pointer}
/* Summary */
.summary{position:sticky;top:16px;background:#fff;border:1px solid #eaeaea;border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,0.06);height:max-content;color:#111}
.summary-row{display:flex;justify-content:space-between;margin:8px 0;color:#111}
.summary-total{display:flex;justify-content:space-between;border-top:1px solid #eee;padding-top:12px;font-weight:800}
.primary{display:block;text-align:center;background:#ff6a00;color:#fff;padding:14px;border-radius:12px;text-decoration:none;margin-top:14px;font-weight:700}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:52vh}
.cta{display:inline-block;background:#ff6a00;color:#fff;border-radius:12px;padding:12px 24px;text-decoration:none;margin-top:12px}
.toast{position:fixed;bottom:70px;left:0;right:0;display:none}
.toast .box{margin:0 auto;background:#111;color:#fff;padding:10px 14px;border-radius:10px;max-width:280px;text-align:center}
</style>
{% endblock %}

{% block content %}
<div class="container cart-page">
  {% if cart_items %}
  <div class="cart-grid">
    <div>
      {% for item in cart_items %}
      <div class="item-card cart-card" data-index="{{ forloop.counter0 }}" data-pid="{{ item.product.id }}" data-vid="{{ item.variant.id|default:'' }}" data-unit="{{ item.price }}">
        <div class="item-image">{% if item.image_url %}<img src="{{ item.image_url }}" alt="">{% endif %}</div>
        <div>
          <div class="item-title">{{ item.product.name }}</div>
          <div class="item-details">{% if item.variant %}Color: {{ item.variant.color }} • Size: {{ item.variant.size }}{% endif %}</div>
        </div>
        <div class="item-actions">
          <div class="cart-item__price">
            <div class="price-base">{{ item.price|iqd }}</div>
            {% if item.negotiated_price %}
            <div class="price-proposed">
              <span>Proposed:</span> {{ item.negotiated_price|iqd }}
              {% if item.proposal_status %}
              <span class="price-status">
                {% if item.proposal_status == 'pending' %}Pending Approval{% elif item.proposal_status == 'approved' %}Approved{% elif item.proposal_status == 'rejected' %}Rejected{% endif %}
              </span>
              {% endif %}
            </div>
            {% endif %}
            <div class="subtotal">{{ item.subtotal|iqd }}</div>
          </div>
          <div class="qty"><button class="dec">−</button><input type="number" value="{{ item.quantity }}" min="1"><button class="inc">+</button></div>
          <button class="remove-btn del-btn">حذف</button>
        </div>
      </div>
      {% endfor %}
    </div>
    <div class="summary">
      <div class="summary-row"><span>عدد القطع</span><span id="sumItems">{{ items_count }}</span></div>
      <div class="summary-row"><span>المجموع</span><span id="sumProducts">{{ total|iqd }}</span></div>
      <a href="{% url 'checkout' %}" class="primary">اتمام الطلب</a>
    </div>
  </div>
  {% else %}
  <div class="empty"><div style="font-size:22px;color:#777">Your cart is empty</div><a href="{% url 'store_list' %}" class="cta">Back to Shopping</a></div>
  {% endif %}
  <div id="toast" class="toast"><div class="box"></div></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function fIQD(v){var n=Math.round(Number(v)||0);return n.toLocaleString('en-US')+' د.ع'}
function csrf(){var m=document.cookie.match(/csrftoken=([^;]+)/);return m?m[1]:''}
function showToast(t){var a=document.getElementById('toast');if(!a)return;a.querySelector('.box').textContent=t;a.style.display='block';setTimeout(function(){a.style.display='none'},6000)}
function reindex(){document.querySelectorAll('[data-index]').forEach(function(el,i){el.dataset.index=i})}
function recalc(){var sum=0;var count=0;document.querySelectorAll('.cart-card').forEach(function(c){var unit=parseFloat(c.dataset.unit||'0');var qty=parseInt(c.querySelector('.qty input').value||'1');var sub=unit*qty;sum+=sub;count+=qty;var subEl=c.querySelector('.subtotal');if(subEl){subEl.textContent=fIQD(sub)}});var sumEl=document.getElementById('sumProducts');if(sumEl){sumEl.textContent=fIQD(sum)}var cntEl=document.getElementById('sumItems');if(cntEl){cntEl.textContent=count}document.querySelectorAll('.sumTotal').forEach(function(el){el.textContent=fIQD(sum)});var btn=document.querySelector('#goCheckout .btn-total');if(btn){btn.textContent=fIQD(sum)}}
function addQty(pid,vid,q){return fetch('/cart/add/'+pid+'/',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrf()},body:JSON.stringify({variant_id:vid,quantity:q})}).then(function(r){return r.json().catch(function(){return {}})})}
function removeAt(idx){return fetch('{% url "remove_from_cart" 0 %}'.replace('0',idx),{method:'POST',headers:{'X-CSRFToken':csrf()}}).then(function(){return {}})}
document.addEventListener('DOMContentLoaded',function(){
  document.querySelectorAll('.qty .inc').forEach(function(b){b.addEventListener('click',function(){var card=b.closest('.cart-card');var pid=card.dataset.pid;var vid=card.dataset.vid||null;var input=card.querySelector('input');var val=parseInt(input.value||'1')+1;b.disabled=true;addQty(pid,vid,1).then(function(){input.value=val;recalc();showToast('تم تحديث الكمية')}).catch(function(){showToast('تعذر التحديث')}).finally(function(){b.disabled=false})})});
  document.querySelectorAll('.qty .dec').forEach(function(b){b.addEventListener('click',function(){var card=b.closest('.cart-card');var pid=card.dataset.pid;var vid=card.dataset.vid||null;var idx=parseInt(card.dataset.index);var input=card.querySelector('input');var val=Math.max(0,parseInt(input.value||'1')-1);if(val===0){b.disabled=true;removeAt(idx).then(function(){card.remove();reindex();recalc();showToast('تم حذف المنتج')}).catch(function(){showToast('تعذر التحديث')}).finally(function(){b.disabled=false});return}b.disabled=true;removeAt(idx).then(function(){return addQty(pid,vid,val)}).then(function(){input.value=val;recalc();showToast('تم تحديث الكمية')}).catch(function(){showToast('تعذر التحديث')}).finally(function(){b.disabled=false})})});
  document.querySelectorAll('.del-btn').forEach(function(b){b.addEventListener('click',function(){var card=b.closest('.cart-card');var idx=parseInt(card.dataset.index);b.disabled=true;removeAt(idx).then(function(){card.remove();reindex();recalc();showToast('تم حذف المنتج')}).catch(function(){showToast('تعذر الحذف')}).finally(function(){b.disabled=false})})});
  recalc()
})
</script>
{% endblock %}
