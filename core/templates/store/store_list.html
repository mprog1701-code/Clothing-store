{% extends 'base.html' %}
{% load static %}
{% load math_filters %}

{% block extra_css %}
<style>
    :root {
        --copper: #B87333;
        --copper-light: #D4A574;
        --copper-dark: #8B4513;
        --black: #000000;
        --black-light: #1a1a1a;
        --gold: #FFD700;
    }

    body {
        background: linear-gradient(135deg, var(--black) 0%, var(--black-light) 100%);
        color: #ffffff;
    }

    .fashion-header {
        background: linear-gradient(135deg, var(--copper) 0%, var(--copper-dark) 100%);
        padding: 30px 0;
        margin-bottom: 40px;
    }

    .page-title {
        font-size: 2.5rem;
        font-weight: 900;
        color: var(--gold);
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        margin-bottom: 10px;
    }

    .page-subtitle {
        color: #ffffff;
        font-size: 1.2rem;
        opacity: 0.9;
    }

    .showcase { background: linear-gradient(135deg, var(--black) 0%, var(--black-light) 100%); border: 2px solid var(--copper); border-radius: 18px; padding: 12px; margin-bottom: 24px; position: relative; overflow: hidden; }
    .showcase-track { display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 12px; align-items: stretch; }
    .showcase-card { background: #0f0f0f; border: 1px solid rgba(255,255,255,0.15); border-radius: 14px; overflow: hidden; cursor: pointer; transition: transform .2s ease, box-shadow .2s ease; }
    .showcase-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(184,115,51,.25); }
    .showcase-img { width: 100%; height: 130px; object-fit: cover; display: block; border-bottom: 1px solid rgba(255,255,255,0.15); }
    .showcase-info { padding: 10px; }
    .showcase-title { color: var(--gold); font-weight: 800; font-size: .95rem; margin-bottom: 4px; }
    .showcase-store { color: #bbb; font-size: .8rem; }
    .showcase-price { color: var(--copper-light); font-weight: 700; font-size: .9rem; }
    .showcase-controls { position: absolute; top: 8px; left: 8px; display: flex; gap: 6px; }
    .showcase-btn { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.35); color: #fff; padding: 6px 10px; border-radius: 20px; font-size: .85rem; font-weight: 700; }

    .category-filters {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
        border: 1px solid var(--copper-light);
    }

    .filter-label {
        color: var(--gold);
        font-weight: 700;
        margin-bottom: 8px;
        display: inline-block;
    }

    .filter-select {
        width: 100%;
        background: transparent;
        color: var(--copper-light);
        border: 2px solid var(--copper);
        border-radius: 25px;
        padding: 10px 16px;
        font-weight: bold;
        appearance: none;
    }

    .filter-select:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .filter-btn {
        background: transparent;
        border: 2px solid var(--copper);
        color: var(--copper-light);
        padding: 10px 20px;
        border-radius: 25px;
        margin: 5px;
        transition: all 0.3s ease;
        font-weight: bold;
    }

    .filter-btn:hover,
    .filter-btn.active {
        background: var(--copper);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(184, 115, 51, 0.4);
    }

    .store-card {
        background: linear-gradient(135deg, var(--black-light) 0%, var(--black) 100%);
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 30px;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        height: 100%;
    }

    .store-card:hover {
        border-color: var(--copper);
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(184, 115, 51, 0.3);
    }

    .store-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 15px;
        margin-bottom: 20px;
        border: 3px solid var(--copper);
    }

    .store-name {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--gold);
        margin-bottom: 10px;
    }

    .store-category {
        background: var(--copper);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        display: inline-block;
        margin-bottom: 15px;
    }

    .store-description {
        color: #cccccc;
        margin-bottom: 20px;
        line-height: 1.6;
    }

    .store-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .store-location {
        color: var(--copper-light);
        font-size: 0.9rem;
    }

    .store-rating {
        color: var(--gold);
        font-weight: bold;
    }

    .visit-store-btn {
        background: linear-gradient(45deg, var(--copper), var(--copper-dark));
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: bold;
        transition: all 0.3s ease;
        width: 100%;
    }

    .visit-store-btn:hover {
        background: linear-gradient(45deg, var(--copper-dark), var(--copper));
        transform: scale(1.05);
        box-shadow: 0 5px 20px rgba(184, 115, 51, 0.4);
    }

    .coming-soon-card {
        opacity: 0.6;
        position: relative;
    }

    .coming-soon-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2;
    }

    .coming-soon-text {
        color: var(--gold);
        font-size: 1.5rem;
        font-weight: bold;
        text-align: center;
        border: 2px solid var(--gold);
        padding: 20px;
        border-radius: 15px;
        background: rgba(0,0,0,0.9);
    }

    .no-stores {
        text-align: center;
        padding: 60px 20px;
        background: rgba(255,255,255,0.1);
        border-radius: 20px;
        margin: 30px 0;
    }

    .no-stores-icon {
        font-size: 4rem;
        color: var(--copper);
        margin-bottom: 20px;
    }

    .no-stores-title {
        color: var(--gold);
        font-size: 1.5rem;
        margin-bottom: 10px;
    }

    .no-stores-text {
        color: #cccccc;
        font-size: 1.1rem;
    }

    @media (max-width: 768px) {
        .page-title {
            font-size: 2rem;
        }
        
        .category-filters {
            text-align: center;
        }
        
        .filter-btn {
            margin: 3px;
            font-size: 0.9rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Fashion Header -->
<div class="fashion-header">
    <div class="container">
        <div class="row">
            <div class="col-12 text-center">
                <h1 class="page-title">متاجر الأزياء</h1>
                <p class="page-subtitle">أحدث صيحات الموضة من أفضل المتاجر • الخدمة متاحة في بغداد فقط الآن</p>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="showcase">
        <div class="showcase-controls">
            <button class="showcase-btn" id="scPrev">السابق</button>
            <button class="showcase-btn" id="scNext">التالي</button>
        </div>
        <div class="showcase-track" id="showcaseTrack">
            {% for p in showcase_products %}
            <div class="showcase-card" onclick="window.location.href='{% url 'product_detail' p.id %}'">
                {% if p.main_image %}
                    {% with url=p.main_image.get_image_url %}
                        {% if url %}
                            <img src="{{ url }}" alt="{{ p.name }}" class="showcase-img">
                        {% else %}
                            <div class="showcase-img" style="background: linear-gradient(45deg, var(--copper), var(--copper-dark)); display:flex; align-items:center; justify-content:center; color:#fff;">
                                <i class="bi bi-bag" style="font-size:2rem;"></i>
                            </div>
                        {% endif %}
                    {% endwith %}
                {% elif p.images.all %}
                    {% with img=p.images.all|first %}
                        {% if img %}
                            {% with url=img.get_image_url %}
                                {% if url %}
                                    <img src="{{ url }}" alt="{{ p.name }}" class="showcase-img">
                                {% else %}
                                    <div class="showcase-img" style="background: linear-gradient(45deg, var(--copper), var(--copper-dark)); display:flex; align-items:center; justify-content:center; color:#fff;">
                                        <i class="bi bi-bag" style="font-size:2rem;"></i>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            <div class="showcase-img" style="background: linear-gradient(45deg, var(--copper), var(--copper-dark)); display:flex; align-items:center; justify-content:center; color:#fff;">
                                <i class="bi bi-bag" style="font-size:2rem;"></i>
                            </div>
                        {% endif %}
                    {% endwith %}
                {% else %}
                <div class="showcase-img" style="background: linear-gradient(45deg, var(--copper), var(--copper-dark)); display:flex; align-items:center; justify-content:center; color:#fff;">
                    <i class="bi bi-bag" style="font-size:2rem;"></i>
                </div>
                {% endif %}
                <div class="showcase-info">
                    <div class="showcase-title">{{ p.name|truncatechars:32 }}</div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="showcase-store">{{ p.store.name|truncatechars:22 }}</div>
                        <div class="showcase-price">{{ p.base_price|iqd }}</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <!-- Category Filters -->
    <div class="category-filters">
        <div class="row g-3 align-items-end">
            <div class="col-md-6">
                <label class="filter-label"><i class="bi bi-grid me-2"></i>الفئة</label>
                <select id="categorySelect" class="filter-select" onchange="applyFilters()">
                    <option value="" {% if not selected_category %}selected{% endif %}>الكل</option>
                    {% for val, name in store_categories %}
                    <option value="{{ val }}" {% if selected_category == val %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label class="filter-label"><i class="bi bi-geo-alt me-2"></i>المحافظة</label>
                <select id="citySelect" class="filter-select" onchange="applyFilters()">
                    <option value="" {% if not selected_city %}selected{% endif %}>الكل</option>
                    {% for c in cities %}
                    <option value="{{ c }}" {% if c == selected_city %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Stores Grid -->
    <div class="row">
        {% for store in stores %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="store-card">
                {% if store.main_logo_url %}
                    <img src="{{ store.main_logo_url }}" alt="{{ store.name }}" class="store-image">
                {% else %}
                    <div class="store-image d-flex align-items-center justify-content-center" 
                         style="background: linear-gradient(45deg, var(--copper), var(--copper-dark)); color: white;">
                        <i class="bi bi-shop" style="font-size: 4rem;"></i>
                    </div>
                {% endif %}
                
                <h3 class="store-name">{{ store.name }}</h3>
                <span class="store-category">{{ store.get_category_display }}</span>
                <p class="store-description">{{ store.description|default:"متجر متخصص في أحدث صيحات الموضة"|truncatewords:15 }}</p>
                
                <div class="store-info">
                    <div class="store-location">
                        <i class="bi bi-geo-alt"></i> {{ store.city }}
                    </div>
                    <div class="store-rating">
                        <i class="bi bi-star-fill"></i> {{ store.rating|default:"4.5" }}
                    </div>
                </div>
                
                <button class="visit-store-btn" onclick="window.location.href='{% url 'store_detail' store.id %}'">
                    <i class="bi bi-bag-heart"></i> تسوق الآن
                </button>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="no-stores">
                <i class="bi bi-bag-x no-stores-icon"></i>
                <h3 class="no-stores-title">لا توجد متاجر في هذا القسم حاليًا</h3>
                <p class="no-stores-text">سيتم إضافة متاجر جديدة قريبًا</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
    function applyFilters() {
        const categoryEl = document.getElementById('categorySelect');
        const cityEl = document.getElementById('citySelect');
        const category = categoryEl ? categoryEl.value : '';
        const city = cityEl ? cityEl.value : '';
        const params = new URLSearchParams(window.location.search || '');
        params.delete('page');
        if (category) { params.set('category', category); } else { params.delete('category'); }
        if (city) { params.set('city', city); } else { params.delete('city'); }
        const url = '{% url 'store_list' %}' + (params.toString() ? ('?' + params.toString()) : '');
        window.location.href = url;
    }
    // Add to Cart Function
    function addToCart(productId) {
        const tokenMatch = document.cookie.match(/csrftoken=([^;]+)/);
        const csrfToken = tokenMatch ? tokenMatch[1] : '';
        fetch(`/cart/add/${productId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ quantity: 1 })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const count = parseInt(data.cart_items_count || 0);
                if (typeof updateCartBadge === 'function') {
                    updateCartBadge(count);
                }
                
                // Show success message
                showToast('تمت الإضافة إلى السلة بنجاح!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('حدث خطأ أثناء الإضافة إلى السلة');
        });
    }
    
    // Toast Notification
    function showToast(message) {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--copper);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 10000;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(184, 115, 51, 0.4);
            animation: slideIn 0.3s ease;
        `;
        toast.textContent = message;
        
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    (function(){
        const track = document.getElementById('showcaseTrack');
        const prev = document.getElementById('scPrev');
        const next = document.getElementById('scNext');
        let timer = null;
        function rotateForward(){ if(track && track.children.length>0){ track.appendChild(track.children[0]); } }
        function rotateBackward(){ if(track && track.children.length>0){ track.insertBefore(track.lastElementChild, track.firstElementChild); } }
        function start(){ stop(); timer = setInterval(rotateForward, 5000); }
        function stop(){ if(timer){ clearInterval(timer); timer=null; } }
        if(prev){ prev.addEventListener('click', function(){ rotateBackward(); start(); }); }
        if(next){ next.addEventListener('click', function(){ rotateForward(); start(); }); }
        start();
    })();
</script>
{% endblock %}
