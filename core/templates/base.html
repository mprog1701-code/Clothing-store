<!DOCTYPE html>
{% load static %}
{% load math_filters %}
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta name="theme-color" content="#c67a2b">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <link rel="manifest" href="{% static 'pwa/manifest.json' %}">
    <title>{% block title %}متجر الملابس | تسوق بثقة{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/theme.css' %}?v=4">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/theme-hotfix.css' %}">
    <!-- <link rel="stylesheet" href="{% static 'css/readability-rtl-fix.css' %}"> -->
    <script src="{% static 'js/theme.js' %}?v=4" defer></script>
    
        <style>
        /* CRITICAL: FONT LOCKDOWN */
        html, body, div, span, applet, object, iframe,
        h1, h2, h3, h4, h5, h6, p, blockquote, pre,
        a, abbr, acronym, address, big, cite, code,
        del, dfn, em, img, ins, kbd, q, s, samp,
        small, strike, strong, sub, sup, tt, var,
        b, u, center,
        dl, dt, dd, ol, ul, li,
        fieldset, form, label, legend,
        table, caption, tbody, tfoot, thead, tr, th, td,
        article, aside, canvas, details, embed, 
        figure, figcaption, footer, header, hgroup, 
        menu, nav, output, ruby, section, summary,
        time, mark, audio, video, input, textarea, select, button, .btn {
            font-family: 'Tajawal', sans-serif !important;
        }
        /* Fix icons breaking due to font override */
        i, .bi, .fa, .fas, .far, .fab, .material-icons, [class*=" icon-"], [class^="icon-"] {
            font-family: 'bootstrap-icons' !important;
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">جاري التحميل...</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
            <div class="container">
                <a class="navbar-brand" href="{% url 'home' %}">
                    <i class="bi bi-shop"></i> متجر الملابس
                </a>
                
                <button class="navbar-toggler" type="button" id="navbarTogglerBtn" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"
                        style="padding: 12px; border-radius: 10px; font-size: 1.2rem;">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto"></ul>
                    
                    <ul class="navbar-nav">
                        {% if user.is_authenticated %}
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-person-circle"></i> {{ user.username }}
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    {% if user.role == 'store_admin' or user.is_staff %}
                                    <li>
                                        <a class="dropdown-item" href="{% url 'main_dashboard' %}">
                                            <i class="bi bi-speedometer2"></i> لوحة التحكم
                                        </a>
                                    </li>
                                    {% endif %}
                                    {% if user.role == 'customer' and not user.is_staff %}
                                    <li>
                                        <a class="dropdown-item" href="{% url 'account_settings' %}">
                                            <i class="bi bi-person"></i> حسابي
                                        </a>
                                    </li>
                                    {% endif %}
                                    {% if user.is_superuser %}
                                    <li>
                                        <a class="dropdown-item" href="{% url 'super_owner_dashboard' %}">
                                            <i class="bi bi-crown"></i> لوحة تحكم المالك
                                        </a>
                                    </li>
                                    {% endif %}
                                    <li><a class="dropdown-item" href="{% url 'logout' %}">
                                        <i class="bi bi-box-arrow-left"></i> تسجيل الخروج
                                    </a></li>
                                </ul>
                            </li>
                        {% else %}
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'login' %}">
                                    <i class="bi bi-box-arrow-in-right"></i> تسجيل الدخول
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'register' %}">
                                    <i class="bi bi-person-plus"></i> تسجيل
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </nav>
        <script>
            function openAnnouncements(){
                window.location.assign('/announcements/');
            }
        </script>
        <script>
        (function(){
            // Removed manual scroll restoration which was causing sticky scroll issues
        })();
        </script>
        <script>
        (function(){
            function chunk(container, itemSelector, size, rowClass){
                if(!container) return;
                var mq = window.matchMedia && window.matchMedia('(max-width: 768px)');
                if(!(mq && mq.matches)) return;
                if(container.__chunked) return;
                var items = Array.prototype.slice.call(container.querySelectorAll(itemSelector));
                if(!items.length) return;
                container.__chunked = true;
                items.forEach(function(x){ x.parentNode === container && container.removeChild(x); });
                for(var i=0;i<items.length;i+=size){
                    var row=document.createElement('div');
                    row.className=rowClass;
                    // لا نضبط dir هنا حتى لا نغير اتجاه النصوص تلقائياً
                    for(var j=i;j<i+size && j<items.length;j++){ row.appendChild(items[j]); }
                    container.appendChild(row);
                }
            }
            function init(){
                chunk(document.querySelector('.category-grid'), '.category-card', 15, 'm-row-scroller cats');
                chunk(document.querySelector('.categories-grid'), '.category-card', 15, 'm-row-scroller cats');
                var na=document.querySelector('.new-arrivals-scroller');
                if(na && !na.hasAttribute('data-no-chunk') && !na.classList.contains('no-chunk')){
                    var sel='[class*=\"col-\"]';
                    if(na.querySelectorAll(sel).length){
                        chunk(na, sel, 15, 'm-row-scroller products');
                        try{ na.classList.add('chunked'); }catch(e){}
                    }
                }
                var sg=document.getElementById('storesGrid');
                if(sg){
                    var ssel='[class*=\"col-\"]';
                    if(sg.querySelectorAll(ssel).length){ 
                        chunk(sg, ssel, 15, 'm-row-scroller stores'); 
                        var btn=document.getElementById('loadMoreStores');
                        if(btn){ btn.style.display='none'; }
                    }
                }
            }
            if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
        })();
        </script>
        <!-- Main Content -->
        <main class="container-fluid px-0">
            {% if messages %}
                <div class="container mt-3">
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show custom-alert" role="alert">
                            <div class="d-flex align-items-center">
                                {% if 'success' in message.tags %}
                                    <i class="bi bi-check-circle-fill me-2"></i>
                                {% elif 'danger' in message.tags %}
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                {% elif 'warning' in message.tags %}
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                {% else %}
                                    <i class="bi bi-info-circle-fill me-2"></i>
                                {% endif %}
                                <span>{{ message }}</span>
                            </div>
                            <button type="button" class="btn-close btn-close-enhanced" data-bs-dismiss="alert" 
                                    style="width: 30px; height: 30px; padding: 8px; border-radius: 50%;">
                                <span class="visually-hidden">إغلاق</span>
                            </button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            

            <div class="app-container">
                {% block content %}{% endblock %}
            </div>
        </main>

        <div id="pwaInstallBanner" role="dialog" aria-hidden="true">
            <p class="banner-title">ثبّت التطبيق</p>
            <p class="banner-sub">افتحه مثل أي تطبيق من شاشة الهاتف</p>
            <div class="banner-actions">
                <button type="button" class="btn btn-gradient" id="pwaInstallBtn">تثبيت</button>
                <button type="button" class="btn btn-outline-secondary" id="pwaDismissBtn">لاحقاً</button>
            </div>
        </div>

        <nav class="global-bottom-nav">
            <div class="container">
                <div class="row">
                    <div class="col-3">
                        <a href="/" class="nav-item {% if request.path == '/' %}active{% endif %}">
                            <i class="bi bi-house nav-icon"></i>
                            <span class="nav-text" data-i18n="nav_home">الرئيسية</span>
                        </a>
                    </div>
                    <div class="col-3">
                        <a href="{% url 'store_list' %}" class="nav-item {% if request.path|slice:":8" == '/stores/' %}active{% endif %}">
                            <i class="bi bi-shop nav-icon"></i>
                            <span class="nav-text" data-i18n="nav_stores">المتاجر</span>
                        </a>
                    </div>
                    <div class="col-3">
                        <a href="{% url 'cart_view' %}" class="nav-item">
                            <span class="nav-icon-wrap">
                                <i class="bi bi-cart nav-icon"></i>
                                {% if request.path|slice:":6" != '/cart/' %}
                                    {% with count=request.session.cart|cart_count %}
                                    {% if count > 0 %}
                                    <span class="cart-badge">{{ count }}</span>
                                    {% endif %}
                                    {% endwith %}
                                {% endif %}
                            </span>
                            <span class="nav-text" data-i18n="nav_cart">السلة</span>
                        </a>
                    </div>
                    <div class="col-3">
                        <a href="{% url 'account_settings' %}" class="nav-item {% if request.path|slice:":12" == '/my/account/' %}active{% endif %}">
                            <i class="bi bi-person nav-icon"></i>
                            <span class="nav-text" data-i18n="nav_account">حسابي</span>
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Footer -->
        <footer class="footer mt-auto py-3">
            <div class="container text-center text-muted">
                <span>&copy; {% now "Y" %} {{ site_settings.site_name }}. جميع الحقوق محفوظة.</span>
            </div>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    (function(){
      var bs = window.bootstrap || {};
      var hasDropdown = typeof bs.Dropdown === 'function';
      var hasCollapse = typeof bs.Collapse === 'function';
      if(hasDropdown && hasCollapse) return;

      function qs(el, sel){ try{ return el ? el.querySelector(sel) : null; }catch(e){ return null; } }
      function qsa(el, sel){ try{ return el ? Array.from(el.querySelectorAll(sel)) : []; }catch(e){ return []; } }
      function closest(el, sel){ try{ return el && el.closest ? el.closest(sel) : null; }catch(e){ return null; } }

      function closeAllDropdowns(exceptMenu){
        qsa(document, '.dropdown-menu.show').forEach(function(menu){
          if(exceptMenu && menu === exceptMenu) return;
          menu.classList.remove('show');
          var t = menu.__toggleEl;
          if(t) t.setAttribute('aria-expanded','false');
        });
      }

      if(!hasDropdown){
        document.addEventListener('click', function(e){
          var toggle = closest(e.target, '[data-bs-toggle="dropdown"]');
          if(!toggle){
            closeAllDropdowns(null);
            return;
          }
          e.preventDefault();
          e.stopPropagation();
          var li = closest(toggle, '.dropdown') || toggle.parentElement;
          var menu = qs(li, '.dropdown-menu') || (toggle.nextElementSibling && toggle.nextElementSibling.classList && toggle.nextElementSibling.classList.contains('dropdown-menu') ? toggle.nextElementSibling : null);
          if(!menu) return;
          var willOpen = !menu.classList.contains('show');
          closeAllDropdowns(menu);
          if(willOpen){
            menu.classList.add('show');
            menu.__toggleEl = toggle;
            toggle.setAttribute('aria-expanded','true');
          }else{
            menu.classList.remove('show');
            toggle.setAttribute('aria-expanded','false');
          }
        }, true);
      }

      if(!hasCollapse){
        document.addEventListener('click', function(e){
          var btn = closest(e.target, '[data-bs-toggle="collapse"]');
          if(!btn) return;
          var sel = btn.getAttribute('data-bs-target') || btn.getAttribute('href') || '';
          if(!sel) return;
          if(sel.charAt(0) !== '#') return;
          var target = document.getElementById(sel.slice(1));
          if(!target) return;
          e.preventDefault();
          var open = target.classList.contains('show');
          if(open) target.classList.remove('show'); else target.classList.add('show');
        }, true);
      }

      document.addEventListener('keyup', function(e){
        if(e && e.key === 'Escape') closeAllDropdowns(null);
      });
    })();
    </script>
    <script>
    (function(){
      function initNavbarDropdown(){
        var toggle = document.getElementById('navbarDropdown');
        if(!toggle) return;
        var parent = toggle.parentElement;
        var menu = parent ? parent.querySelector('.dropdown-menu') : null;
        if(!menu) return;
        var instance = null;
        try{
          if(window.bootstrap && window.bootstrap.Dropdown){
            instance = window.bootstrap.Dropdown.getOrCreateInstance(toggle);
          }
        }catch(err){}
        function openMenu(){
          if(instance){ instance.show(); return; }
          menu.classList.add('show');
          toggle.setAttribute('aria-expanded','true');
        }
        function closeMenu(){
          if(instance){ instance.hide(); return; }
          menu.classList.remove('show');
          toggle.setAttribute('aria-expanded','false');
        }
        toggle.addEventListener('click', function(e){
          e.preventDefault();
          e.stopPropagation();
          if(menu.classList.contains('show')) closeMenu();
          else openMenu();
        }, true);
        document.addEventListener('click', function(e){
          if(toggle.contains(e.target) || menu.contains(e.target)) return;
          closeMenu();
        }, true);
      }
      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', initNavbarDropdown);
      } else {
        initNavbarDropdown();
      }
    })();
    </script>
    <div class="modal fade" id="multiStoreModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">سلة من متجر واحد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>لا يمكن الجمع بين متاجر مختلفة في سلة واحدة.</p>
                    <p class="text-muted mb-0">اختر الإجراء المناسب:</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" id="msCancelBtn">إلغاء</button>
                    <button type="button" class="btn btn-gradient" id="msClearBtn">افرغ السلة وابدأ من المتجر الجديد</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        (function(){
            // Removed conflicting theme enforcement script
        })();
        window.i18n = {
            ar: {
                nav_home: 'الرئيسية',
                nav_stores: 'المتاجر',
                nav_cart: 'السلة',
                nav_account: 'حسابي',
                account_language: 'اللغة',
                account_theme: 'مظهر التطبيق',
                account_notifications: 'الاشعارات',
                account_services: 'خدماتنا',
                account_about: 'عن شركتنا',
                account_merchant: 'صير تاجر ويانة',
                account_appicon: 'ايقونة التطبيق',
                account_login: 'تسجيل الدخول',
                account_register: 'تسجيل',
                account_logout: 'تسجيل الخروج',
                account_not_signed: 'غير مسجل',
                account_owner_login: 'دخول المالك',
                language_ar: 'العربية',
                language_en: 'English',
                language_ku: 'کوردی',
                theme_dark: 'داكن',
                theme_light: 'فاتح',
                theme_system: 'حسب النظام'
            },
            en: {
                nav_home: 'Home',
                nav_stores: 'Stores',
                nav_cart: 'Cart',
                nav_account: 'Account',
                account_language: 'Language',
                account_theme: 'App Theme',
                account_notifications: 'Notifications',
                account_services: 'Our Services',
                account_about: 'About Us',
                account_merchant: 'Become a Merchant',
                account_appicon: 'App Icon',
                account_login: 'Login',
                account_register: 'Register',
                account_logout: 'Logout',
                account_not_signed: 'Not signed in',
                account_owner_login: 'Owner Login',
                language_ar: 'Arabic',
                language_en: 'English',
                language_ku: 'Kurdî',
                theme_dark: 'Dark',
                theme_light: 'Light',
                theme_system: 'System'
            },
            ku: {
                nav_home: 'سەرەتا',
                nav_stores: 'فرۆشیگا',
                nav_cart: 'سەبەتە',
                nav_account: 'هەژمار',
                account_language: 'زمان',
                account_theme: 'ڕووخەی ئەپ',
                account_notifications: 'ئاگەدارییەکان',
                account_services: 'خزمەتگوزارییەکانمان',
                account_about: 'دەربارەی ئێمە',
                account_merchant: 'بە فرۆشیگار بێ',
                account_appicon: 'نیشانی ئەپلیکەیشن',
                account_login: 'چوونەژورەوە',
                account_register: 'تۆماربوون',
                account_logout: 'دەرچوون',
                account_not_signed: 'تۆمار نەکراوە',
                account_owner_login: 'چوونەژوورەوەی خاوند',
                language_ar: 'عەرەبی',
                language_en: 'ئینگلیزی',
                language_ku: 'کوردی',
                theme_dark: 'تاریک',
                theme_light: 'کاڵ',
                theme_system: 'بە سیستەم'
            }
        };
        function applyTranslations(lang){
            const dict=(window.i18n && window.i18n[lang])? window.i18n[lang] : window.i18n['ar'];
            document.querySelectorAll('[data-i18n]').forEach(el=>{
                const k=el.getAttribute('data-i18n');
                if(dict[k]) el.textContent=dict[k];
            });
        }
        function applyLanguageFromStorage(){
            let lang='ar';
            try{
                const stored=localStorage.getItem('siteLanguage');
                if(!stored || !window.i18n[stored]){
                    localStorage.setItem('siteLanguage','ar');
                    lang='ar';
                } else {
                    lang=stored;
                }
            }catch(e){ lang='ar'; }
            applyTranslations(lang);
        }
        applyLanguageFromStorage();
        window.addEventListener('languageChange',function(e){
            const lang=e.detail&&e.detail.lang? e.detail.lang : (localStorage.getItem('siteLanguage')||'ar');
            applyTranslations(lang);
        });
        
        // Cart functionality
            function updateCartCount() {
                const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
                const count = cart.reduce((sum, item) => sum + item.quantity, 0);
                const cartCountElement = document.getElementById('cart-count');
                if (cartCountElement) {
                    cartCountElement.textContent = count;
                    cartCountElement.style.display = count > 0 ? 'block' : 'none';
                }
            }
        
        // Loading functionality
        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }
        
        // Smooth scrolling
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const href = this.getAttribute('href') || '';
                if (!href || href === '#' || href.length <= 1) return;
                const id = href.slice(1);
                const target = document.getElementById(id);
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
        
        // Auto-hide non-critical alerts after 5 seconds
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert:not(.alert-danger)');
            alerts.forEach(alert => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            const isMobile = !!(window.matchMedia && window.matchMedia('(max-width: 680px)').matches);
            const reduceMotion = !!(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches);
            updateCartCount();
            hideLoading();
            try{ var h = String(location.hash||''); if(h === '#'){ history.replaceState(null, document.title, location.pathname + location.search); } }catch(e){}
            
            // Add animation to cards
            if(!isMobile && !reduceMotion){
                const cards = document.querySelectorAll('.card');
                const limit = Math.min(cards.length, 12);
                for(let i=0;i<limit;i++){
                    const card = cards[i];
                    card.style.animationDelay = `${i * 0.06}s`;
                    card.classList.add('animate__animated', 'animate__fadeInUp');
                }
            }
            
            // Enhanced button interactions
            const buttons = document.querySelectorAll('.btn, .btn-table-action, .btn-management, .quick-action-btn');
            buttons.forEach(button => {
                if(!isMobile && !reduceMotion){
                    button.addEventListener('click', function(e) {
                        const ripple = document.createElement('span');
                        const rect = this.getBoundingClientRect();
                        const size = Math.max(rect.width, rect.height);
                        const x = e.clientX - rect.left - size / 2;
                        const y = e.clientY - rect.top - size / 2;
                        
                        ripple.style.width = ripple.style.height = size + 'px';
                        ripple.style.left = x + 'px';
                        ripple.style.top = y + 'px';
                        ripple.classList.add('ripple');
                        
                        this.appendChild(ripple);
                        
                        setTimeout(() => {
                            ripple.remove();
                        }, 600);
                    });
                }
                
                if (button.type === 'submit' || (button.tagName === 'A' && button.href && (button.href.includes('/add') || button.href.includes('/edit')))) {
                    button.addEventListener('click', function() {
                        this.classList.add('btn-loading');
                        setTimeout(() => {
                            this.classList.remove('btn-loading');
                        }, 3000);
                    });
                }
            });
            
            // Enhanced hover effects for touch devices
            if ('ontouchstart' in window) {
                document.body.classList.add('touch-device');
                
                // Add active state on touch
                buttons.forEach(button => {
                    button.addEventListener('touchstart', function() {
                        this.classList.add('touch-active');
                    });
                    
                    button.addEventListener('touchend', function() {
                        setTimeout(() => {
                            this.classList.remove('touch-active');
                        }, 150);
                    });
                });
            }
            
            // Keyboard navigation enhancement
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    document.body.classList.add('keyboard-navigation');
                }
            });
            
            document.addEventListener('mousedown', function() {
                document.body.classList.remove('keyboard-navigation');
            });
            try{
                const shouldShow = sessionStorage.getItem('showAnnouncements') === '1';
                if(shouldShow){
                    sessionStorage.removeItem('showAnnouncements');
                    window.dispatchEvent(new CustomEvent('showAnnouncement'));
                }
            }catch(e){}
            const navLinks = document.querySelectorAll('.global-bottom-nav a.nav-item');
            navLinks.forEach(a => {
                a.addEventListener('click', function(e){
                    const href = this.getAttribute('href');
                    if(href){
                        e.preventDefault();
                        window.location.assign(href);
                    }
                });
            });
            try{
                const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
                if(isMobile){
                    document.querySelectorAll('a[target=_blank]').forEach(a=>{ a.removeAttribute('target'); a.rel='noopener'; });
                    const special = document.querySelectorAll('a[href^="tel:"], a[href^="mailto:"], a[href*="wa.me"], a[href^="whatsapp:"]');
                    special.forEach(a=>{
                        a.addEventListener('click', function(ev){ ev.preventDefault(); const href=this.getAttribute('href'); if(href){ try{ window.location.assign(href); }catch(err){ window.location.href=href; } } });
                    });
                    const originalOpen = window.open;
                    window.open = function(url){ try{ window.location.assign(url); } catch(e){ window.location.href = url; } return null; };
                }
            }catch(e){}
            try{
                const navCart = document.querySelector('.global-bottom-nav a.nav-item[href$="/cart/"]');
                if(navCart){
                    const wrap = navCart.querySelector('.nav-icon-wrap');
                    const stray = navCart.querySelector(':scope > .cart-badge');
                    if(stray && wrap){ wrap.appendChild(stray); }
                }
            }catch(e){}
        });
        
        // CSRF helper
        function getCsrfToken(){
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta && meta.content && meta.content !== 'NOTPROVIDED') return meta.content;
            const m = document.cookie.match(/csrftoken=([^;]+)/);
            return m ? m[1] : '';
        }
        // Add to cart via server
        function addToCart(productId, variantId = null, quantity = 1, storeId = null) {
            showLoading();
            const csrfToken = getCsrfToken();
            const body = { productId: productId, quantity: quantity };
            if (variantId) body.variantId = variantId;
            if (storeId) body.storeId = storeId;
            fetch('/cart/items', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                body: JSON.stringify(body)
            })
            .then(function(r){ return r.json().then(function(j){ return { ok: r.ok, status: r.status, data: j }; }); })
            .then(function(res){
                if (res.ok && res.data && res.data.ok) {
                    try {
                        if (typeof res.data.cart_items_count !== 'undefined') {
                            updateCartBadge(parseInt(res.data.cart_items_count || 0));
                        }
                    } catch(e) {}
                    const toast = document.createElement('div');
                    toast.className = 'position-fixed top-0 end-0 p-3';
                    toast.style.zIndex = '9999';
                    toast.innerHTML = `
                        <div class="toast show animate__animated animate__slideInRight" role="alert">
                            <div class="toast-header bg-success text-white">
                                <i class="bi bi-check-circle-fill me-2"></i>
                                <strong class="me-auto">تمت الإضافة</strong>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                            </div>
                            <div class="toast-body">تمت إضافة المنتج إلى السلة بنجاح!</div>
                        </div>
                    `;
                    document.body.appendChild(toast);
                    setTimeout(function(){ toast.remove(); }, 6000);
                } else {
                    if (res.status === 409 && res.data && res.data.code === 'MULTI_STORE_NOT_ALLOWED') {
                        try { window._pendingAdd = { productId: productId, variantId: variantId, quantity: quantity, storeId: storeId, details: res.data }; } catch(e){}
                        const modalEl = document.getElementById('multiStoreModal');
                        if (modalEl) { new bootstrap.Modal(modalEl).show(); }
                        hideLoading();
                        return;
                    }
                    const code = res.data && res.data.code;
                    const msgMap = {
                        'VARIANT_REQUIRED': 'اختر اللون/القياس قبل الإضافة للسلة.',
                        'INVALID_VARIANT': 'الخيار المختار غير صالح. اختر مرة أخرى.',
                        'OUT_OF_STOCK': 'المنتج نفد حالياً.',
                        'INSUFFICIENT_STOCK': 'الكمية المطلوبة غير متوفرة.',
                        'MULTI_STORE_NOT_ALLOWED': 'لا يمكن الجمع بين متاجر مختلفة في سلة واحدة.',
                        'CHECKOUT_STOCK_FAILED': 'بعض المنتجات تغير مخزونها. تم تحديث سلتك.'
                    };
                    const msg = (code && msgMap[code]) ? msgMap[code] : ((res.data && res.data.message) ? res.data.message : 'تعذر إضافة المنتج إلى السلة');
                    const toast = document.createElement('div');
                    toast.className = 'position-fixed top-0 end-0 p-3';
                    toast.style.zIndex = '9999';
                    toast.innerHTML = `
                        <div class="toast show animate__animated animate__slideInRight" role="alert">
                            <div class="toast-header bg-danger text-white">
                                <i class="bi bi-x-circle-fill me-2"></i>
                                <strong class="me-auto">فشل الإضافة</strong>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                            </div>
                            <div class="toast-body">${msg}</div>
                        </div>
                    `;
                    document.body.appendChild(toast);
                    setTimeout(function(){ toast.remove(); }, 3000);
                    if (code === 'VARIANT_REQUIRED' && productId) {
                        try { openQuickVariantPicker(productId); } catch(e) {}
                    }
                }
                hideLoading();
            })
            .catch(function(){ hideLoading(); });
        }
        (function(){
            const clearBtn = document.getElementById('msClearBtn');
            const cancelBtn = document.getElementById('msCancelBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', function(){
                    const csrfToken = getCsrfToken();
                    fetch('/cart/clear/', { method: 'DELETE', credentials: 'same-origin', headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' } })
                    .then(function(r){ return r.json().then(function(j){ return { ok:r.ok, status:r.status, data:j }; }); })
                    .then(function(){
                        try{
                            const p = window._pendingAdd || {};
                            const modalEl = document.getElementById('multiStoreModal');
                            if (modalEl) { bootstrap.Modal.getInstance(modalEl)?.hide(); }
                            addToCart(p.productId, p.variantId, p.quantity, p.storeId);
                            window._pendingAdd = null;
                        }catch(e){}
                    });
                });
            }
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function(){
                    try{ window._pendingAdd = null; }catch(e){}
                });
            }
        })();
        function updateCartBadge(count){
            try{
                const inCartPage = (window.location.pathname || '').startsWith('/cart/');
                const navCart = document.querySelector('.global-bottom-nav a.nav-item[href$="/cart/"]');
                if(!navCart) return;
                const wrap = navCart.querySelector('.nav-icon-wrap') || navCart;
                let badge = wrap.querySelector('.cart-badge');
                if(!badge){
                    badge = document.createElement('span');
                    badge.className = 'cart-badge';
                    wrap.appendChild(badge);
                }
                badge.textContent = String(count);
                badge.style.display = (!inCartPage && count > 0) ? 'flex' : 'none';
            }catch(e){}
        }

        // Quick Variant Picker (global, lightweight, mobile-friendly)
        (function(){
            var qpOverlay = null, qpSheet = null, qpCloseBtn = null;
            var qpColor = null, qpSize = null, qpQty = null, qpAddBtn = null;
            var qpCurrent = { productId: null, storeId: null, variants: [] };
            function ensureQuickPicker(){
                if(qpOverlay) return;
                qpOverlay = document.createElement('div');
                qpOverlay.id = 'qpOverlay';
                qpOverlay.style.cssText = 'position:fixed;inset:0;display:none;align-items:flex-end;z-index:1060;background:rgba(0,0,0,.35)';
                qpSheet = document.createElement('div');
                qpSheet.id = 'qpSheet';
                qpSheet.style.cssText = 'background:#fff;color:#111;width:100%;max-width:540px;margin:0 auto;border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:0 -6px 24px rgba(0,0,0,.2);transform:translateY(100%);transition:transform .18s ease;';
                qpSheet.innerHTML = '<div style="padding:12px 16px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center"><strong>اختيار النسخة</strong><button type="button" id="qpClose" class="btn btn-sm btn-outline-secondary">إغلاق</button></div>'+
                    '<div style="padding:12px 16px">'+
                    '<div class="mb-2"><label class="form-label">اللون</label><select id="qpColor" class="form-select"><option value="">اختر اللون</option></select></div>'+
                    '<div class="mb-2"><label class="form-label">المقاس</label><select id="qpSize" class="form-select" disabled><option value="">اختر المقاس</option></select></div>'+
                    '<div class="mb-3"><label class="form-label">الكمية</label><input id="qpQty" type="number" class="form-control" value="1" min="1" style="max-width:120px"></div>'+
                    '<div class="text-end"><button type="button" id="qpAdd" class="btn btn-primary">أضف للسلة</button></div>'+
                    '</div>';
                qpOverlay.appendChild(qpSheet);
                document.body.appendChild(qpOverlay);
                qpCloseBtn = qpSheet.querySelector('#qpClose');
                qpColor = qpSheet.querySelector('#qpColor');
                qpSize = qpSheet.querySelector('#qpSize');
                qpQty = qpSheet.querySelector('#qpQty');
                qpAddBtn = qpSheet.querySelector('#qpAdd');
                qpOverlay.addEventListener('click', function(e){ if(e.target===qpOverlay) closeQuickPicker(); });
                qpCloseBtn.addEventListener('click', closeQuickPicker);
                qpColor.addEventListener('change', updateSizes);
                qpSize.addEventListener('change', function(){
                    var opt = qpSize.options[qpSize.selectedIndex];
                    var stock = opt ? parseInt(opt.getAttribute('data-stock')||'0') : 0;
                    qpQty.value = 1;
                    qpQty.max = stock>0 ? stock : 1;
                });
                qpAddBtn.addEventListener('click', function(){
                    var color = qpColor.value;
                    var size = qpSize.value;
                    if(!color || !size) return;
                    var v = qpCurrent.variants.find(function(x){ return x.color===color && x.size===size; });
                    if(!v || !v.id) return;
                    var qty = parseInt(qpQty.value||'1')||1;
                    try{ addToCart(qpCurrent.productId, v.id, qty, qpCurrent.storeId); }catch(e){}
                    // auto close after 3s
                    try{ setTimeout(closeQuickPicker, 3000); }catch(e){}
                });
            }
            function openQuickVariantPicker(productId){
                ensureQuickPicker();
                qpCurrent.productId = productId; qpCurrent.storeId = null; qpCurrent.variants = [];
                qpColor.innerHTML = '<option value="">اختر اللون</option>';
                qpSize.innerHTML = '<option value="">اختر المقاس</option>';
                qpSize.disabled = true;
                qpQty.value = 1; qpQty.removeAttribute('max');
                // show instantly
                qpOverlay.style.display = 'flex';
                setTimeout(function(){ qpSheet.style.transform = 'translateY(0)'; }, 10);
                // load product variants
                fetch('/api/products/'+String(productId)+'/', { credentials:'same-origin' })
                .then(function(r){ return r.json(); })
                .then(function(p){
                    try{
                        var variants = Array.isArray(p.variants) ? p.variants : [];
                        qpCurrent.storeId = (p.store && p.store.id) ? p.store.id : null;
                        qpCurrent.variants = variants.map(function(v){ return { id:v.id, color:v.color, size:v.size, stock_qty:parseInt(v.stock_qty||'0'), price:parseFloat(v.price||p.base_price||0) }; });
                        var colors = Array.from(new Set(qpCurrent.variants.map(function(v){ return v.color; }).filter(Boolean)));
                        colors.forEach(function(c){ var opt=document.createElement('option'); opt.value=c; opt.textContent=c; qpColor.appendChild(opt); });
                        // auto select first color with stock
                        var firstWithStock = qpCurrent.variants.find(function(v){ return v.stock_qty>0; });
                        if(firstWithStock){ qpColor.value = firstWithStock.color; updateSizes(); }
                    }catch(e){}
                }).catch(function(){ /* fallback: keep sheet open for manual selection */ });
            }
            function updateSizes(){
                var color = qpColor.value;
                qpSize.innerHTML = '<option value="">اختر المقاس</option>';
                qpSize.disabled = true;
                qpQty.value = 1; qpQty.removeAttribute('max');
                if(!color) return;
                var sizes = qpCurrent.variants.filter(function(v){ return v.color===color; }).map(function(v){ return { size:v.size, id:v.id, stock:v.stock_qty }; });
                sizes.forEach(function(s){ var out = !s.stock || s.stock<=0; var opt=document.createElement('option'); opt.value=s.size; opt.textContent= out ? (s.size+' (غير متاح)') : s.size; opt.setAttribute('data-id', s.id); opt.setAttribute('data-stock', String(s.stock||0)); qpSize.appendChild(opt); });
                qpSize.disabled = sizes.length===0;
                var firstAvail = sizes.find(function(s){ return s.stock>0; });
                if(firstAvail){ qpSize.value = firstAvail.size; qpSize.dispatchEvent(new Event('change')); }
            }
            function closeQuickPicker(){
                try{ qpSheet.style.transform = 'translateY(100%)'; setTimeout(function(){ qpOverlay.style.display='none'; }, 180); }catch(e){ qpOverlay.style.display='none'; }
            }
            // expose globally
            window.openQuickVariantPicker = openQuickVariantPicker;
        })();
        </script>
        <script>
        (function(){
            var MOBILE_MAX = 820; // أوسع قليلاً لضمان عمل التجميع على أغلب الهواتف
            function setupContainer(grid){
                var size = parseInt(grid.getAttribute('data-chunk-size')||'4')||4;
                var items = Array.prototype.filter.call(grid.children, function(el){ return el && el.nodeType===1; });
                if(items.length <= size) return; // nothing to chunk
                var nav = grid._chunkNav;
                if(!nav){
                    nav = document.createElement('div');
                    nav.className = 'mobile-chunked-grid-nav d-flex justify-content-start';
                    nav.innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm me-2" data-dir="prev">السابق</button><button type="button" class="btn btn-secondary btn-sm" data-dir="next">التالي</button>';
                    grid.parentNode.insertBefore(nav, grid);
                    nav.addEventListener('click', function(e){
                        var b = e.target.closest('button'); if(!b) return;
                        var dir = b.getAttribute('data-dir')||'';
                        var st = grid._chunkState || { page:0 };
                        var pages = Math.ceil(items.length/size);
                        if(dir==='prev') st.page = Math.max(0, st.page-1);
                        if(dir==='next') st.page = Math.min(pages-1, st.page+1);
                        grid._chunkState = st; apply();
                    });
                    grid._chunkNav = nav;
                }
                function apply(){
                    var isMobile = (window.innerWidth || 0) <= MOBILE_MAX;
                    var st = grid._chunkState || (grid._chunkState = { page:0 });
                    var pages = Math.ceil(items.length/size);
                    if(!isMobile){
                        items.forEach(function(el){ el.style.removeProperty('display'); });
                        if(nav) nav.style.display='none';
                        return;
                    }
                    var start = st.page * size, end = start + size;
                    for(var i=0;i<items.length;i++){
                        items[i].style.display = (i>=start && i<end) ? '' : 'none';
                    }
                    if(nav){
                        nav.style.display='flex';
                        var prevBtn = nav.querySelector('[data-dir=\"prev\"]');
                        var nextBtn = nav.querySelector('[data-dir=\"next\"]');
                        if(prevBtn) prevBtn.disabled = st.page<=0;
                        if(nextBtn) nextBtn.disabled = st.page>=pages-1;
                    }
                }
                apply();
                var ro;
                try{ ro = new ResizeObserver(apply); ro.observe(document.documentElement); }catch(e){ window.addEventListener('resize', apply); }
                setTimeout(apply, 50); // تأكيد التطبيق بعد الرسم الأولي
            }
            function init(){
                var grids = document.querySelectorAll('.mobile-chunked-grid');
                grids.forEach(function(g){ try{ setupContainer(g); }catch(e){} });
            }
            if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); }
            else { init(); }
        })();
        </script>
        <script>
        (function(){
            function isVisible(el){
                if(!el || el.nodeType !== 1) return false;
                var cs;
                try{ cs = window.getComputedStyle(el); }catch(e){ cs = null; }
                if(cs && (cs.display === 'none' || cs.visibility === 'hidden')) return false;
                try{
                    if(el.getClientRects && el.getClientRects().length === 0) return false;
                }catch(e){}
                return true;
            }
            function update(){
                try{
                    document.querySelectorAll('.m-row-scroller').forEach(function(scroller){
                        var visibleCount = 0;
                        for(var i=0;i<scroller.children.length;i++){
                            if(isVisible(scroller.children[i])) visibleCount++;
                            if(visibleCount > 1) break;
                        }
                        scroller.classList.toggle('m-single', visibleCount <= 1);
                    });
                }catch(e){}
            }
            function schedule(){ try{ requestAnimationFrame(update); }catch(e){ setTimeout(update, 0); } }
            if(document.readyState === 'loading'){
                document.addEventListener('DOMContentLoaded', function(){ schedule(); setTimeout(schedule, 150); });
            }else{
                schedule(); setTimeout(schedule, 150);
            }
            window.addEventListener('resize', schedule);
            document.addEventListener('click', function(e){
                try{
                    if(e && e.target && e.target.closest && e.target.closest('.mobile-chunked-grid-nav button')) setTimeout(schedule, 0);
                }catch(_e){}
            }, true);
        })();
        </script>
        <script>
        (function(){
            function send(payload){
                try{ fetch('/debug/log-js/',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); }catch(e){}
            }
            window.addEventListener('error', function(e){
                try{
                    var msg = String(e.message || e.error || '');
                    if (msg.indexOf('not a valid selector') > -1 && msg.indexOf('#') > -1) return;
                    var p={ message: msg, file:String(e.filename|| (e.error && e.error.fileName) || ''), line:parseInt(e.lineno|| (e.error && e.error.lineNumber) || 0)||0, col:parseInt(e.colno||0)||0, url: String(location.href||'') };
                    send(p);
                }catch(err){}
            });
            window.addEventListener('unhandledrejection', function(e){
                try{
                    var reason=e.reason; var msg='';
                    if(typeof reason==='string'){ msg=reason; }
                    else if(reason && reason.message){ msg=reason.message; }
                    else { msg=String(reason||''); }
                    var p={ message: msg, file: '', line: 0, col: 0, url: String(location.href||'') };
                    send(p);
                }catch(err){}
            });
        })();
        </script>
    
    {% block extra_js %}{% endblock %}
</body>
    <script>
    (function(){
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/service-worker.js?v=4').catch(function(){});
        });
      }
    })();
    </script>
    <script>
    (function(){
        function isStandalone(){
            try{
                return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || window.navigator.standalone === true;
            }catch(e){ return false; }
        }
        function now(){ return Date.now ? Date.now() : (new Date()).getTime(); }
        function shouldSuppress(){
            try{
                var until = parseInt(localStorage.getItem('pwaInstallHideUntil') || '0', 10) || 0;
                var diff = until - now();
                if(diff <= 0) return false;
                return diff < (6 * 60 * 60 * 1000);
            }catch(e){ return false; }
        }
        function isIOS(){
            try{
                return /iphone|ipad|ipod/i.test(navigator.userAgent || '');
            }catch(e){ return false; }
        }
        function isAndroidChromeLike(){
            try{
                var ua = String(navigator.userAgent || '');
                if(!/android/i.test(ua)) return false;
                return /(chrome|crios|edga|edg)/i.test(ua);
            }catch(e){ return false; }
        }
        var deferred = null;
        var banner = document.getElementById('pwaInstallBanner');
        var installBtn = document.getElementById('pwaInstallBtn');
        var dismissBtn = document.getElementById('pwaDismissBtn');
        function show(){
            if(!banner) return;
            if(isStandalone()) return;
            if(shouldSuppress()) return;
            if(!deferred && !isIOS() && !isAndroidChromeLike()) return;
            banner.classList.add('show');
            banner.setAttribute('aria-hidden','false');
        }
        function hide(days){
            if(banner){
                banner.classList.remove('show');
                banner.setAttribute('aria-hidden','true');
            }
            if(days){
                try{
                    var ms = days * 24 * 60 * 60 * 1000;
                    localStorage.setItem('pwaInstallHideUntil', String(now() + ms));
                }catch(e){}
            }
        }
        window.addEventListener('beforeinstallprompt', function(e){
            try{ e.preventDefault(); }catch(err){}
            deferred = e;
            show();
        });
        if(installBtn){
            installBtn.addEventListener('click', async function(){
                if(!deferred){
                    if(isIOS()){
                        try{
                            alert('على iPhone/iPad: افتح الموقع من Safari ثم اضغط زر المشاركة واختر "إضافة إلى الشاشة الرئيسية".');
                        }catch(e){}
                        return;
                    }
                    try{
                        alert('للتثبيت: افتح القائمة ⋮ في Chrome/Edge ثم اختر "تثبيت التطبيق" أو "إضافة إلى الشاشة الرئيسية".');
                    }catch(e){}
                    return;
                }
                try{
                    deferred.prompt();
                    await deferred.userChoice;
                }catch(e){}
                deferred = null;
                hide(30);
            });
        }
        if(dismissBtn){
            dismissBtn.addEventListener('click', function(){ hide(0.25); });
        }
        window.addEventListener('appinstalled', function(){ hide(365); });
        if(!isStandalone()){
            setTimeout(show, 1200);
        }
    })();
    </script>
    <script>
    (function(){
        function cleanupScrollLock(){
            try{
                var openLayer = document.querySelector('.modal.show, .offcanvas.show');
                if(openLayer) return;
                document.body.classList.remove('modal-open');
                document.body.style.removeProperty('overflow');
                document.body.style.removeProperty('padding-right');
                document.documentElement.style.removeProperty('overflow');
                document.querySelectorAll('.modal-backdrop').forEach(function(el){ try{ el.remove(); }catch(e){} });
            }catch(e){}
        }
        if(document.readyState === 'loading'){
            document.addEventListener('DOMContentLoaded', function(){ setTimeout(cleanupScrollLock, 0); });
        } else {
            setTimeout(cleanupScrollLock, 0);
        }
        window.addEventListener('load', function(){ setTimeout(cleanupScrollLock, 0); });
        document.addEventListener('hidden.bs.modal', function(){ setTimeout(cleanupScrollLock, 0); });
        document.addEventListener('hidden.bs.offcanvas', function(){ setTimeout(cleanupScrollLock, 0); });
        document.addEventListener('keyup', function(e){ if(e && e.key === 'Escape') setTimeout(cleanupScrollLock, 0); });
    })();
    </script>

    <!-- Robust Navbar Toggler & Theme Manager -->
    <script>
    (function(){
        var btn = document.getElementById('navbarTogglerBtn');
        var target = document.getElementById('navbarNav');
        if(btn && target && window.bootstrap && bootstrap.Collapse){
            btn.removeAttribute('data-bs-toggle');
            var instance = bootstrap.Collapse.getOrCreateInstance(target, { toggle: false });
            btn.addEventListener('click', function(e){
                e.preventDefault();
                if(target.classList.contains('show')){ instance.hide(); }
                else{ instance.show(); }
            });
            document.addEventListener('click', function(e){
                if(!target.classList.contains('show')) return;
                if(btn.contains(e.target) || target.contains(e.target)) return;
                instance.hide();
            });
        }

        window.toggleAppTheme = function(){
            var html = document.documentElement;
            var current = html.getAttribute('data-theme') || 'dark';
            var next = current === 'dark' ? 'light' : 'dark';
            
            // Set Attributes
            html.setAttribute('data-theme', next);
            html.setAttribute('data-bs-theme', next);
            
            // Set Body Classes
            if(document.body){
                document.body.classList.remove('theme-light', 'dark-theme');
                document.body.classList.add(next === 'dark' ? 'dark-theme' : 'theme-light');
            }
            
            // Save
            try{
                localStorage.setItem('siteTheme', next);
                localStorage.setItem('theme', next);
            }catch(e){}
            
            // Dispatch Event
            window.dispatchEvent(new CustomEvent('themeChange', { detail: { theme: next } }));
            
            // Show Feedback Toast
            var toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 start-50 translate-middle-x p-3';
            toast.style.zIndex = '1100';
            toast.innerHTML = '<div class="toast show align-items-center text-white bg-' + (next==='dark'?'dark':'primary') + ' border-0" role="alert" aria-live="assertive" aria-atomic="true"><div class="d-flex"><div class="toast-body">' + (next==='dark' ? 'تم تفعيل الوضع الداكن' : 'تم تفعيل الوضع الفاتح') + '</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>';
            document.body.appendChild(toast);
            setTimeout(function(){ toast.remove(); }, 2000);
            
            return next;
        };

        // Expose helper to apply theme on load if needed
        window.applyCurrentTheme = function(){
            var stored = localStorage.getItem('siteTheme') || localStorage.getItem('theme') || 'dark';
            var html = document.documentElement;
            html.setAttribute('data-theme', stored);
            html.setAttribute('data-bs-theme', stored);
            if(document.body){
                document.body.classList.remove('theme-light', 'dark-theme');
                document.body.classList.add(stored === 'dark' ? 'dark-theme' : 'theme-light');
            }
        };

        // Apply on load
        if(document.readyState === 'loading'){
            document.addEventListener('DOMContentLoaded', window.applyCurrentTheme);
        } else {
            window.applyCurrentTheme();
        }
    })();
    </script>
</body>
</html>
