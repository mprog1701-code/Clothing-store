{% extends 'base.html' %}
{% load static %}
{% load math_filters %}

{% block extra_css %}
<style>
    :root {
        --copper: #B87333;
        --copper-light: #D4A574;
        --copper-dark: #8B4513;
        --black: #000000;
        --black-light: #1a1a1a;
        --gold: #FFD700;
    }

    body {
        background: linear-gradient(135deg, var(--black) 0%, var(--black-light) 100%);
        color: #ffffff;
    }

    .fashion-header {
        background: linear-gradient(135deg, var(--copper) 0%, var(--copper-dark) 100%);
        padding: 20px 0;
        box-shadow: 0 4px 20px rgba(184, 115, 51, 0.3);
    }

    .brand-title {
        font-size: 2.5rem;
        font-weight: 900;
        color: var(--gold);
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        margin-bottom: 10px;
    }

    .brand-subtitle {
        color: #ffffff;
        font-size: 1.1rem;
        opacity: 0.9;
    }

    .search-container {
        background: rgba(255,255,255,0.1);
        border-radius: 25px;
        padding: 5px;
        backdrop-filter: blur(10px);
        border: 1px solid var(--copper-light);
    }

    .search-input {
        background: transparent !important;
        border: none;
        color: #ffffff;
        padding: 12px 20px;
        width: 100%;
    }

    .search-input::placeholder {
        color: rgba(255,255,255,0.7);
    }

    .search-container .form-control {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        color: #ffffff !important;
    }
    .search-container .form-control:focus {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        outline: none !important;
        color: #ffffff !important;
    }

    .search-btn {
        background: var(--copper);
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        color: white;
        transition: all 0.3s ease;
    }

    .search-btn:hover {
        background: var(--copper-dark);
        transform: scale(1.1);
    }

    .section-title {
        color: var(--copper-light);
        font-size: 1.8rem;
        font-weight: bold;
        text-align: center;
        margin: 40px 0 30px 0;
        position: relative;
    }

    .section-title::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 3px;
        background: var(--copper);
        border-radius: 2px;
    }

    .category-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }

    .category-card {
        background: linear-gradient(135deg, var(--black-light) 0%, var(--black) 100%);
        border-radius: 15px;
        padding: 30px 20px;
        text-align: center;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        cursor: pointer;
    }

    .category-card:hover {
        border-color: var(--copper);
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(184, 115, 51, 0.3);
    }

    .category-card.coming-soon {
        opacity: 1;
        cursor: not-allowed;
        pointer-events: none;
        position: relative;
    }

    .category-card.coming-soon::after {
        content: 'سيتم افتتاحه قريبًا';
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--copper);
        color: white;
        font-size: 0.7rem;
        padding: 4px 8px;
        border-radius: 10px;
    }

    .category-icon {
        font-size: 3rem;
        color: var(--copper);
        margin-bottom: 15px;
        display: block;
    }

    .category-name {
        font-size: 1.2rem;
        font-weight: bold;
        color: #ffffff;
        margin-bottom: 5px;
    }

    .category-count {
        color: var(--copper-light);
        font-size: 0.9rem;
    }

    .discount-banner {
        background: linear-gradient(45deg, var(--copper), var(--copper-dark));
        border-radius: 20px;
        padding: 40px;
        margin: 40px 0;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .discount-banner::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: repeating-linear-gradient(
            45deg,
            transparent,
            transparent 10px,
            rgba(255,255,255,0.1) 10px,
            rgba(255,255,255,0.1) 20px
        );
        animation: shimmer 3s linear infinite;
        pointer-events: none;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .discount-title {
        font-size: 2.5rem;
        font-weight: 900;
        color: var(--gold);
        margin-bottom: 10px;
        position: relative;
        z-index: 1;
    }

    .discount-subtitle {
        font-size: 1.3rem;
        color: #ffffff;
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
    }

    .discount-btn {
        background: var(--black);
        color: var(--gold);
        border: 2px solid var(--gold);
        padding: 15px 40px;
        border-radius: 30px;
        font-size: 1.1rem;
        font-weight: bold;
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
    }

    .discount-btn:hover {
        background: var(--gold);
        color: var(--black);
        transform: scale(1.05);
    }

    .new-arrivals {
        background: linear-gradient(135deg, var(--black-light) 0%, var(--black) 100%);
        border-radius: 20px;
        padding: 30px;
        margin: 30px 0;
        border: 2px solid var(--copper);
    }

    .product-card {
        background: var(--black-light);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        border: 1px solid var(--copper);
        height: 100%;
        position: relative;
    }

    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(184, 115, 51, 0.3);
        border-color: var(--gold);
    }

    .product-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 10px;
        margin-bottom: 15px;
        border: 2px solid var(--copper);
    }

    .product-name {
        font-size: 1.1rem;
        font-weight: bold;
        color: #ffffff;
        margin-bottom: 10px;
    }

    /* Ensure image and name links are always clickable above any effects */
    .product-card a,
    .product-card img {
        position: relative;
        z-index: 2;
        pointer-events: auto;
    }

    .product-price {
        font-size: 1.3rem;
        font-weight: bold;
        color: var(--gold);
        margin-bottom: 10px;
    }

    .product-discount {
        text-decoration: line-through;
        color: #888;
        font-size: 1rem;
        margin-right: 10px;
    }

    .add-to-cart-btn {
        background: var(--copper);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        transition: all 0.3s ease;
        font-weight: bold;
        position: relative;
        z-index: 3;
        pointer-events: auto;
    }

    .add-to-cart-btn:hover {
        background: var(--copper-dark);
        transform: scale(1.05);
    }

    .bottom-nav {
        background: var(--black-light);
        border-top: 2px solid var(--copper);
        padding: 15px 0;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        backdrop-filter: blur(10px);
    }

    .nav-item {
        text-align: center;
        color: var(--copper-light);
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .nav-item:hover,
    .nav-item.active {
        color: var(--gold);
    }

    .nav-icon {
        font-size: 1.5rem;
        display: block;
        margin-bottom: 5px;
    }

    .nav-text {
        font-size: 0.8rem;
        font-weight: bold;
    }

    .cart-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: var(--gold);
        color: var(--black);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.7rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    @media (max-width: 768px) {
        .brand-title {
            font-size: 2rem;
        }
        
        .category-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
    }
    @media (max-width: 600px) {
        .brand-title { font-size: 1.6rem; }
        .brand-subtitle { font-size: .9rem; }
        .search-input { font-size: .9rem; padding: 10px 12px; }
        .home-ad-media img, .home-ad-media video { height: 200px; }
        .home-ad-overlay { right: 16px; top: 12px; }
        .announcement-title { font-size: 1.3rem; }
        .category-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .product-card { border-radius: 14px; }
        .product-image { height: 180px; }
        .add-to-cart-btn { min-height: 44px; font-size: 1rem; border-radius: 12px; }
    }
    .home-ad-wrapper { width: 100%; margin: 0; padding: 0 12px; position: relative; display: none; }
    .home-ad-card { width: 100%; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 35px rgba(0,0,0,0.35); border: 2px solid var(--copper); background: #000; touch-action: pan-y; user-select: none; -webkit-user-select: none; }
    .home-ad-media img, .home-ad-media video { width: 100%; height: 280px; object-fit: cover; display: block; }
    .home-ad-overlay { position: absolute; right: 24px; top: 18px; color: #fff; text-shadow: 0 2px 6px rgba(0,0,0,0.5); }
    .home-ad-overlay h3 { color: var(--gold); font-weight: 900; }
    .ann-dots { display:flex; justify-content:center; align-items:center; gap:8px; padding: 10px 0; }
    .ann-dot { width:10px; height:10px; border-radius:50%; background: rgba(255,255,255,0.5); cursor:pointer; }
    .ann-dot.active { background: var(--gold); width:12px; height:12px; }
    .ann-close { position:absolute; top:10px; left:16px; background: rgba(0,0,0,0.2); color:#fff; border:none; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .ann-close:hover { background: rgba(0,0,0,0.35); }
    .home-ad-more { display:flex; justify-content:flex-start; padding: 0 16px 10px 16px; }
    .home-ad-more .btn { background: transparent; color: #fff; border: 2px solid rgba(255,255,255,0.7); border-radius: 24px; font-weight: 700; }
    .home-ad-more .btn:hover { background: rgba(255,255,255,0.15); }
    .announcement-title {
        color: var(--gold);
        font-size: 1.5rem;
        font-weight: 900;
        margin-bottom: 10px;
    }
    .announcement-actions .btn {
        margin: 4px;
        border-radius: 25px;
        font-weight: bold;
    }
    .ann-btn-primary {
        background: var(--black);
        color: var(--gold);
        border: 2px solid var(--gold);
    }
    .ann-btn-primary:hover {
        background: var(--gold);
        color: var(--black);
    }
    .ann-btn-secondary {
        background: transparent;
        color: #fff;
        border: 2px solid rgba(255,255,255,0.6);
    }
    .ann-btn-secondary:hover {
        background: rgba(255,255,255,0.15);
    }
    .ann-carousel { display: flex; align-items: stretch; gap: 15px; }
    .ann-slide { flex: 1; display: none; }
    .ann-slide.active { display: block; }
    .ann-media { border-radius: 12px; overflow: hidden; border: 2px solid rgba(255,255,255,0.2); }
    .ann-media img, .ann-media video { width: 100%; height: 220px; object-fit: cover; display: block; }
    .ann-controls { display:flex; justify-content: flex-end; align-items: center; margin-top: 10px; gap: 10px; }
    .ann-dots { display:flex; gap:8px; position:absolute; bottom:12px; left:16px; }
    .ann-dot { width:10px; height:10px; border-radius:50%; background: rgba(255,255,255,0.5); cursor:pointer; }
    .ann-dot.active { background: var(--gold); }
    .ann-close { position:absolute; top:10px; left:12px; background: rgba(0,0,0,0.2); color:#fff; border:none; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .ann-close:hover { background: rgba(0,0,0,0.35); }
    .ann-fab { position: fixed; bottom: 110px; left: 20px; z-index: 1100; }
    .ann-fab .btn { border-radius: 30px; border:2px solid var(--gold); background: var(--black); color: var(--gold); }
    .ann-fab .btn:hover { background: var(--gold); color: var(--black); }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
  <div id="app-announcement" class="home-ad-wrapper" role="region" aria-label="إعلان داخل التطبيق">
    <button id="ann-close" class="ann-close" type="button" aria-label="إغلاق">×</button>
    <div class="home-ad-card" id="ann-card">
      <div class="home-ad-media" id="ann-media"></div>
      <div class="home-ad-overlay">
        <h3 id="ann-title"></h3>
        <p id="ann-message" style="opacity:0.95;"></p>
      </div>
    </div>
    <div id="ann-dots" class="ann-dots"></div>
    
  </div>
</div>
<!-- Fashion Header -->
<div class="fashion-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="brand-title">دار الأزياء</h1>
                <p class="brand-subtitle">أناقتك تبدأ من هنا</p>
            </div>
            <div class="col-md-6">
                <div class="search-container">
                    <form class="input-group" action="{% url 'search' %}" method="get">
                        <input type="text" name="q" class="form-control search-input" id="liveSearchInput" placeholder="ابحث عن أزياءك المفضلة..." autocomplete="off">
                        <button class="search-btn" type="submit">
                            <i class="bi bi-search"></i>
                        </button>
                    </form>
                    <div id="liveSearchResults" class="live-search-results" style="position:absolute; left:0; right:0; top:100%; z-index:1000; display:none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Categories Section -->
<div class="container">
    <h2 class="section-title">تسوق حسب الفئة</h2>
    <div class="category-grid">
        <div class="category-card" onclick="window.location.href='{% url 'store_list' %}?category=women'">
            <i class="bi bi-bag-heart category-icon"></i>
            <h3 class="category-name">ملابس نسائية</h3>
            <p class="category-count">{{ categories.women|default:"150+" }} منتج</p>
        </div>
        
        <div class="category-card coming-soon">
            <i class="bi bi-person-workspace category-icon"></i>
            <h3 class="category-name">ملابس رجالية</h3>
            <p class="category-count">قريبًا</p>
        </div>
        
        <div class="category-card" onclick="window.location.href='{% url 'store_list' %}?category=kids'">
            <i class="bi bi-emoji-smile category-icon"></i>
            <h3 class="category-name">ملابس أطفال</h3>
            <p class="category-count">{{ categories.kids|default:"100+" }} منتج</p>
        </div>
        
        <div class="category-card coming-soon">
            <i class="bi bi-flower1 category-icon"></i>
            <h3 class="category-name">عطور</h3>
            <p class="category-count">قريبًا</p>
        </div>
        
        <div class="category-card" onclick="window.location.href='{% url 'store_list' %}?category=cosmetics'">
            <i class="bi bi-palette category-icon"></i>
            <h3 class="category-name">كوزمتك</h3>
            <p class="category-count">{{ categories.cosmetics|default:"120+" }} منتج</p>
        </div>
        
        <div class="category-card" onclick="window.location.href='{% url 'store_list' %}?category=shoes'">
            <i class="bi bi-bag category-icon"></i>
            <h3 class="category-name">أحذية</h3>
            <p class="category-count">{{ categories.shoes|default:"80+" }} منتج</p>
        </div>

        <div class="category-card coming-soon">
            <i class="bi bi-watch category-icon"></i>
            <h3 class="category-name">ساعات</h3>
            <p class="category-count">قريبًا</p>
        </div>
    </div>
</div>

<!-- Campaign Banner (Dynamic) -->
{% if campaign %}
<div class="container">
    <div class="discount-banner">
        <h2 class="discount-title">{{ campaign.title }}</h2>
        {% if campaign.description %}<p class="discount-subtitle">{{ campaign.description }}</p>{% endif %}
        {% if campaign.banner_image %}
        <div class="mb-3">
            <img src="{{ campaign.banner_image.url }}" alt="{{ campaign.title }}" class="img-fluid rounded-3" style="max-height:300px; object-fit:cover;">
        </div>
        {% endif %}
        <a href="{{ campaign.action_url|default:'/stores/' }}" class="discount-btn">تسوق الآن</a>
    </div>
</div>
{% endif %}

<!-- New Arrivals -->
<div class="container">
    <h2 class="section-title">وصل حديثًا</h2>
    <div class="row">
        {% for product in new_arrivals %}
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="product-card position-relative">
                {% if product.main_image %}
                {% with url=product.main_image.get_image_url %}
                {% if url %}
                <a href="{% url 'product_detail' product.id %}" aria-label="عرض {{ product.name }}" class="d-block">
                    <img src="{{ url }}" alt="{{ product.name }}" class="product-image">
                </a>
                {% else %}
                <a href="{% url 'product_detail' product.id %}" aria-label="عرض {{ product.name }}" class="d-block">
                    <div class="product-image d-flex align-items-center justify-content-center" style="background: var(--copper); color: white;">
                        <i class="bi bi-image" style="font-size: 3rem;"></i>
                    </div>
                </a>
                {% endif %}
                {% endwith %}
                {% else %}
                <a href="{% url 'product_detail' product.id %}" aria-label="عرض {{ product.name }}" class="d-block">
                    <div class="product-image d-flex align-items-center justify-content-center" style="background: var(--copper); color: white;">
                        <i class="bi bi-image" style="font-size: 3rem;"></i>
                    </div>
                </a>
                {% endif %}
                <h4 class="product-name">
                    <a href="{% url 'product_detail' product.id %}" class="text-decoration-none d-inline-block" style="color: inherit;">{{ product.name }}</a>
                </h4>
                <div class="product-price">
                    {% if product.discount_price %}
                    <span class="product-discount">{{ product.base_price|iqd }}</span>
                    {{ product.discount_price|iqd }}
                    {% else %}
                    {{ product.base_price|iqd }}
                    {% endif %}
                </div>
                <button class="add-to-cart-btn" onclick="event.stopPropagation(); addToCart({{ product.id }})">
                    <i class="bi bi-bag-plus"></i> أضف للسلة
                </button>
                
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="bi bi-bag-x" style="font-size: 4rem; color: var(--copper);"></i>
                <h3 style="color: var(--copper-light); margin-top: 20px;">قريبًا...</h3>
                <p style="color: #888;">سيتم إضافة منتجات جديدة قريبًا</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

 
{% endblock %}

{% block extra_js %}
<script>
    let __liveTimer;
    const input = document.getElementById('liveSearchInput');
    const box = document.getElementById('liveSearchResults');
    function hideBox(){ if(box) box.style.display='none'; }
    function showBox(){ if(box) box.style.display='block'; }
    function renderResults(products, stores){
        const p = (products||[]).slice(0,5);
        const s = (stores||[]).slice(0,5);
        let html = '<div class="bg-dark bg-opacity-90 border rounded-3 p-2">';
        if(p.length){
            html += '<div class="text-white-50 px-2 mb-1">منتجات</div>';
            p.forEach(item=>{
                const id = item.id;
                const name = item.name;
                const price = (item.base_price!=null)? item.base_price : '';
                html += `<a href="/products/${id}/" class="d-flex align-items-center text-decoration-none text-white p-2 rounded-2 hover-bg">`+
                        `<i class="bi bi-bag me-2"></i><span class="flex-grow-1">${name}</span>`+
                        `<small class="text-white-50 ms-2">${price}</small>`+
                        `</a>`;
            });
        }
        if(s.length){
            html += '<div class="text-white-50 px-2 mt-2 mb-1">متاجر</div>';
            s.forEach(item=>{
                const id = item.id;
                const name = item.name;
                const city = item.city||'';
                html += `<a href="/stores/${id}/" class="d-flex align-items-center text-decoration-none text-white p-2 rounded-2 hover-bg">`+
                        `<i class="bi bi-shop me-2"></i><span class="flex-grow-1">${name}</span>`+
                        `<small class="text-white-50 ms-2">${city}</small>`+
                        `</a>`;
            });
        }
        if(!p.length && !s.length){
            html += '<div class="text-center text-white-50 p-2"><i class="bi bi-search"></i> لا توجد نتائج</div>';
        }
        html += `<a href="/search/?q=${encodeURIComponent(input.value||'')}" class="d-block text-center text-decoration-none text-white-50 p-2">عرض المزيد</a>`;
        html += '</div>';
        box.innerHTML = html;
        showBox();
    }
    async function fetchLive(q){
        if(!q || q.trim().length<2){ hideBox(); return; }
        try{
            const [pr, sr] = await Promise.all([
                fetch(`/api/products/?q=${encodeURIComponent(q)}`),
                fetch(`/api/stores/?q=${encodeURIComponent(q)}`)
            ]);
            const pd = await pr.json();
            const sd = await sr.json();
            const products = pd.results || pd;
            const stores = sd.results || sd;
            renderResults(products, stores);
        }catch(e){ hideBox(); }
    }
    if(input){
        input.addEventListener('input', function(){
            clearTimeout(__liveTimer);
            const q = this.value;
            __liveTimer = setTimeout(()=>fetchLive(q), 250);
        });
        input.addEventListener('blur', ()=> setTimeout(hideBox, 200));
        input.addEventListener('focus', ()=>{ if((input.value||'').trim().length>=2) fetchLive(input.value); });
    }
    // Add to Cart Function
    function addToCart(productId) {
        const meta = document.querySelector('meta[name="csrf-token"]');
        const csrfToken = (meta && meta.content && meta.content !== 'NOTPROVIDED') ? meta.content : (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || '';
        fetch(`/cart/add/${productId}/`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ quantity: 1 })
        })
        .then(response => response.json())
        .then(data => {
            if (data && data.success) {
                const cartCountElement = document.getElementById('cart-count');
                if (cartCountElement) {
                    cartCountElement.textContent = data.cart_items_count;
                    cartCountElement.style.display = data.cart_items_count > 0 ? 'block' : 'none';
                }
                showToast('تمت الإضافة إلى السلة بنجاح!');
            } else {
                showToast('تعذر إضافة المنتج إلى السلة');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('حدث خطأ أثناء الإضافة إلى السلة');
        });
    }
    
    // Toast Notification
    function showToast(message) {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--copper);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 10000;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(184, 115, 51, 0.4);
            animation: slideIn 0.3s ease;
        `;
        toast.textContent = message;
        
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    const announcementConfig = {
        enabled: true,
        slides: [],
        ttlHours: 0.25,
        autoRotateMs: 12000
    };

    let annIndex = 0; let annTimer = null; let isVideoPlaying = false;

    function renderSlide(i){
        const s = announcementConfig.slides[i];
        document.getElementById('ann-title').textContent = s.title || '';
        document.getElementById('ann-message').textContent = s.message || '';
        const media = document.getElementById('ann-media');
        media.innerHTML = '';
        if (s.kind === 'image' && s.mediaUrl){
            media.innerHTML = `<img src="${s.mediaUrl}" alt="announcement">`;
        } else if (s.kind === 'video' && s.mediaUrl){
            media.innerHTML = `<video src="${s.mediaUrl}" muted playsinline preload="metadata" controls></video>`;
            const v = media.querySelector('video');
            if (v) {
                // Attempt autoplay on mobile WebView
                try { v.play().catch(()=>{}); } catch(e){}
                // Pause auto-rotation while video plays
                v.addEventListener('play', ()=>{ isVideoPlaying = true; if (annTimer) { clearInterval(annTimer); annTimer = null; } });
                v.addEventListener('pause', ()=>{ isVideoPlaying = false; restartAuto(); });
                v.addEventListener('ended', ()=>{ isVideoPlaying = false; restartAuto(); nextSlide(); });
                v.addEventListener('error', ()=>{ isVideoPlaying = false; restartAuto(); });
                v.addEventListener('abort', ()=>{ isVideoPlaying = false; restartAuto(); });
                v.addEventListener('emptied', ()=>{ isVideoPlaying = false; restartAuto(); });
            }
        } else {
            media.innerHTML = `<div style="height:280px; display:flex; align-items:center; justify-content:center; color: var(--gold);">`
                + `<i class="bi bi-megaphone" style="font-size:3rem;"></i>` + `</div>`;
        }
        const dots = document.getElementById('ann-dots'); dots.innerHTML='';
        announcementConfig.slides.forEach((_, idx)=>{
            const d = document.createElement('div'); d.className = 'ann-dot'+(idx===i?' active':'');
            d.addEventListener('click', ()=>{ if (isVideoPlaying) return; annIndex = idx; renderSlide(annIndex); restartAuto(); });
            dots.appendChild(d);
        });
    }

    function nextSlide(){ if (isVideoPlaying) return; annIndex = (annIndex+1) % announcementConfig.slides.length; renderSlide(annIndex); }
    function prevSlide(){ if (isVideoPlaying) return; annIndex = (annIndex-1+announcementConfig.slides.length) % announcementConfig.slides.length; renderSlide(annIndex); }
    function restartAuto(){ if (annTimer) clearInterval(annTimer); if (!isVideoPlaying) { annTimer = setInterval(nextSlide, announcementConfig.autoRotateMs); } }

    function loadSlidesFromLocal(){
        try{
            const srvSlides = [
                {% for c in campaigns %}
                {
                    kind: {% if c.banner_image %}'image'{% else %}'text'{% endif %},
                    title: '{{ c.title|escapejs }}',
                    message: '{{ c.description|default:""|escapejs }}',
                    mediaUrl: '{% if c.banner_image %}{{ c.banner_image.url }}{% endif %}',
                    actionText: 'عرض المزيد',
                    actionUrl: '{{ c.action_url|default:"/stores/" }}',
                    priority: 0
                },
                {% endfor %}
            ];
            if (srvSlides.length){
                announcementConfig.slides = srvSlides;
            }
            const ttlMinRaw = localStorage.getItem('appAnnouncementsTTLMinutes');
            if(ttlMinRaw){
                const m = parseInt(ttlMinRaw, 10);
                if(!isNaN(m) && m>0){ announcementConfig.ttlHours = m/60; }
            }
        }catch(e){}
        if(!announcementConfig.slides.length){
            announcementConfig.slides = [
                { kind:'text', title:'إعلان خاص', message:'خصومات موسمية على الأزياء', actionText:'عرض المزيد', actionUrl:'/announcements/', priority:0 },
            ];
        }
    }

    function showAnnouncement() {
        if (!announcementConfig.enabled) return;
        loadSlidesFromLocal();
        const ttlMs = (announcementConfig.ttlHours || 24) * 3600 * 1000;
        const dismissedAtStr = localStorage.getItem('appAnnouncementDismissedAt');
        const dismissedAt = dismissedAtStr ? Date.parse(dismissedAtStr) : 0;
        const nowMs = Date.now();
        const dismissedWithinTTL = dismissedAt && (nowMs - dismissedAt) < ttlMs;
        const navEntries = (performance && performance.getEntriesByType) ? performance.getEntriesByType('navigation') : [];
        const navType = navEntries && navEntries[0] ? navEntries[0].type : ((performance && performance.navigation && performance.navigation.type === 1) ? 'reload' : '');
        const reloadOrNavigate = navType === 'reload' || navType === 'navigate';
        const forceShow = reloadOrNavigate || (sessionStorage.getItem('showAnnouncements') === '1');
        if (!dismissedWithinTTL) { try { sessionStorage.removeItem('appAnnouncementShown'); } catch(e){} }
        if (!forceShow && dismissedWithinTTL) return;
        const banner = document.getElementById('app-announcement');
        banner.style.display = 'block';
        renderSlide(annIndex); restartAuto();
        sessionStorage.setItem('appAnnouncementShown', 'true');
        sessionStorage.removeItem('showAnnouncements');
        document.getElementById('ann-close').addEventListener('click', function() {
            try { localStorage.setItem('appAnnouncementDismissedAt', new Date().toISOString()); localStorage.setItem('appAnnouncementDismissed','true'); } catch(e) {}
            banner.style.display = 'none';
        });

        document.getElementById('ann-card').addEventListener('click', function(e){
            const tag = e.target && e.target.tagName ? e.target.tagName.toLowerCase() : '';
            if(tag==='button' || tag==='a' || tag==='video') return;
            const current = announcementConfig.slides[annIndex] || {};
            const url = current.actionUrl || '/announcements/';
            window.location.assign(url);
        });

        // Swipe/drag support
        let startX = 0; let startY = 0; let currentX = 0; let currentY = 0; let dragging = false; let isHorizontal = false;
        const threshold = 40;
        const el = document.getElementById('ann-card');
        el.addEventListener('touchstart', (e)=>{ startX = e.touches[0].clientX; startY = e.touches[0].clientY; dragging = true; isHorizontal = false; }, {passive:true});
        el.addEventListener('touchmove', (e)=>{ if(!dragging) return; currentX = e.touches[0].clientX; currentY = e.touches[0].clientY; const dx = Math.abs(currentX - startX); const dy = Math.abs(currentY - startY); if (!isHorizontal && dx > dy + 5) { isHorizontal = true; e.preventDefault(); } }, {passive:false});
        el.addEventListener('touchend', ()=>{ if(!dragging) return; const dx = currentX - startX; const dy = currentY - startY; dragging=false; if (!isHorizontal || isVideoPlaying) { return; } if (Math.abs(dx) > threshold && Math.abs(dx) > Math.abs(dy)){ if (dx < 0) { nextSlide(); } else { prevSlide(); } restartAuto(); } });
        el.addEventListener('mousedown', (e)=>{ startX = e.clientX; dragging = true; });
        el.addEventListener('mousemove', (e)=>{ if(!dragging) return; currentX = e.clientX; });
        el.addEventListener('mouseup', ()=>{ if(!dragging) return; const dx = currentX - startX; dragging=false; if (isVideoPlaying) return; if (Math.abs(dx) > threshold){ if (dx < 0) { nextSlide(); } else { prevSlide(); } restartAuto(); } });
    }
    document.addEventListener('DOMContentLoaded', showAnnouncement);
    window.addEventListener('showAnnouncement', ()=>{ try{ localStorage.removeItem('appAnnouncementDismissed'); localStorage.removeItem('appAnnouncementDismissedAt'); sessionStorage.removeItem('appAnnouncementShown'); sessionStorage.setItem('showAnnouncements','1'); }catch(e){} showAnnouncement(); });

    function openProduct(id) { window.location.href = `/products/${id}/`; }
</script>
{% endblock %}
