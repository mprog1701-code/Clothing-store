{% extends 'base.html' %}
{% load math_filters %}

{% block title %}إتمام الطلب{% endblock %}

{% block content %}
<div class="co-wrap">
  <div class="steps">
    <div class="step s1 active">العنوان</div>
    <div class="step s2">التوصيل والدفع</div>
    <div class="step s3">المراجعة</div>
  </div>

  <form id="coForm" method="post" action="{% url 'checkout' %}">
    {% csrf_token %}
    <input type="hidden" name="accuracy_m" id="accuracy_m">
    <input type="hidden" name="formatted_address" id="formatted_address">
    <input type="hidden" name="provider" id="provider">
    <input type="hidden" name="provider_place_id" id="provider_place_id">
    <input type="hidden" name="latitude" id="latitude">
    <input type="hidden" name="longitude" id="longitude">

    <div id="p1" class="panel active">
      <div class="box">
        <div class="box-head">
          <div>عناوين التوصيل</div>
          <button type="button" class="secondary" id="openMap">إضافة عنوان جديد</button>
        </div>
        {% if user.is_authenticated %}
        <div id="addrList" class="addr-list">
          {% if addresses %}
            {% for a in addresses %}
            <label class="addr-item">
              <input type="radio" name="address_id" value="{{ a.id }}" {% if a.is_default or forloop.first %}checked{% endif %}>
              <div class="addr-body">
                <div class="addr-title">{{ a.city }} - {{ a.area }}</div>
                <div class="addr-street">{{ a.street }}</div>
                {% if a.formatted_address %}<div class="addr-sub">{{ a.formatted_address }}</div>{% endif %}
              </div>
            </label>
            {% endfor %}
          {% else %}
            <div class="empty-note">لا توجد عناوين محفوظة</div>
          {% endif %}
        </div>
        {% else %}
        <div class="guest-grid">
          <div class="field">
            <label>الاسم</label>
            <input type="text" name="guest_name" id="guest_name" placeholder="الاسم الكامل">
          </div>
          <div class="field">
            <label>رقم الهاتف</label>
            <input type="tel" name="guest_phone" id="guest_phone" placeholder="07xxxxxxxx">
          </div>
          <div class="actions" style="margin:6px 0 10px">
            <button type="button" class="secondary" id="openMapGuest">تحديد الموقع بالخريطة</button>
          </div>
          <div class="field">
            <label>المدينة</label>
            <input type="text" name="city" id="city" placeholder="المدينة">
          </div>
          <div class="field">
            <label>المنطقة</label>
            <input type="text" name="area" id="area" placeholder="المنطقة">
          </div>
          <div class="field">
            <label>الشارع</label>
            <input type="text" name="street" id="street" placeholder="الشارع">
          </div>
          <div class="field">
            <label>ملاحظات للعنوان</label>
            <textarea name="details" id="details" rows="2" placeholder="تفاصيل إضافية"></textarea>
          </div>
        </div>
        {% endif %}

        <div class="actions">
          <button type="button" class="primary" id="toStep2">متابعة</button>
        </div>
      </div>
    </div>

    <div id="p2" class="panel">
      <div class="box">
        <div class="box-head">
          <div>التوصيل</div>
        </div>
        <div class="opt-list">
          <label class="opt-item">
            <input type="radio" name="delivery_opt" value="standard" checked>
            <div class="opt-body">
              <div class="opt-title">عادي</div>
              <div class="opt-sub">خلال 24–48 ساعة</div>
            </div>
          </label>
          <label class="opt-item disabled">
            <input type="radio" disabled>
            <div class="opt-body">
              <div class="opt-title">سريع</div>
              <div class="opt-sub">قريباً</div>
            </div>
          </label>
        </div>

        <div class="box-head" style="margin-top:14px">
          <div>الدفع</div>
        </div>
        <div class="opt-list">
          <label class="opt-item">
            <input type="radio" name="payment_method" value="cod" checked>
            <div class="opt-body">
              <div class="opt-title">عند الاستلام</div>
              <div class="opt-sub">الدفع نقداً عند التسليم</div>
            </div>
          </label>
          <label class="opt-item disabled">
            <input type="radio" disabled>
            <div class="opt-body">
              <div class="opt-title">تحويل بنكي</div>
              <div class="opt-sub">قريباً</div>
            </div>
          </label>
          <label class="opt-item disabled">
            <input type="radio" disabled>
            <div class="opt-body">
              <div class="opt-title">بطاقة</div>
              <div class="opt-sub">قريباً</div>
            </div>
          </label>
        </div>

        <div class="field" style="margin-top:12px">
          <label>ملاحظات للطلب</label>
          <textarea id="order_notes" rows="2" placeholder="اختياري"></textarea>
        </div>

        <div class="actions">
          <button type="button" class="secondary" id="backTo1">رجوع</button>
          <button type="button" class="primary" id="toStep3">متابعة</button>
        </div>
      </div>
    </div>

    <div id="p3" class="panel">
      <div class="box">
        <div class="box-head">
          <div>مراجعة نهائية</div>
        </div>
        <div class="summary">
          <div class="row"><span>المجموع</span><span>{{ cart_total|iqd }}</span></div>
          <div class="row"><span>التوصيل</span><span>{{ delivery_fee|iqd }}</span></div>
          <div class="row total"><span>الإجمالي</span><span>{{ grand_total|iqd }}</span></div>
        </div>
        <div class="actions">
          <button type="button" class="secondary" id="backTo2">رجوع</button>
          <button type="submit" class="primary" id="confirmOrder">تأكيد الطلب</button>
        </div>
      </div>
    </div>
  </form>

  <div id="mapModal" class="modal">
    <div class="modal-box">
      <div class="modal-head">
        <div>تحديد الموقع</div>
        <button type="button" class="icon-btn" id="closeMap">✕</button>
      </div>
      <div class="modal-body">
        <div class="search">
          <input id="searchInput" placeholder="ابحث عن مكان">
          <button id="searchBtn" class="secondary">بحث</button>
        </div>
        <div id="selectedInfo" class="sel-info" style="display:none"></div>
        <div id="list" class="list"></div>
        <div id="map"></div>
      </div>
      <div class="actions">
        <button type="button" class="secondary" id="cancelMap">إلغاء</button>
        <button type="button" class="primary" id="confirmLocation">تأكيد الموقع</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"><div class="toast-box"></div></div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
.co-wrap{direction:rtl;max-width:980px;margin:0 auto;padding:16px}
.steps{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px}
.step{background:#f7f7f7;border:1px solid #eee;border-radius:10px;padding:10px;text-align:center;font-weight:700;color:#555}
.step.active{background:#111;color:#fff;border-color:#111}
.panel{display:none}
.panel.active{display:block}
.box{background:#fff;border:1px solid #eee;border-radius:12px;padding:12px}
.box-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;font-weight:700}
.actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.primary{background:#111;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
.secondary{background:#fff;color:#111;border:1px solid #ddd;border-radius:10px;padding:10px 14px;cursor:pointer}
.field{display:flex;flex-direction:column;gap:6px;margin:6px 0}
.field input,.field textarea{border:1px solid #ddd;border-radius:10px;padding:10px}
.guest-grid{display:grid;grid-template-columns:1fr;gap:8px}
.addr-list{display:flex;flex-direction:column;gap:8px}
.addr-item{display:flex;gap:10px;align-items:flex-start;border:1px solid #eee;border-radius:10px;padding:10px}
.addr-body{display:flex;flex-direction:column;gap:2px}
.addr-title{font-weight:700}
.addr-street{color:#333}
.addr-sub{color:#777;font-size:13px}
.empty-note{color:#777}
.opt-list{display:grid;grid-template-columns:1fr;gap:8px}
.opt-item{display:flex;gap:10px;align-items:flex-start;border:1px solid #eee;border-radius:10px;padding:10px}
.opt-item.disabled{opacity:.5}
.opt-body{display:flex;flex-direction:column;gap:2px}
.opt-title{font-weight:700}
.opt-sub{color:#777;font-size:13px}
.summary{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.summary .row{display:flex;justify-content:space-between}
.summary .total{border-top:1px solid #eee;padding-top:8px;font-weight:700}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:10px;z-index:1000}
.modal.open{display:flex}
.modal-box{background:#fff;border-radius:12px;max-width:920px;width:100%;padding:12px;border:1px solid #eee}
.modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;font-weight:700}
.icon-btn{background:#fff;border:1px solid #ddd;border-radius:10px;padding:8px 12px;cursor:pointer}
.modal-body{display:flex;flex-direction:column;gap:8px}
.search{display:grid;grid-template-columns:1fr auto;gap:8px}
#searchInput{border:1px solid #ddd;border-radius:10px;padding:10px}
#list{display:flex;flex-direction:column;gap:6px;max-height:160px;overflow:auto;border:1px solid #eee;border-radius:10px;padding:8px}
#list .res{border:1px solid #eee;border-radius:10px;padding:8px;cursor:pointer}
#map{height:360px;border-radius:12px;border:1px solid #eee;background:#f4f4f4}
.sel-info{border:1px solid #eee;border-radius:10px;padding:8px;color:#333}
.toast{position:fixed;bottom:16px;left:16px;right:16px;display:none;z-index:1100}
.toast.show{display:block}
.toast-box{background:#111;color:#fff;border-radius:12px;padding:12px;text-align:center}
@media(max-width:900px){.co-wrap{padding:12px}}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
var IS_AUTH = {% if user.is_authenticated %}true{% else %}false{% endif %};
var toastEl = document.getElementById('toast');
var SEL = { city:'', area:'', street:'', display:'' };
function showToast(msg){ var box = toastEl.querySelector('.toast-box'); if(box){ box.textContent = msg; } toastEl.classList.add('show'); setTimeout(function(){ toastEl.classList.remove('show'); }, 2500); }
function getCsrf(){ var m = document.cookie.match(/csrftoken=([^;]+)/); return m ? m[1] : ''; }
function goStep(idx){ ['s1','s2','s3'].forEach(function(s,i){ var el = document.querySelector('.step.'+s); if(el){ el.classList.toggle('active', i===idx); } }); ['p1','p2','p3'].forEach(function(pid,i){ var p = document.getElementById(pid); if(p){ p.classList.toggle('active', i===idx); } }); }
document.getElementById('toStep2').addEventListener('click', function(){ if(IS_AUTH){ var sel = document.querySelector('input[name="address_id"]:checked'); if(!sel){ showToast('يرجى اختيار العنوان'); return; } } else { var n = document.getElementById('guest_name').value.trim(); var ph = document.getElementById('guest_phone').value.trim(); var c = document.getElementById('city').value.trim(); var a = document.getElementById('area').value.trim(); var s = document.getElementById('street').value.trim(); if(!n || !ph || !(c && a && s)){ showToast('أكمل بيانات التوصيل'); return; } } goStep(1); });
document.getElementById('backTo1').addEventListener('click', function(){ goStep(0); });
document.getElementById('toStep3').addEventListener('click', function(){ goStep(2); });
document.getElementById('backTo2').addEventListener('click', function(){ goStep(1); });

var mapModal = document.getElementById('mapModal');
var closeMap = document.getElementById('closeMap');
var cancelMap = document.getElementById('cancelMap');
var openMapBtn = document.getElementById('openMap');
var openMapGuestBtn = document.getElementById('openMapGuest');
function openMap(){ mapModal.classList.add('open'); initMap(); }
function hideMap(){ mapModal.classList.remove('open'); }
if(openMapBtn){ openMapBtn.addEventListener('click', openMap); }
if(openMapGuestBtn){ openMapGuestBtn.addEventListener('click', openMap); }
closeMap.addEventListener('click', hideMap); cancelMap.addEventListener('click', hideMap);

var map, marker;
function initMap(){ if(map) return; map = L.map('map').setView([33.3152,44.3661], 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map); map.on('click', function(e){ setMarker(e.latlng.lat, e.latlng.lng); reverseGeocode(e.latlng.lat, e.latlng.lng); }); }
function setMarker(lat,lng){ if(!marker){ marker = L.marker([lat,lng], {draggable:true}).addTo(map); marker.on('dragend', function(){ var ll = marker.getLatLng(); updateLatLng(ll.lat, ll.lng); reverseGeocode(ll.lat, ll.lng); }); } marker.setLatLng([lat,lng]); updateLatLng(lat,lng); }
function updateLatLng(lat,lng){ document.getElementById('latitude').value = lat; document.getElementById('longitude').value = lng; }

function updatePreview(){ var el = document.getElementById('selectedInfo'); if(!el) return; var txt = SEL.display || ((document.getElementById('latitude').value && document.getElementById('longitude').value) ? ('(' + parseFloat(document.getElementById('latitude').value).toFixed(5) + ', ' + parseFloat(document.getElementById('longitude').value).toFixed(5) + ')') : ''); el.textContent = txt; el.style.display = txt ? 'block' : 'none'; }
function reverseGeocode(lat,lng){ fetch('https://nominatim.openstreetmap.org/reverse?format=jsonv2&accept-language=ar&lat='+encodeURIComponent(lat)+'&lon='+encodeURIComponent(lng)).then(function(r){ return r.json(); }).then(function(data){ var addr = data.address || {}; var city = addr.city || addr.town || addr.village || addr.state || ''; var area = addr.suburb || addr.neighbourhood || addr.quarter || addr.district || addr.county || ''; var road = addr.road || ''; var house = addr.house_number || ''; var street = (road + (house?(' '+house):'')); document.getElementById('formatted_address').value = data.display_name || ''; document.getElementById('provider').value = 'nominatim'; document.getElementById('provider_place_id').value = data.place_id || ''; SEL.city = city; SEL.area = area; SEL.street = street; SEL.display = data.display_name || ''; var cEl = document.getElementById('city'); var aEl = document.getElementById('area'); var sEl = document.getElementById('street'); if(cEl) cEl.value = city; if(aEl) aEl.value = area; if(sEl) sEl.value = street; updatePreview(); }); }

var searchInput = document.getElementById('searchInput');
var searchBtn = document.getElementById('searchBtn');
function doSearch(){ var q = (searchInput.value||'').trim(); if(!q) return; fetch('https://nominatim.openstreetmap.org/search?format=jsonv2&accept-language=ar&q='+encodeURIComponent(q)).then(function(r){ return r.json(); }).then(function(items){ var list = document.getElementById('list'); list.innerHTML=''; items.slice(0,10).forEach(function(it){ var d = document.createElement('div'); d.className='res'; d.textContent = it.display_name; d.addEventListener('click', function(){ setMarker(parseFloat(it.lat), parseFloat(it.lon)); fillFromPlace(it); }); list.appendChild(d); }); }); }
searchBtn.addEventListener('click', doSearch);

function fillFromPlace(place){ var addr = place.address || {}; var city = addr.city || addr.town || addr.village || addr.state || ''; var area = addr.suburb || addr.neighbourhood || addr.quarter || addr.district || addr.county || ''; var road = addr.road || ''; var house = addr.house_number || ''; var street = (road + (house?(' '+house):'')); document.getElementById('formatted_address').value = place.display_name || ''; document.getElementById('provider').value = 'nominatim'; document.getElementById('provider_place_id').value = place.place_id || ''; SEL.city = city; SEL.area = area; SEL.street = street; SEL.display = place.display_name || ''; var cEl = document.getElementById('city'); var aEl = document.getElementById('area'); var sEl = document.getElementById('street'); if(cEl) cEl.value = city; if(aEl) aEl.value = area; if(sEl) sEl.value = street; updatePreview(); }

document.getElementById('confirmLocation').addEventListener('click', function(){ var lat = document.getElementById('latitude').value; var lng = document.getElementById('longitude').value; var fa = document.getElementById('formatted_address').value || SEL.display || ''; var cEl = document.getElementById('city'); var aEl = document.getElementById('area'); var sEl = document.getElementById('street'); var city = cEl ? (cEl.value || SEL.city) : SEL.city; var area = aEl ? (aEl.value || SEL.area) : SEL.area; var street = sEl ? (sEl.value || SEL.street) : SEL.street; if(!(lat && lng)){ showToast('اختر موقعاً على الخريطة'); return; } if(IS_AUTH){ var payload = { data: { lat: lat, lng: lng, formatted_address: fa, city: city, area: area, street: street, provider: 'nominatim', place_id: document.getElementById('provider_place_id').value||'' }, next: '{% url 'checkout' %}' }; fetch('{% url 'address_save_json' %}', { method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRFToken': getCsrf() }, body: JSON.stringify(payload) }).then(function(r){ return r.json(); }).then(function(res){ if(res && res.success){ var id = res.id; var list = document.getElementById('addrList'); var wrap = document.createElement('label'); wrap.className='addr-item'; wrap.innerHTML = '<input type="radio" name="address_id" value="'+id+'" checked><div class="addr-body"><div class="addr-title">'+(city||'')+' - '+(area||'')+'</div><div class="addr-street">'+(street||'')+'</div><div class="addr-sub">'+(fa||'')+'</div></div>'; list.insertBefore(wrap, list.firstChild); hideMap(); showToast('تم حفظ العنوان'); } else { showToast('تعذر حفظ العنوان'); } }); } else { hideMap(); showToast('تم تحديد الموقع'); } });

var confirmBtn = document.getElementById('confirmOrder');
confirmBtn.addEventListener('click', function(e){ confirmBtn.disabled = true; confirmBtn.textContent = 'جاري التأكيد...'; setTimeout(function(){ confirmBtn.disabled = false; confirmBtn.textContent = 'تأكيد الطلب'; }, 6000); });
</script>
{% endblock %}

