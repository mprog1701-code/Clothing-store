{% extends 'base.html' %}
{% load math_filters %}

{% block title %}Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨{% endblock %}

{% block content %}
<div class="co-wrap">
  <div class="steps">
    <div class="step s1 active">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
    <div class="step s2">Ø§Ù„ØªÙˆØµÙŠÙ„ ÙˆØ§Ù„Ø¯ÙØ¹</div>
    <div class="step s3">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
  </div>

  <form id="coForm" method="post" action="{% url 'checkout' %}">
    {% csrf_token %}
    <input type="hidden" name="accuracy_m" id="accuracy_m">
    <input type="hidden" name="formatted_address" id="formatted_address">
    <input type="hidden" name="provider" id="provider">
    <input type="hidden" name="provider_place_id" id="provider_place_id">
    <input type="hidden" name="latitude" id="latitude">
    <input type="hidden" name="longitude" id="longitude">

    <div id="p1" class="panel active">
      <div class="box">
        <div class="box-head">
          <div>Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ØªÙˆØµÙŠÙ„</div>
          <button type="button" class="secondary" id="openMap">Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</button>
        </div>
        {% if user.is_authenticated %}
        <div id="addrList" class="addr-list">
          {% if addresses %}
            {% for a in addresses %}
            <label class="addr-item">
              <input type="radio" name="address_id" value="{{ a.id }}" {% if a.is_default or forloop.first %}checked{% endif %}>
              <div class="addr-body">
                <div class="addr-title">{{ a.city }} - {{ a.area }}</div>
                <div class="addr-street">{{ a.street }}</div>
                {% if a.formatted_address %}<div class="addr-sub">{{ a.formatted_address }}</div>{% endif %}
              </div>
            </label>
            {% endfor %}
          {% else %}
            <div class="empty-note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ÙˆÙŠÙ† Ù…Ø­ÙÙˆØ¸Ø©</div>
          {% endif %}
        </div>
        {% else %}
        <div class="guest-grid">
          <div class="field">
            <label>Ø§Ù„Ø§Ø³Ù…</label>
            <input type="text" name="guest_name" id="guest_name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required value="{{ guest_post.guest_name|default:'' }}">
            <div class="error" id="guestNameError">{% if guest_errors %}{{ guest_errors.guest_name }}{% endif %}</div>
          </div>
          <div class="field">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
            <input type="tel" name="guest_phone" id="guest_phone" placeholder="07xxxxxxxxxx" inputmode="numeric" maxlength="11" pattern="^07[0-9]{9}$" title="Ø±Ù‚Ù… Ø¹Ø±Ø§Ù‚ÙŠ ØµØ§Ù„Ø­ ÙŠØ¨Ø¯Ø£ Ø¨Ù€07 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 11 Ø±Ù‚Ù…" required oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,11)" value="{{ guest_post.guest_phone|default:'' }}">
            <small class="hint">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 07 ÙˆÙ…ÙƒÙˆÙ‘Ù† Ù…Ù† 11 Ø±Ù‚Ù…</small>
            <div class="error" id="guestPhoneError">{% if guest_errors %}{{ guest_errors.guest_phone }}{% endif %}</div>
          </div>
          <div class="actions" style="margin:6px 0 10px">
            <button type="button" class="secondary" id="openMapGuest">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
          </div>
          <div class="field">
            <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
            <input type="text" name="city" id="city" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">
          </div>
          <div class="field">
            <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
            <input type="text" name="area" id="area" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
          </div>
          <div class="field">
            <label>Ø§Ù„Ø´Ø§Ø±Ø¹</label>
            <input type="text" name="street" id="street" placeholder="Ø§Ù„Ø´Ø§Ø±Ø¹">
          </div>
          <div class="field">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø¹Ù†ÙˆØ§Ù†</label>
            <textarea name="details" id="details" rows="2" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©"></textarea>
          </div>
        </div>
        {% endif %}

        <div class="actions">
          <button type="button" class="primary" id="toStep2">Ù…ØªØ§Ø¨Ø¹Ø©</button>
        </div>
      </div>
    </div>

    <div id="p2" class="panel">
      <div class="box">
        <div class="box-head">
          <div>Ø§Ù„ØªÙˆØµÙŠÙ„</div>
        </div>
        <div class="opt-list">
          <label class="opt-item">
            <input type="radio" name="delivery_opt" value="standard" checked>
            <div class="opt-body">
              <div class="opt-title">Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ <span class="pill mono">24â€“48 Ø³Ø§Ø¹Ø©</span> <span class="pill">{{ delivery_fee|iqd }}</span></div>
              <div class="opt-sub">ØªÙˆØµÙŠÙ„ Ù…ØªØ§Ø­ Ù„ÙƒÙ„ Ø§Ù„Ø¹Ø±Ø§Ù‚</div>
            </div>
          </label>
          <label class="opt-item disabled" data-soon="Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹">
            <input type="radio" disabled>
            <div class="opt-body">
              <div class="opt-title">Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ <span class="pill soon">Ù‚Ø±ÙŠØ¨Ø§Ù‹</span></div>
              <div class="opt-sub">ØªØ³Ù„ÙŠÙ… Ø£Ø³Ø±Ø¹ Ø®Ù„Ø§Ù„ Ø³Ø§Ø¹Ø§Øª</div>
            </div>
          </label>
        </div>

        <div class="box-head" style="margin-top:14px">
          <div>Ø§Ù„Ø¯ÙØ¹</div>
        </div>
        <div class="opt-list">
          <label class="opt-item">
            <input type="radio" name="payment_method" value="cod" checked>
            <div class="opt-body">
              <div class="opt-title">Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</div>
              <div class="opt-sub">Ù†Ù‚Ø¯Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…</div>
            </div>
          </label>
          <label class="opt-item disabled" data-soon="ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ">
            <input type="radio" disabled>
            <div class="opt-body">
              <div class="opt-title">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ <span class="pill soon">Ù‚Ø±ÙŠØ¨Ø§Ù‹</span></div>
              <div class="opt-sub">Ø¯ÙØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¹Ø¨Ø± Ø§Ù„ØªØ­ÙˆÙŠÙ„</div>
            </div>
          </label>
          <label class="opt-item disabled" data-soon="Ø¨Ø·Ø§Ù‚Ø© Ù…ØµØ±ÙÙŠØ©">
            <input type="radio" disabled>
            <div class="opt-body">
              <div class="opt-title">Ø¨Ø·Ø§Ù‚Ø© Ù…ØµØ±ÙÙŠØ© <span class="pill soon">Ù‚Ø±ÙŠØ¨Ø§Ù‹</span></div>
              <div class="opt-sub">Visa/Master Ù„Ø§Ø­Ù‚Ø§Ù‹</div>
            </div>
          </label>
        </div>

        <div class="field" style="margin-top:12px">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø·Ù„Ø¨</label>
          <textarea id="order_notes" rows="2" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></textarea>
        </div>

        <div class="summary mini" id="sumBox2" data-cart="{{ cart_total }}" data-delivery="{{ delivery_fee }}" data-grand="{{ grand_total }}" data-discount="{{ discount|default:0 }}" style="margin-top:12px">
          <div class="row"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</span><span class="sumCart2">{{ cart_total|iqd }}</span></div>
          <div class="row"><span>Ø§Ù„ØªÙˆØµÙŠÙ„</span><span class="sumDelivery2">{{ delivery_fee|iqd }}</span></div>
          {% if discount %}
          <div class="row"><span>Ø§Ù„Ø®ØµÙ…</span><span class="sumDiscount2">âˆ’ {{ discount|iqd }}</span></div>
          {% endif %}
          <div class="row total"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span class="sumFinal2">{{ grand_total|iqd }}</span></div>
        </div>

        <div class="actions">
          <button type="button" class="secondary" id="backTo1">Ø±Ø¬ÙˆØ¹</button>
          <button type="button" class="primary" id="toStep3">Ù…ØªØ§Ø¨Ø¹Ø©</button>
        </div>
      </div>
    </div>

    <div id="p3" class="panel">
      <div class="box">
        <div class="box-head">
          <div>Ù…Ø±Ø§Ø¬Ø¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©</div>
        </div>
        <div class="summary" id="sumBox" data-cart="{{ cart_total }}" data-delivery="{{ delivery_fee }}" data-grand="{{ grand_total }}" data-discount="{{ discount|default:0 }}" data-discount-label="{{ discount_label|default:'' }}" data-discount-code="{{ discount_code|default:'' }}">
          <div class="row"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</span><span class="sumCart">{{ cart_total|iqd }}</span></div>
          <div class="row"><span>Ø§Ù„ØªÙˆØµÙŠÙ„</span><span class="sumDelivery">{{ delivery_fee|iqd }}</span></div>
          {% if discount %}
          <div class="row"><span>Ø§Ù„Ø®ØµÙ…</span><span class="sumDiscount">âˆ’ {{ discount|iqd }}</span></div>
          {% endif %}
          <div class="row total"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span class="sumFinal">{{ grand_total|iqd }}</span></div>
        </div>
        <div class="coupon-box">
          <label>ÙƒÙˆØ¨ÙˆÙ† Ø§Ù„Ø®ØµÙ…</label>
          <div class="coupon-row">
            <input id="couponCode" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†" autocomplete="off">
            <button type="button" class="secondary" id="applyCoupon">ØªØ·Ø¨ÙŠÙ‚</button>
            <button type="button" class="secondary" id="removeCoupon" style="display:none">Ø¥Ø²Ø§Ù„Ø©</button>
          </div>
          <div class="coupon-note" id="couponNote"></div>
        </div>
        <div class="actions">
          <button type="button" class="secondary" id="backTo2">Ø±Ø¬ÙˆØ¹</button>
          <button type="submit" class="primary" id="confirmOrder"><span class="btn-label">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</span></button>
        </div>
      </div>
    </div>
  </form>

  <div id="mapModal" class="modal">
    <div class="modal-box">
      <div class="modal-head">
        <div>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
        <button type="button" class="icon-btn" id="closeMap">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="search">
          <input id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù†">
          <button id="searchBtn" class="secondary">Ø¨Ø­Ø«</button>
        </div>
        <div id="selectedInfo" class="sel-info" style="display:none"></div>
        <div id="list" class="list"></div>
        <div id="map"></div>
      </div>
      <div class="actions">
        <button type="button" class="secondary" id="cancelMap">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="button" class="primary" id="confirmLocation">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"><div class="toast-box"></div></div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
.co-wrap{direction:rtl;max-width:980px;margin:0 auto;padding:16px}
.steps{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px}
.step{background:#f7f7f7;border:1px solid #eee;border-radius:10px;padding:10px;text-align:center;font-weight:700;color:#555}
.step.active{background:#111;color:#fff;border-color:#111}
.panel{display:none}
.panel.active{display:block}
.box{background:#fff;border:1px solid #eee;border-radius:12px;padding:12px}
.box-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;font-weight:700}
.actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.primary{background:#111;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
.primary .btn-total{display:none}
.promo{margin-top:8px;border:1px dashed #ddd;border-radius:12px;padding:10px;background:#fcfcfc}
.promo .pill{display:inline-block;background:#f5f5f5;border:1px solid #ddd;border-radius:999px;padding:2px 8px;font-size:12px;color:#555}
.coupon-box{margin-top:12px;border:1px solid #eee;border-radius:12px;padding:10px;background:#fcfcfc}
.coupon-row{display:grid;grid-template-columns:1fr auto auto;gap:8px;margin-top:6px}
.coupon-row input{border:1px solid #ddd;border-radius:10px;padding:10px}
.coupon-note{color:#333;font-size:13px;margin-top:6px}
.secondary{background:#fff;color:#111;border:1px solid #ddd;border-radius:10px;padding:10px 14px;cursor:pointer}
.field{display:flex;flex-direction:column;gap:6px;margin:6px 0}
.field input,.field textarea{border:1px solid #ddd;border-radius:10px;padding:10px}
.field .error{color:#b00020;font-size:13px}
.guest-grid{display:grid;grid-template-columns:1fr;gap:8px}
.addr-list{display:flex;flex-direction:column;gap:8px}
.addr-item{display:flex;gap:10px;align-items:flex-start;border:1px solid #eee;border-radius:10px;padding:10px}
.addr-body{display:flex;flex-direction:column;gap:2px}
.addr-title{font-weight:700}
.addr-street{color:#333}
.addr-sub{color:#777;font-size:13px}
.empty-note{color:#777}
.opt-list{display:grid;grid-template-columns:1fr;gap:8px}
.opt-item{display:flex;gap:10px;align-items:flex-start;border:1px solid #eee;border-radius:10px;padding:10px}
.opt-item.disabled{opacity:.6;cursor:not-allowed}
.opt-body{display:flex;flex-direction:column;gap:2px}
.opt-title{font-weight:700}
.opt-sub{color:#777;font-size:13px}
.pill{display:inline-block;background:#f5f5f5;border:1px solid #ddd;border-radius:999px;padding:2px 8px;font-size:12px;color:#555;margin-inline-start:6px}
.pill.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.pill.soon{background:#fff3cd;border-color:#ffe69c;color:#9a6700}
.summary{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.summary.mini{background:#fcfcfc;border:1px solid #eee;border-radius:12px;padding:10px}
.summary .row{display:flex;justify-content:space-between}
.summary .total{border-top:1px solid #eee;padding-top:8px;font-weight:700}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:10px;z-index:1000}
.modal.open{display:flex}
.modal-box{background:#fff;border-radius:12px;max-width:920px;width:100%;padding:12px;border:1px solid #eee}
.modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;font-weight:700}
.icon-btn{background:#fff;border:1px solid #ddd;border-radius:10px;padding:8px 12px;cursor:pointer}
.modal-body{display:flex;flex-direction:column;gap:8px}
.search{display:grid;grid-template-columns:1fr auto;gap:8px}
.locate-control{border-radius:8px;overflow:hidden}
.locate-control .locate-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid #ddd;cursor:pointer}
#searchInput{border:1px solid #ddd;border-radius:10px;padding:10px}
#list{display:flex;flex-direction:column;gap:6px;max-height:160px;overflow:auto;border:1px solid #eee;border-radius:10px;padding:8px}
#list .res{border:1px solid #eee;border-radius:10px;padding:8px;cursor:pointer}
#map{height:360px;border-radius:12px;border:1px solid #eee;background:#f4f4f4}
.sel-info{border:1px solid #eee;border-radius:10px;padding:8px;color:#333}
.toast{position:fixed;bottom:16px;left:16px;right:16px;display:none;z-index:1100}
.toast.show{display:block}
.toast-box{background:#111;color:#fff;border-radius:12px;padding:12px;text-align:center}
@media(max-width:900px){.co-wrap{padding:12px}}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
var IS_AUTH = {% if user.is_authenticated %}true{% else %}false{% endif %};
var toastEl = document.getElementById('toast');
var SEL = { city:'', area:'', street:'', display:'' };
function fIQD(v){var n=Math.round(Number(v)||0);return n.toLocaleString('en-US')+' Ø¯.Ø¹'}
function showToast(msg){ var box = toastEl.querySelector('.toast-box'); if(box){ box.textContent = msg; } toastEl.classList.add('show'); setTimeout(function(){ toastEl.classList.remove('show'); }, 2500); }
function getCsrf(){ var m = document.cookie.match(/csrftoken=([^;]+)/); return m ? m[1] : ''; }
function goStep(idx){ ['s1','s2','s3'].forEach(function(s,i){ var el = document.querySelector('.step.'+s); if(el){ el.classList.toggle('active', i===idx); } }); ['p1','p2','p3'].forEach(function(pid,i){ var p = document.getElementById(pid); if(p){ p.classList.toggle('active', i===idx); } }); }
document.getElementById('toStep2').addEventListener('click', function(){ if(IS_AUTH){ var sel = document.querySelector('input[name="address_id"]:checked'); if(!sel){ showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'); return; } } else { var nEl = document.getElementById('guest_name'); var n = nEl ? nEl.value.trim() : ''; var phEl = document.getElementById('guest_phone'); var ph = phEl ? phEl.value.trim() : ''; var c = document.getElementById('city').value.trim(); var a = document.getElementById('area').value.trim(); var s = document.getElementById('street').value.trim(); var nameErr = document.getElementById('guestNameError'); var phoneErr = document.getElementById('guestPhoneError'); if(!/^07\d{9}$/.test(ph)){ if(phoneErr){ phoneErr.textContent = 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¹Ø±Ø§Ù‚ÙŠ ØµØ§Ù„Ø­ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 07 ÙˆÙ…ÙƒÙˆÙ‘Ù† Ù…Ù† 11 Ø±Ù‚Ù…'; } showToast('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¹Ø±Ø§Ù‚ÙŠ ØµØ§Ù„Ø­ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 07 ÙˆÙ…ÙƒÙˆÙ‘Ù† Ù…Ù† 11 Ø±Ù‚Ù…'); if(phEl){ phEl.focus(); } return; } else { if(phoneErr){ phoneErr.textContent = ''; } } if(!n){ if(nameErr){ nameErr.textContent = 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…'; } showToast('Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„'); return; } else { if(nameErr){ nameErr.textContent = ''; } } if(!(c && a && s)){ showToast('Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„'); return; } } goStep(1); });
var nameEl = document.getElementById('guest_name');
var nameErrEl = document.getElementById('guestNameError');
if(nameEl && nameErrEl){ nameEl.addEventListener('input', function(){ var v = nameEl.value.trim(); nameErrEl.textContent = v ? '' : 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…'; }); }
var phoneEl = document.getElementById('guest_phone');
var phoneErrEl = document.getElementById('guestPhoneError');
if(phoneEl && phoneErrEl){ phoneEl.addEventListener('input', function(){ var v = phoneEl.value.trim(); phoneErrEl.textContent = /^07\d{9}$/.test(v) ? '' : 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¹Ø±Ø§Ù‚ÙŠ ØµØ§Ù„Ø­ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 07 ÙˆÙ…ÙƒÙˆÙ‘Ù† Ù…Ù† 11 Ø±Ù‚Ù…'; }); }
document.getElementById('backTo1').addEventListener('click', function(){ goStep(0); });
document.getElementById('toStep3').addEventListener('click', function(){ goStep(2); });
document.getElementById('backTo2').addEventListener('click', function(){ goStep(1); });

var mapModal = document.getElementById('mapModal');
var closeMap = document.getElementById('closeMap');
var cancelMap = document.getElementById('cancelMap');
var openMapBtn = document.getElementById('openMap');
var openMapGuestBtn = document.getElementById('openMapGuest');
function openMap(){ mapModal.classList.add('open'); initMap(); }
function hideMap(){ mapModal.classList.remove('open'); }
if(openMapBtn){ openMapBtn.addEventListener('click', openMap); }
if(openMapGuestBtn){ openMapGuestBtn.addEventListener('click', openMap); }
closeMap.addEventListener('click', hideMap); cancelMap.addEventListener('click', hideMap);

var map, marker;
function initMap(){ if(map) return; map = L.map('map', { attributionControl: false }).setView([33.3152,44.3661], 13); L.control.attribution({ prefix: false }).addTo(map); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19, attribution: 'Â© OpenStreetMap contributors'}).addTo(map); map.on('click', function(e){ setMarker(e.latlng.lat, e.latlng.lng); reverseGeocode(e.latlng.lat, e.latlng.lng); }); addLocateControl(); }
function setMarker(lat,lng){ if(!marker){ marker = L.marker([lat,lng], {draggable:true}).addTo(map); marker.on('dragend', function(){ var ll = marker.getLatLng(); updateLatLng(ll.lat, ll.lng); reverseGeocode(ll.lat, ll.lng); }); } marker.setLatLng([lat,lng]); updateLatLng(lat,lng); }
function updateLatLng(lat,lng){ document.getElementById('latitude').value = lat; document.getElementById('longitude').value = lng; }

function updatePreview(){ var el = document.getElementById('selectedInfo'); if(!el) return; var txt = SEL.display || ((document.getElementById('latitude').value && document.getElementById('longitude').value) ? ('(' + parseFloat(document.getElementById('latitude').value).toFixed(5) + ', ' + parseFloat(document.getElementById('longitude').value).toFixed(5) + ')') : ''); el.textContent = txt; el.style.display = txt ? 'block' : 'none'; }
function reverseGeocode(lat,lng){ fetch('https://nominatim.openstreetmap.org/reverse?format=jsonv2&accept-language=ar&lat='+encodeURIComponent(lat)+'&lon='+encodeURIComponent(lng)).then(function(r){ return r.json(); }).then(function(data){ var addr = data.address || {}; var city = addr.city || addr.town || addr.village || addr.state || ''; var area = addr.suburb || addr.neighbourhood || addr.quarter || addr.district || addr.county || ''; var road = addr.road || ''; var house = addr.house_number || ''; var street = (road + (house?(' '+house):'')); document.getElementById('formatted_address').value = data.display_name || ''; document.getElementById('provider').value = 'nominatim'; document.getElementById('provider_place_id').value = data.place_id || ''; SEL.city = city; SEL.area = area; SEL.street = street; SEL.display = data.display_name || ''; var cEl = document.getElementById('city'); var aEl = document.getElementById('area'); var sEl = document.getElementById('street'); if(cEl) cEl.value = city; if(aEl) aEl.value = area; if(sEl) sEl.value = street; updatePreview(); }); }

var searchInput = document.getElementById('searchInput');
var searchBtn = document.getElementById('searchBtn');
function doSearch(){ var q = (searchInput.value||'').trim(); if(!q) return; fetch('https://nominatim.openstreetmap.org/search?format=jsonv2&accept-language=ar&q='+encodeURIComponent(q)).then(function(r){ return r.json(); }).then(function(items){ var list = document.getElementById('list'); list.innerHTML=''; items.slice(0,10).forEach(function(it){ var d = document.createElement('div'); d.className='res'; d.textContent = it.display_name; d.addEventListener('click', function(){ setMarker(parseFloat(it.lat), parseFloat(it.lon)); fillFromPlace(it); }); list.appendChild(d); }); }); }
searchBtn.addEventListener('click', doSearch);
function addLocateControl(){ var C = L.Control.extend({ options: { position: 'topright' }, onAdd: function(m){ var wrap = L.DomUtil.create('div','leaflet-bar locate-control'); var btn = L.DomUtil.create('button','locate-btn', wrap); btn.type='button'; btn.title='Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹ÙŠ'; btn.textContent='ğŸ“'; L.DomEvent.on(btn,'click', function(){ if(!navigator.geolocation){ showToast('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS'); return; } btn.disabled=true; var old = btn.textContent; btn.textContent='â³'; navigator.geolocation.getCurrentPosition(function(pos){ btn.disabled=false; btn.textContent=old; var lat=pos.coords.latitude, lng=pos.coords.longitude; setMarker(lat,lng); map.setView([lat,lng],16); reverseGeocode(lat,lng); showToast('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ'); }, function(){ btn.disabled=false; btn.textContent=old; showToast('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'); }, { enableHighAccuracy:true, timeout:8000 }); }); return wrap; } }); map.addControl(new C()); }

function fillFromPlace(place){ var addr = place.address || {}; var city = addr.city || addr.town || addr.village || addr.state || ''; var area = addr.suburb || addr.neighbourhood || addr.quarter || addr.district || addr.county || ''; var road = addr.road || ''; var house = addr.house_number || ''; var street = (road + (house?(' '+house):'')); document.getElementById('formatted_address').value = place.display_name || ''; document.getElementById('provider').value = 'nominatim'; document.getElementById('provider_place_id').value = place.place_id || ''; SEL.city = city; SEL.area = area; SEL.street = street; SEL.display = place.display_name || ''; var cEl = document.getElementById('city'); var aEl = document.getElementById('area'); var sEl = document.getElementById('street'); if(cEl) cEl.value = city; if(aEl) aEl.value = area; if(sEl) sEl.value = street; updatePreview(); }

document.getElementById('confirmLocation').addEventListener('click', function(){ var lat = document.getElementById('latitude').value; var lng = document.getElementById('longitude').value; var fa = document.getElementById('formatted_address').value || SEL.display || ''; var cEl = document.getElementById('city'); var aEl = document.getElementById('area'); var sEl = document.getElementById('street'); var city = cEl ? (cEl.value || SEL.city) : SEL.city; var area = aEl ? (aEl.value || SEL.area) : SEL.area; var street = sEl ? (sEl.value || SEL.street) : SEL.street; if(!(lat && lng)){ showToast('Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©'); return; } if(IS_AUTH){ var payload = { data: { lat: lat, lng: lng, formatted_address: fa, city: city, area: area, street: street, provider: 'nominatim', place_id: document.getElementById('provider_place_id').value||'' }, next: '{% url 'checkout' %}' }; fetch('{% url 'address_save_json' %}', { method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRFToken': getCsrf() }, body: JSON.stringify(payload) }).then(function(r){ return r.json(); }).then(function(res){ if(res && res.success){ var id = res.id; var list = document.getElementById('addrList'); var wrap = document.createElement('label'); wrap.className='addr-item'; wrap.innerHTML = '<input type="radio" name="address_id" value="'+id+'" checked><div class="addr-body"><div class="addr-title">'+(city||'')+' - '+(area||'')+'</div><div class="addr-street">'+(street||'')+'</div><div class="addr-sub">'+(fa||'')+'</div></div>'; list.insertBefore(wrap, list.firstChild); hideMap(); showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'); } else { showToast('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'); } }); } else { hideMap(); showToast('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'); } });

var confirmBtn = document.getElementById('confirmOrder');
var coForm = document.getElementById('coForm');
if(coForm && confirmBtn){
  coForm.addEventListener('submit', function(){
    confirmBtn.disabled = true;
    var lbl = confirmBtn.querySelector('.btn-label');
    if(lbl){ lbl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ£ÙƒÙŠØ¯...'; }
  });
}

// Update final total (with discount if any) in summary and button
document.addEventListener('DOMContentLoaded', function(){
  var sb = document.getElementById('sumBox');
  if(!sb) return;
  var grand = parseFloat(sb.dataset.grand||'0');
  var discount = parseFloat(sb.dataset.discount||'0');
  var final = grand - (isNaN(discount)?0:discount);
  var el = document.querySelector('.sumFinal'); if(el) el.textContent = fIQD(final);
  var discEl = document.querySelector('.sumDiscount'); if(discEl && !isNaN(discount) && discount>0){ discEl.textContent = 'âˆ’ ' + fIQD(discount); }
  var label = sb.dataset.discountLabel || ''; var code = sb.dataset.discountCode || '';
  if((!isNaN(discount) && discount>0) || label || code){
    var promo = document.createElement('div'); promo.className='promo';
    var html = '';
    if(label){ html += '<div class="row"><span>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®ØµÙ…</span><span class="pill">'+label+'</span></div>'; }
    if(code){ html += '<div class="row small"><span>ÙƒÙˆØ¯</span><span class="pill">'+code+'</span></div>'; }
    html += '<div class="row"><span>Ø§Ù„Ù…ÙˆÙÙ‘Ø±</span><span class="sumDiscount">'+(discount>0?('âˆ’ '+fIQD(discount)):'0')+'</span></div>';
    promo.innerHTML = html;
    var sumBox = document.getElementById('sumBox'); if(sumBox){ sumBox.appendChild(promo); }
  }
  // Update summary in step 2
  var sb2 = document.getElementById('sumBox2');
  if(sb2){
    var g2 = parseFloat(sb2.dataset.grand||'0');
    var d2 = parseFloat(sb2.dataset.discount||'0');
    var f2 = g2 - (isNaN(d2)?0:d2);
    var el2 = document.querySelector('.sumFinal2'); if(el2) el2.textContent = fIQD(f2);
    var dEl2 = document.querySelector('.sumDiscount2'); if(dEl2 && !isNaN(d2) && d2>0){ dEl2.textContent = 'âˆ’ ' + fIQD(d2); }
  }
  // Coupon handlers
  var applyBtn = document.getElementById('applyCoupon');
  var removeBtn = document.getElementById('removeCoupon');
  var noteEl = document.getElementById('couponNote');
  var codeEl = document.getElementById('couponCode');
  function setDiscountUI(d,label,code){
    sb.dataset.discount = String(d||0);
    sb.dataset.discountLabel = label||'';
    sb.dataset.discountCode = code||'';
    var cart = parseFloat(sb.dataset.cart||'0');
    var delv = parseFloat(sb.dataset.delivery||'0');
    var final = Math.max(0, (cart+delv) - (parseFloat(sb.dataset.discount)||0));
    var sEl = document.querySelector('.sumFinal'); if(sEl) sEl.textContent = fIQD(final);
    var dEl = document.querySelector('.sumDiscount'); if(dEl){ dEl.textContent = 'âˆ’ ' + fIQD(parseFloat(sb.dataset.discount)||0); } else if((parseFloat(sb.dataset.discount)||0)>0){
      var row = document.createElement('div'); row.className='row'; row.innerHTML = '<span>Ø§Ù„Ø®ØµÙ…</span><span class="sumDiscount">âˆ’ '+fIQD(parseFloat(sb.dataset.discount)||0)+'</span>'; var sumBox = document.getElementById('sumBox'); sumBox.insertBefore(row, sumBox.querySelector('.row.total'));
    }
    if(label || code){ noteEl.textContent = 'ØªÙ… ØªØ·Ø¨ÙŠÙ‚: '+(label||'')+(code?(' ('+code+')'):''); removeBtn.style.display='inline-block'; } else { noteEl.textContent=''; removeBtn.style.display='none'; }
  }
  if(discount>0 || label || code){ setDiscountUI(discount,label,code); }
  function applyCoupon(){ var c = (codeEl.value||'').trim(); if(!c){ showToast('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†'); return; } fetch('{% url 'apply_coupon_json' %}', { method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRFToken': getCsrf() }, body: JSON.stringify({ code: c }) }).then(function(r){ return r.json(); }).then(function(res){ if(res && res.success){ setDiscountUI(res.discount, res.label, res.code); showToast('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†'); } else { showToast('ÙƒÙˆØ¨ÙˆÙ† ØºÙŠØ± ØµØ§Ù„Ø­'); } }).catch(function(){ showToast('ØªØ¹Ø°Ø± ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†'); }); }
  function removeCoupon(){ setDiscountUI(0,'',''); codeEl.value=''; fetch('{% url 'apply_coupon_json' %}', { method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRFToken': getCsrf() }, body: JSON.stringify({ code: 'REMOVE' }) }).finally(function(){ showToast('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†'); }); }
  if(applyBtn){ applyBtn.addEventListener('click', applyCoupon); }
  if(removeBtn){ removeBtn.addEventListener('click', removeCoupon); }
  document.querySelectorAll('.opt-item.disabled').forEach(function(el){ el.addEventListener('click', function(e){ e.preventDefault(); showToast((el.dataset.soon||'Ø§Ù„Ø®ÙŠØ§Ø±')+' Ù‚Ø±ÙŠØ¨Ø§Ù‹'); }); });
});
</script>
{% endblock %}

