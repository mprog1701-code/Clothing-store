{% extends 'base.html' %}
{% load math_filters %}

{% block title %}{{ product.name }}{% endblock %}

{% block content %}
<style>
  .pdWrap{display:flex;flex-direction:row;gap:16px;background:#ffffff;padding:16px}
  @media (max-width:768px){.pdWrap{flex-direction:column}}
  .pdMedia{flex:1;background:#ffffff}
  .pdInfo{flex:1;background:#ffffff}
  #pdMain{width:100%;height:auto;background:#ffffff}
  #pdThumbs{display:flex;gap:8px;flex-wrap:wrap;background:#ffffff;margin-top:8px}
  .thumb{width:72px;height:72px;border:1px solid #e5e7eb;background:#ffffff;transition:all .2s ease}
  .thumb.selected{border:2px solid #ff6a00 !important}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .title{font-size:22px;font-weight:700;margin-bottom:8px}
  .price{display:flex;gap:12px;align-items:baseline;margin:8px 0}
  .price-new{font-size:20px;font-weight:800}
  .price-old{font-size:14px;color:#888;text-decoration:line-through}
  .fit{border:1px solid #e5e7eb;background:#ffffff;border-radius:8px;padding:10px;margin:8px 0;font-size:14px}
  .swatches{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
  .swatch{width:35px;height:35px;border:2px solid #eee;border-radius:6px;cursor:pointer;transition:transform .15s ease, border-color .15s ease}
  .swatch.selected{border:2px solid #000;transform:scale(1.05)}
  .sizes{display:flex;gap:8px;flex-wrap:wrap;background:#ffffff;margin-top:8px}
  .sz{min-width:52px;padding:10px 12px;border:2px solid #000;border-radius:10px;background:#ffffff;font-weight:700}
  .sz.selected{background:#000;color:#fff}
  .sz:disabled{opacity:.5;cursor:not-allowed}
  .btn{padding:12px 18px;border:none;border-radius:10px;background:#ff6a00;color:#fff;font-weight:700;width:100%}
  .btn:disabled{background:#ff6a00;opacity:.6;cursor:not-allowed}
  .pdWrap, .pdMedia, .pdInfo, .title, .fit, .price-new, .sz, .btn{color:#1a1a1a}
  #addBtn:hover{filter:brightness(0.95)}
  #negPrice{background:#f3f4f6;border:1px solid #ddd;border-radius:10px;padding:10px;width:180px}
  .hint{font-size:13px;color:#666;margin-top:8px}
  .thumb{cursor:pointer}
  .related-wrap{margin:24px 16px;background:#ffffff}
  .related-wrap, .related-wrap *{color:#000000 !important;background-color:#ffffff !important}
  .relTitle{font-size:18px;font-weight:800;color:#1a1a1a;margin-bottom:8px}
  .relList{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;width:100%}
  .relCard{display:block;border:1px solid #e5e7eb;border-radius:10px;background:#ffffff;text-decoration:none;color:#000000 !important}
  .relImg{width:100%;height:160px;background:#ffffff;border-bottom:1px solid #e5e7eb}
  .relImg img{width:100%;height:100%;object-fit:cover}
  .relBody{padding:10px;background:#ffffff}
  .relStore{font-size:12px;color:#000000 !important}
  .relName{font-size:13px;color:#000000 !important;margin:4px 0;height:34px;overflow:hidden}
  .relPrice{font-size:14px;font-weight:800;color:#000000 !important}
  .negRow{display:flex;align-items:center;gap:12px;margin:12px 0;background:#f3f4f6;padding:10px;border-radius:10px}
</style>

<div class="pdWrap">
  <div class="pdMedia">
    {% if primary_video_url %}
    <video id="pdVideo" src="{{ primary_video_url }}" controls playsinline style="width:100%;height:auto;background:#ffffff"></video>
    {% endif %}
    <img id="pdMain" src="{{ default_main_image_url }}" alt="{{ product.name }}" onerror="this.onerror=null;this.src='{{ placeholder_image_url }}'">
    <div id="pdThumbs"></div>
  </div>

  <div class="pdInfo">
    <div class="title">{{ product.name }}</div>
    <div class="price">
      {% if product.discount_price %}
        <span class="price-old">{{ product.base_price|iqd }}</span>
        <span class="price-new">{{ product.discount_price|iqd }}</span>
      {% else %}
        <span class="price-new">{{ product.base_price|iqd }}</span>
      {% endif %}
    </div>

    {% if fit_advice %}
    <div class="fit">{{ fit_advice }}</div>
    {% endif %}

    <form method="post" action="{% url 'cart_items_json' %}">
      {% csrf_token %}
      <input type="hidden" name="productId" value="{{ product.id }}">
      <input type="hidden" name="storeId" value="{{ product.store.id }}">
      <input type="hidden" name="variantId" id="variantId">
      <input type="hidden" name="quantity" id="qty" value="1">

      <div class="swatches" id="swatches"></div>
      <div class="sizes" id="sizes"></div>

      <div class="negRow">
        <input type="number" step="0.01" min="0" id="negPrice" name="negotiatedPrice" placeholder="Negotiated Price">
        <div id="storeRating">‚≠ê {{ product.rating|default:"0.0" }}</div>
      </div>

      <div style="margin-top:16px"><button class="btn" id="addBtn" disabled>Add to Cart</button></div>
      <div id="inlineMsg" class="hint">Please select a color and size</div>
    </form>
  </div>
</div>

<script type="application/json" id="variant-data">{{ variant_data|safe }}</script>
<script type="application/json" id="images-data">{{ images_by_color|safe }}</script>
<script type="application/json" id="colors-data">{{ available_colors|safe }}</script>
<script>
  const VARIANTS = JSON.parse(document.getElementById('variant-data').textContent || '[]');
  const IMAGES_BY_COLOR = JSON.parse(document.getElementById('images-data').textContent || '{}');
  const AVAILABLE_COLORS = JSON.parse(document.getElementById('colors-data').textContent || '[]');
  const sizesEl = document.getElementById('sizes');
  const swatchesEl = document.getElementById('swatches');
  const addBtn = document.getElementById('addBtn');
  const hiddenVar = document.getElementById('variantId');
  const pdMain = document.getElementById('pdMain');
  const pdThumbs = document.getElementById('pdThumbs');
  const DEFAULT_IMAGE = '{{ default_main_image_url }}';
  const inlineMsg = document.getElementById('inlineMsg');
  let selectedColorId = null;
  let selectedSizeVal = null;

  function getAllImages(){
    const acc = [];
    try { Object.keys(IMAGES_BY_COLOR || {}).forEach(k => { const arr = IMAGES_BY_COLOR[k]; if (Array.isArray(arr)) arr.forEach(u => { if (u) acc.push(u); }); }); } catch(e){}
    if (acc.length === 0 && Array.isArray(IMAGES_BY_COLOR['__default__'])) { IMAGES_BY_COLOR['__default__'].forEach(u => { if (u) acc.push(u); }); }
    return acc;
  }
  function getImagesForColorId(colorId){
    const key = String(colorId);
    const arr = (IMAGES_BY_COLOR && IMAGES_BY_COLOR[key]) || [];
    return Array.isArray(arr) ? arr : [];
  }
  function renderThumbs(urls){
    const list = (Array.isArray(urls) ? urls : []).slice(0, 24);
    pdThumbs.innerHTML = '';
    const first = list[0] || DEFAULT_IMAGE;
    if (pdMain && first) pdMain.src = first;
    list.forEach(function(u,i){
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'thumb' + (i === 0 ? ' selected' : '');
      btn.setAttribute('data-src', u);
      const img = document.createElement('img');
      img.src = u;
      img.alt = '{{ product.name }}';
      img.onerror = function(){ this.onerror=null; this.src='{{ placeholder_image_url }}'; };
      btn.appendChild(img);
      pdThumbs.appendChild(btn);
    });
  }
  function renderSwatches(clear){
    var shouldClear = (typeof clear === 'boolean') ? clear : true;
    if (shouldClear) {
      swatchesEl.innerHTML = '';
      (AVAILABLE_COLORS || []).forEach(function(c){
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'swatch' + (String(selectedColorId) === String(c.id) ? ' selected' : '');
        b.setAttribute('data-color', String(c.id));
        const hex = (c.hex || '').trim();
        if (hex) b.style.backgroundColor = hex;
        b.addEventListener('click', function(){ onColorSelect(String(c.id)); });
        swatchesEl.appendChild(b);
      });
    } else {
      if (swatchesEl.childElementCount === 0) {
        (AVAILABLE_COLORS || []).forEach(function(c){
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'swatch' + (String(selectedColorId) === String(c.id) ? ' selected' : '');
          b.setAttribute('data-color', String(c.id));
          const hex = (c.hex || '').trim();
          if (hex) b.style.backgroundColor = hex;
          b.addEventListener('click', function(){ onColorSelect(String(c.id)); });
          swatchesEl.appendChild(b);
        });
      } else {
        Array.from(swatchesEl.children).forEach(function(b){
          const id = b.getAttribute('data-color');
          if (String(id) === String(selectedColorId)) { b.classList.add('selected'); } else { b.classList.remove('selected'); }
        });
      }
    }
  }
  function renderSizesForColor(colorId){
    sizesEl.innerHTML = '';
    const sizes = Array.from(new Set(VARIANTS.filter(v => String(v.color_id || '') === String(colorId)).map(v => v.size)));
    sizes.forEach(function(s){
      const v = VARIANTS.find(x => String(x.color_id || '') === String(colorId) && String(x.size || '') === String(s || ''));
      const out = !v || (v.stock_qty || 0) <= 0;
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'sz' + (out ? '' : '');
      b.disabled = !!out;
      b.textContent = s;
      b.setAttribute('data-size', s);
      b.addEventListener('click', function(){ selectSize(s); });
      sizesEl.appendChild(b);
    });
  }
  function renderSizesAll(){
    if (sizesEl.childElementCount > 0) return;
    const sizes = Array.from(new Set(VARIANTS.map(v => v.size)));
    sizes.forEach(function(s){
      if (sizesEl.querySelector('[data-size="' + String(s) + '"]')) return;
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'sz';
      b.textContent = s;
      b.setAttribute('data-size', s);
      b.addEventListener('click', function(){ selectSize(s); });
      sizesEl.appendChild(b);
    });
  }
  function selectSize(size){
    selectedSizeVal = String(size);
    Array.from(sizesEl.querySelectorAll('.sz')).forEach(c => c.classList.remove('selected'));
    const btn = Array.from(sizesEl.querySelectorAll('.sz')).find(c => c.getAttribute('data-size') === String(size));
    if (btn) btn.classList.add('selected');
    const v = VARIANTS.find(x => String(x.color_id || '') === String(selectedColorId || '') && String(x.size || '') === String(size || ''));
    hiddenVar.value = v && v.id ? String(v.id) : '';
    addBtn.disabled = !(v && (v.stock_qty || 0) > 0);
    if (inlineMsg) inlineMsg.style.display = addBtn.disabled ? 'block' : 'none';
  }
  function onColorSelect(colorId){
    selectedColorId = String(colorId);
    renderSwatches(true);
    renderThumbs(getImagesForColorId(selectedColorId));
    renderSizesForColor(selectedColorId);
    if (selectedSizeVal){ selectSize(selectedSizeVal); } else { hiddenVar.value = ''; addBtn.disabled = true; if (inlineMsg) inlineMsg.style.display='block'; }
  }

  document.addEventListener('DOMContentLoaded', function(){
    renderSwatches(false);
    renderThumbs(getAllImages());
    renderSizesAll();
    if (Array.isArray(VARIANTS) && VARIANTS.length > 0) { addBtn.disabled = true; if (inlineMsg) inlineMsg.style.display='block'; }
    pdThumbs.addEventListener('click', function(e){
      const b = e.target.closest('.thumb');
      if (!b) return;
      const src = b.getAttribute('data-src');
      if (src && pdMain) pdMain.src = src;
      Array.from(pdThumbs.querySelectorAll('.thumb')).forEach(t => t.classList.remove('selected'));
      b.classList.add('selected');
    });
    const form = addBtn.closest('form');
    form.addEventListener('submit', function(e){ if (Array.isArray(VARIANTS) && VARIANTS.length > 0 && !hiddenVar.value){ e.preventDefault(); inlineMsg.style.display='block'; } });
  });
</script>
{% endblock %}