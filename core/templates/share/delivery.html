{% extends 'base.html' %}
{% load math_filters %}
{% block content %}
<div class="container py-4" dir="rtl">
  {% if not order %}
  <div class="alert alert-danger">الرابط غير صالح أو منتهي الصلاحية</div>
  {% else %}
  <div class="row g-3">
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header bg-light">العميل</div>
        <div class="card-body">
          <p class="mb-2"><strong>الاسم:</strong> {{ order.user.get_full_name|default:order.user.username }}</p>
          <p class="mb-2"><strong>الهاتف:</strong> <a href="tel:{{ order.user.phone }}">{{ order.user.phone }}</a></p>
          <div class="d-flex flex-wrap gap-2">
            {% if cust_wa_url %}<a class="btn btn-success btn-sm" target="_blank" href="{{ cust_wa_url }}">واتساب</a>{% endif %}
            {% if maps_cust %}<a class="btn btn-outline-success btn-sm" target="_blank" href="{{ maps_cust }}">خرائط</a>{% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header bg-light">المتجر</div>
        <div class="card-body">
          <p class="mb-2"><strong>الاسم:</strong> {{ order.store.name }}</p>
          <p class="mb-2"><strong>الهاتف:</strong> {% if order.store.owner_phone %}<a href="tel:{{ order.store.owner_phone }}">{{ order.store.owner_phone }}</a>{% elif order.store_phone %}<a href="tel:{{ order.store_phone }}">{{ order.store_phone }}</a>{% else %}—{% endif %}</p>
          <div class="d-flex flex-wrap gap-2">
            {% if store_wa_url %}<a class="btn btn-success btn-sm" target="_blank" href="{{ store_wa_url }}">واتساب</a>{% endif %}
            {% if maps_store %}<a class="btn btn-outline-success btn-sm" target="_blank" href="{{ maps_store }}">خرائط</a>{% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light">الطلب</div>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <strong>رقم الطلب:</strong> #{{ order.id }}
            </div>
            <div>
              <span class="badge {% if order.status == 'pending' %}bg-warning text-dark{% elif order.status == 'accepted' %}bg-info{% elif order.status == 'packed' %}bg-primary{% elif order.status == 'preparing' or order.status == 'on_the_way' %}bg-secondary{% elif order.status == 'delivered' %}bg-success{% elif order.status == 'canceled' %}bg-danger{% endif %}">{{ order.get_status_display }}</span>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>المنتج</th>
                  <th>اللون</th>
                  <th>المقاس</th>
                  <th>الكمية</th>
                  <th>السعر</th>
                </tr>
              </thead>
              <tbody>
                {% for it in order.items.all %}
                <tr>
                  <td>{{ it.product.name }}</td>
                  <td>{% if it.variant %}{{ it.variant.color }}{% endif %}</td>
                  <td>{% if it.variant %}{{ it.variant.size }}{% endif %}</td>
                  <td>{{ it.quantity }}</td>
                  <td>{{ it.price|floatformat:0 }} د.ع</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between pt-2 border-top">
            <span class="fw-bold">الإجمالي:</span>
            <span class="fw-bold">{{ order.total_amount|floatformat:0 }} د.ع</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light">الحالة</div>
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label class="form-label">الحالة</label>
              <select id="status_sel" class="form-select">
                <option value="on_the_way">في الطريق</option>
                <option value="delivered">تم التسليم</option>
                <option value="canceled">ملغي</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">رقم التتبع (اختياري)</label>
              <input type="text" id="tracking_inp" class="form-control" value="{{ order.tracking_number }}">
            </div>
            <div class="col-md-4 d-grid">
              <button id="update_btn" class="btn btn-primary">تحديث</button>
            </div>
          </div>
          <div id="msg" class="mt-3"></div>
          <div class="mt-3">
            {% if company_wa_url %}<a class="btn btn-success" target="_blank" href="{{ company_wa_url }}">إرسال للناقِل عبر واتساب</a>{% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    var token = '{{ token }}';
    var msg = document.getElementById('msg');
    function show(t, ok){ msg.textContent = t; msg.className = ok ? 'text-success' : 'text-danger'; }
    document.getElementById('update_btn').addEventListener('click', function(){
      var st = document.getElementById('status_sel').value;
      var tr = document.getElementById('tracking_inp').value.trim();
      var body = 'token=' + encodeURIComponent(token) + '&status=' + encodeURIComponent(st) + '&tracking_number=' + encodeURIComponent(tr);
      fetch('{% url "share_status_update_json" %}', {
        method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: body
      }).then(function(r){ if(!r.ok) throw r; return r.json(); }).then(function(j){
        if(j.ok){ show('تم التحديث: ' + (j.label||j.status), true); location.reload(); } else { show('فشل التحديث', false); }
      }).catch(function(){ show('خطأ بالخادم', false); });
    });
  })();
  </script>
  {% endif %}
</div>
{% endblock %}
